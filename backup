import sys
import os

# ========= åœ¨å¯¼å…¥ pdfplumber ä¹‹å‰ï¼Œä¼˜å…ˆè§£å†³ pypdfium2 / pdfium.dll è·¯å¾„é—®é¢˜ =========
# å…¼å®¹å¤šç§æ‰“åŒ…æ–¹å¼ï¼ˆPyInstaller onefile / onedirï¼‰ä»¥åŠä¸åŒç‰ˆæœ¬çš„ pypdfium2

def _ensure_pdfium_dll():
    """
    å°è¯•åœ¨æ‰“åŒ…åçš„ç›®å½•æˆ–ä¸´æ—¶è§£å‹ç›®å½•ä¸­å¯»æ‰¾ pdfium.dllï¼Œ
    æ‰¾åˆ°åé€šè¿‡ PATH / add_dll_directory / ç¯å¢ƒå˜é‡ å‘Šè¯‰ pypdfium2 ä½¿ç”¨è¯¥è·¯å¾„ã€‚
    """
    # 1. åŸºç¡€ç›®å½•ï¼šå¼€å‘ç¯å¢ƒç”¨æºç ç›®å½•ï¼Œæ‰“åŒ…ç¯å¢ƒç”¨ _MEIPASS
    if getattr(sys, "frozen", False):
        base_path = getattr(sys, "_MEIPASS", os.path.dirname(os.path.abspath(sys.argv[0])))
    else:
        base_path = os.path.dirname(os.path.abspath(__file__))

    # 2. exe æ‰€åœ¨ç›®å½•ï¼ˆPyInstaller onedir æ—¶èµ„æºé€šå¸¸åœ¨è¿™é‡Œï¼‰
    exe_dir = os.path.dirname(os.path.abspath(sys.argv[0]))

    candidate_dirs = [
        # è€ç‰ˆæœ¬ pypdfium2_raw ç›®å½•
        os.path.join(base_path, "pypdfium2_raw"),
        os.path.join(base_path, "_internal", "pypdfium2_raw"),
        os.path.join(exe_dir, "pypdfium2_raw"),
        os.path.join(exe_dir, "_internal", "pypdfium2_raw"),
        # æ–°ç‰ˆæœ¬ pypdfium2 ç›®å½•ï¼ˆå¸¸è§ç»“æ„ï¼‰
        os.path.join(base_path, "pypdfium2"),
        os.path.join(base_path, "_internal", "pypdfium2"),
        os.path.join(exe_dir, "pypdfium2"),
        os.path.join(exe_dir, "_internal", "pypdfium2"),
    ]

    pdfium_dir = None

    # å…ˆåœ¨å¸¸è§ç›®å½•é‡Œç›´æ¥æ‰¾
    for d in candidate_dirs:
        dll_path = os.path.join(d, "pdfium.dll")
        if os.path.exists(dll_path):
            pdfium_dir = d
            break

    # å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œå†åœ¨ base_path / exe_dir é‡Œé€’å½’æœç´¢ä¸€æ¬¡ï¼ˆé˜²æ­¢ç›®å½•åæœ‰ç‰ˆæœ¬å·ä¹‹ç±»ï¼‰
    if pdfium_dir is None:
        for root in [base_path, exe_dir]:
            if not os.path.isdir(root):
                continue
            for cur_root, _dirs, files in os.walk(root):
                if "pdfium.dll" in files:
                    pdfium_dir = cur_root
                    break
            if pdfium_dir is not None:
                break

    if not pdfium_dir:
        # æ‰¾ä¸åˆ°å°±ç›´æ¥è¿”å›ï¼Œè®©åç»­é€»è¾‘èµ° pdfplumber é»˜è®¤åç«¯ï¼ˆå¯èƒ½é€€å›åˆ°çº¯æ–‡æœ¬è§£æï¼‰
        return

    pdfium_dll_path = os.path.join(pdfium_dir, "pdfium.dll")
    if not os.path.exists(pdfium_dll_path):
        return

    # 3. å‘Šè¯‰ç³»ç»Ÿ / pypdfium2 ä½¿ç”¨è¯¥ dll
    current_path = os.environ.get("PATH", "")
    if pdfium_dir not in current_path:
        os.environ["PATH"] = pdfium_dir + os.pathsep + current_path

    if hasattr(os, "add_dll_directory"):
        try:
            os.add_dll_directory(pdfium_dir)
        except Exception:
            # æŸäº›ç¯å¢ƒä¸æ”¯æŒï¼Œå¿½ç•¥å³å¯
            pass

    # pypdfium2 å®˜æ–¹æ”¯æŒçš„ç¯å¢ƒå˜é‡
    os.environ["PYPDFIUM2_LIB_PATH"] = pdfium_dll_path
    os.environ["PYPDFIUM2_RAW_PATH"] = pdfium_dir

    # å…¼å®¹æ—§ç‰ˆ pypdfium2_raw ç›´æ¥åœ¨ sys.path ä¸­æŸ¥æ‰¾çš„æƒ…å†µ
    if pdfium_dir not in sys.path:
        sys.path.insert(0, pdfium_dir)


_ensure_pdfium_dll()

import re
import io
import json
import pandas as pd
from datetime import datetime
import requests
import time
import warnings
from requests.adapters import HTTPAdapter
from requests.packages.urllib3.util.retry import Retry

# ç¦ç”¨ä¸å®‰å…¨è¯·æ±‚çš„è­¦å‘Š
warnings.filterwarnings('ignore', message='Unverified HTTPS request')

from PyQt5.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                             QPushButton, QListWidget, QListWidgetItem, QTableWidget, QTableWidgetItem,
                             QLabel, QFileDialog, QProgressBar, QTextEdit, QSplitter,
                             QGroupBox, QComboBox, QLineEdit, QMessageBox, QStatusBar,
                             QInputDialog, QDialog, QScrollArea, QStackedWidget,
                             QCheckBox, QDoubleSpinBox, QTabWidget)
from PyQt5.QtCore import Qt, QThread, pyqtSignal, QCoreApplication
from PyQt5.QtGui import QPixmap, QColor, QBrush
import pdfplumber
import pytesseract
from PIL import Image
import cv2
import numpy as np
import shutil
import matplotlib
matplotlib.use('Qt5Agg')  # ä½¿ç”¨Qt5åç«¯
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
from matplotlib.figure import Figure
import matplotlib.pyplot as plt
from matplotlib import font_manager

# é…ç½®matplotlibä¸­æ–‡å­—ä½“
# å°è¯•æ‰¾åˆ°å¯ç”¨çš„ä¸­æ–‡å­—ä½“
chinese_fonts = ['Microsoft YaHei', 'SimHei', 'SimSun', 'KaiTi', 'FangSong', 
                 'Arial Unicode MS', 'WenQuanYi Micro Hei', 'DejaVu Sans']
available_fonts = [f.name for f in font_manager.fontManager.ttflist]
chinese_font = None
for font in chinese_fonts:
    if font in available_fonts:
        chinese_font = font
        break

if chinese_font:
    plt.rcParams['font.sans-serif'] = [chinese_font] + plt.rcParams['font.sans-serif']
else:
    # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸­æ–‡å­—ä½“ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®
    plt.rcParams['font.sans-serif'] = ['Microsoft YaHei', 'SimHei', 'Arial Unicode MS', 'DejaVu Sans']

plt.rcParams['axes.unicode_minus'] = False  # è§£å†³è´Ÿå·æ˜¾ç¤ºé—®é¢˜

# é…ç½®æ–‡ä»¶è·¯å¾„
CONFIG_FILE = os.path.join(os.path.dirname(os.path.abspath(sys.argv[0])), 'config.json')

def load_config():
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    if os.path.exists(CONFIG_FILE):
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            print(f"è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
    return {}

def save_config(config):
    """ä¿å­˜é…ç½®æ–‡ä»¶"""
    try:
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=2)
        return True
    except Exception as e:
        print(f"ä¿å­˜é…ç½®æ–‡ä»¶å¤±è´¥: {e}")
        return False


def ocr_image_to_string(image):
    """æ ¹æ®é…ç½®ä¸­è®¾ç½®çš„è¯­è¨€æ‰§è¡Œ OCR"""
    cfg = load_config()
    lang = cfg.get('ocr_lang', '') or None
    if lang:
        return pytesseract.image_to_string(image, lang=lang)
    return pytesseract.image_to_string(image)

def detect_tesseract_path():
    """
    è‡ªåŠ¨æ£€æµ‹ tesseract å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼š
    1. é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    2. ç¯å¢ƒå˜é‡ TESSERACT_PATH
    3. ç¨‹åºç›®å½•ä¸‹ Tesseract-OCR\\tesseract.exeï¼ˆé€‚åˆéšç¨‹åºä¸€èµ·æ‰“åŒ…ï¼‰
    4. å¸¸è§å®‰è£…è·¯å¾„ï¼ˆProgram Files ç­‰ï¼‰
    5. ç³»ç»Ÿ PATH ä¸­æ˜¯å¦å­˜åœ¨ tesseract
    æ‰¾ä¸åˆ°åˆ™è¿”å› None
    """
    # 1. é…ç½®æ–‡ä»¶ä¸­çš„è·¯å¾„ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    config = load_config()
    config_path = config.get('tesseract_path', '')
    if config_path and os.path.isfile(config_path):
        return config_path
    
    # 2. ç¯å¢ƒå˜é‡
    env_path = os.environ.get("TESSERACT_PATH")
    if env_path and os.path.isfile(env_path):
        return env_path

    # 2. ç¨‹åºç›®å½•å†…çš„ç›¸å¯¹è·¯å¾„ï¼ˆå…¼å®¹ PyInstaller æ‰“åŒ…åçš„ _MEIPASSï¼‰
    base_dir = getattr(sys, "_MEIPASS", os.path.dirname(os.path.abspath(sys.argv[0])))
    candidates = [
        os.path.join(base_dir, "Tesseract-OCR", "tesseract.exe"),
        r"C:\Program Files\Tesseract-OCR\tesseract.exe",
        r"C:\Program Files (x86)\Tesseract-OCR\tesseract.exe",
    ]

    for p in candidates:
        if os.path.isfile(p):
            return p

    # 3. PATH ä¸­æ˜¯å¦å­˜åœ¨ï¼ˆç”¨æˆ·è‡ªå·±è£…äº†å¹¶åŠ åˆ° PATHï¼‰
    which_path = shutil.which("tesseract")
    if which_path:
        return which_path

    return None


def init_tesseract_or_warn(parent=None) -> bool:
    """
    åˆå§‹åŒ– Tesseractï¼š
    - èƒ½æ‰¾åˆ°æ—¶ï¼šè®¾ç½® pytesseract è·¯å¾„å’Œ TESSDATA_PREFIXï¼Œè¿”å› True
    - æ‰¾ä¸åˆ°æ—¶ï¼šå¼¹å‡ºæç¤ºå¹¶è¿”å› False
    """
    tesseract_path = detect_tesseract_path()
    if tesseract_path:
        pytesseract.pytesseract.tesseract_cmd = tesseract_path
        tessdir = os.path.dirname(tesseract_path)
        os.environ["TESSDATA_PREFIX"] = tessdir
        return True
    else:
        QMessageBox.warning(
            parent,
            "Tesseract æœªæ‰¾åˆ°",
            "æœªèƒ½è‡ªåŠ¨æ‰¾åˆ° Tesseract-OCR ç¨‹åºã€‚\n\n"
            "è¯·å…ˆå®‰è£… Tesseract-OCRï¼Œå¹¶å°†å…¶è·¯å¾„å†™å…¥ç¯å¢ƒå˜é‡ TESSERACT_PATHï¼Œ\n"
            "æˆ–ä¸æœ¬è½¯ä»¶åŒçº§ç›®å½•æ”¾ç½® Tesseract-OCR æ–‡ä»¶å¤¹ã€‚"
        )
        return False

class DeepSeekInvoiceAI:
    """DeepSeek AI å‘ç¥¨åˆ†æåŠ©æ‰‹"""
    
    def __init__(self, api_key=None, mock_mode=False):
        # ä¼˜å…ˆçº§ï¼šä¼ å…¥çš„ api_key > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
        if api_key:
            self.api_key = api_key
        else:
            # å°è¯•ä»ç¯å¢ƒå˜é‡è·å–
            env_api_key = os.environ.get("DEEPSEEK_API_KEY")
            if env_api_key:
                self.api_key = env_api_key
            else:
                # ä½¿ç”¨é»˜è®¤å€¼ï¼ˆé…ç½®ä¸­çš„ API key ç”±è°ƒç”¨æ–¹ä¼ å…¥ï¼‰
                self.api_key = "sk-13580503d24340e092a5958a26a90114"
        self.base_url = "https://api.deepseek.com/v1"
        self.mock_mode = mock_mode
        
        # åˆ›å»ºå¸¦æœ‰é‡è¯•æœºåˆ¶çš„ä¼šè¯
        self.session = requests.Session()
        retry_strategy = Retry(
            total=3,
            backoff_factor=1,
            status_forcelist=[429, 500, 502, 503, 504],
            allowed_methods=["POST", "GET"]
        )
        adapter = HTTPAdapter(max_retries=retry_strategy)
        self.session.mount("https://", adapter)
    
    def _call_api(self, system_prompt, user_prompt):
        """è°ƒç”¨ DeepSeek API"""
        if self.mock_mode:
            return self._mock_response(user_prompt)
        
        try:
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ]
            
            headers = {
                "Content-Type": "application/json",
                "Authorization": f"Bearer {self.api_key}"
            }
            
            payload = {
                "model": "deepseek-chat",
                "messages": messages,
                "temperature": 0.7,
                "stream": False
            }
            
            response = self.session.post(
                f"{self.base_url}/chat/completions",
                headers=headers,
                json=payload,
                timeout=30,
                verify=False
            )
            
            if response.status_code != 200:
                raise Exception(f"APIè¯·æ±‚å¤±è´¥: {response.status_code} {response.text}")
            
            result = response.json()
            return result["choices"][0]["message"]["content"]
            
        except (requests.exceptions.SSLError, requests.exceptions.ConnectionError, 
                requests.exceptions.Timeout) as e:
            print(f"AI APIé”™è¯¯: {str(e)}ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼")
            return self._mock_response(user_prompt)
        except Exception as e:
            raise Exception(f"è°ƒç”¨DeepSeek APIæ—¶å‡ºé”™: {str(e)}")
    
    def _mock_response(self, prompt):
        """æ¨¡æ‹Ÿå“åº”"""
        if "åˆ†æ" in prompt:
            return "ã€AIåˆ†æã€‘è¿™æ˜¯ä¸€å¼ æ­£å¸¸çš„å‘ç¥¨ï¼Œå»ºè®®æ£€æŸ¥å•†å“æ˜ç»†æ˜¯å¦å®Œæ•´ã€‚"
        elif "å®¡æ ¸" in prompt:
            return "ã€AIå®¡æ ¸ã€‘å‘ç¥¨ä¿¡æ¯åŸºæœ¬å®Œæ•´ï¼Œå»ºè®®æ ¸å®é‡‘é¢æ˜¯å¦æ­£ç¡®ã€‚"
        elif "å»ºè®®" in prompt or "è”æƒ³" in prompt:
            return "ã€AIå»ºè®®ã€‘å»ºè®®æ·»åŠ 'è®¾å¤‡è´¹'æˆ–'è€—æ'æ ‡ç­¾ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦æŠ¥é”€ã€‚"
        return "ã€AIåˆ†æã€‘è¯·æ£€æŸ¥å‘ç¥¨ä¿¡æ¯çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ã€‚"
    
    def analyze_invoice(self, invoice, all_invoices=None):
        """
        åˆ†æå‘ç¥¨æ•°æ®ï¼Œæä¾›æ™ºèƒ½åˆ†æ
        
        å‚æ•°:
            invoice: å‘ç¥¨æ•°æ®å­—å…¸
            all_invoices: æ‰€æœ‰å‘ç¥¨åˆ—è¡¨ï¼ˆç”¨äºå¯¹æ¯”åˆ†æï¼‰
        
        è¿”å›:
            åˆ†æç»“æœæ–‡æœ¬
        """
        # æ„å»ºå‘ç¥¨ä¿¡æ¯æ‘˜è¦
        invoice_summary = self._build_invoice_summary(invoice)
        
        # æ„å»ºä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆå¦‚æœæœ‰å…¶ä»–å‘ç¥¨ï¼‰
        context = ""
        if all_invoices:
            total_count = len(all_invoices)
            total_amount = sum(float(inv.get('total_amount', 0) or 0) for inv in all_invoices)
            avg_amount = total_amount / total_count if total_count > 0 else 0
            context = f"\n\nä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š\n- å½“å‰å…±æœ‰ {total_count} å¼ å‘ç¥¨\n- æ€»é‡‘é¢ï¼šÂ¥{total_amount:.2f}\n- å¹³å‡é‡‘é¢ï¼šÂ¥{avg_amount:.2f}"
            if invoice.get('total_amount', 0) > avg_amount * 1.5:
                context += "\n- æ³¨æ„ï¼šæ­¤å‘ç¥¨é‡‘é¢é«˜äºå¹³å‡å€¼50%ä»¥ä¸Š"
        
        system_prompt = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘ç¥¨åˆ†æåŠ©æ‰‹ã€‚è¯·å¯¹å‘ç¥¨æ•°æ®è¿›è¡Œæ™ºèƒ½åˆ†æï¼ŒåŒ…æ‹¬ï¼š
1. å‘ç¥¨ä¿¡æ¯çš„å®Œæ•´æ€§è¯„ä¼°
2. é‡‘é¢åˆç†æ€§åˆ†æ
3. å•†å“æ˜ç»†çš„åˆç†æ€§
4. æ½œåœ¨é—®é¢˜æˆ–å¼‚å¸¸æƒ…å†µ
5. ä¸åŒç±»å‘ç¥¨çš„å¯¹æ¯”åˆ†æï¼ˆå¦‚æœæœ‰ï¼‰

è¯·ç”¨ç®€æ´ã€ä¸“ä¸šçš„ä¸­æ–‡å›ç­”ï¼Œçªå‡ºé‡ç‚¹é—®é¢˜å’Œå»ºè®®ã€‚"""
        
        user_prompt = f"è¯·åˆ†æä»¥ä¸‹å‘ç¥¨ï¼š\n\n{invoice_summary}{context}"
        
        try:
            result = self._call_api(system_prompt, user_prompt)
            return result
        except Exception as e:
            return f"åˆ†æå¤±è´¥ï¼š{str(e)}"
    
    def suggest_tags_and_actions(self, invoice, all_invoices=None):
        """
        ä¸ºå‘ç¥¨æä¾›æ ‡ç­¾å»ºè®®å’Œæ“ä½œå»ºè®®
        
        å‚æ•°:
            invoice: å‘ç¥¨æ•°æ®å­—å…¸
            all_invoices: æ‰€æœ‰å‘ç¥¨åˆ—è¡¨
        
        è¿”å›:
            å»ºè®®æ–‡æœ¬ï¼ˆåŒ…å«æ ‡ç­¾å»ºè®®å’Œæ“ä½œå»ºè®®ï¼‰
        """
        invoice_summary = self._build_invoice_summary(invoice)
        
        system_prompt = """ä½ æ˜¯ä¸€ä¸ªå‘ç¥¨ç®¡ç†åŠ©æ‰‹ã€‚è¯·æ ¹æ®å‘ç¥¨å†…å®¹æä¾›ï¼š
1. åˆé€‚çš„æ ‡ç­¾å»ºè®®ï¼ˆå¦‚ï¼šè®¾å¤‡è´¹ã€è€—æã€å·®æ—…ã€æŠ¥é”€ç­‰ï¼‰
2. åç»­æ“ä½œå»ºè®®ï¼ˆå¦‚ï¼šæ˜¯å¦éœ€è¦æŠ¥é”€ã€æ˜¯å¦éœ€è¦å®¡æ ¸ç­‰ï¼‰
3. åˆ†ç±»å»ºè®®ï¼ˆåŸºäºå•†å“æ˜ç»†ï¼‰

è¯·ç”¨ç®€æ´çš„ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
ã€æ ‡ç­¾å»ºè®®ã€‘ï¼šæ ‡ç­¾1ã€æ ‡ç­¾2ã€æ ‡ç­¾3
ã€æ“ä½œå»ºè®®ã€‘ï¼šå…·ä½“æ“ä½œå»ºè®®
ã€åˆ†ç±»å»ºè®®ã€‘ï¼šåˆ†ç±»å»ºè®®"""
        
        user_prompt = f"è¯·ä¸ºä»¥ä¸‹å‘ç¥¨æä¾›æ ‡ç­¾å’Œæ“ä½œå»ºè®®ï¼š\n\n{invoice_summary}"
        
        try:
            result = self._call_api(system_prompt, user_prompt)
            return result
        except Exception as e:
            return f"å»ºè®®ç”Ÿæˆå¤±è´¥ï¼š{str(e)}"
    
    def review_invoice(self, invoice, validation_result=None):
        """
        AIå®¡æ ¸å‘ç¥¨ä¿¡æ¯ï¼Œæä¾›å®¡æ ¸æ„è§
        
        å‚æ•°:
            invoice: å‘ç¥¨æ•°æ®å­—å…¸
            validation_result: å·²æœ‰çš„éªŒè¯ç»“æœï¼ˆå¯é€‰ï¼‰
        
        è¿”å›:
            å®¡æ ¸æ„è§æ–‡æœ¬
        """
        invoice_summary = self._build_invoice_summary(invoice)
        
        validation_info = ""
        if validation_result:
            errors = validation_result.get('errors', [])
            warnings_list = validation_result.get('warnings', [])
            if errors:
                validation_info += f"\n\nå·²æœ‰éªŒè¯é”™è¯¯ï¼š{', '.join(errors)}"
            if warnings_list:
                validation_info += f"\nå·²æœ‰éªŒè¯è­¦å‘Šï¼š{', '.join(warnings_list)}"
        
        system_prompt = """ä½ æ˜¯ä¸€ä¸ªå‘ç¥¨å®¡æ ¸ä¸“å®¶ã€‚è¯·å¯¹å‘ç¥¨è¿›è¡Œæ·±åº¦å®¡æ ¸ï¼ŒåŒ…æ‹¬ï¼š
1. å‘ç¥¨ä¿¡æ¯çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§
2. é‡‘é¢è®¡ç®—æ˜¯å¦æ­£ç¡®
3. å•†å“æ˜ç»†æ˜¯å¦åˆç†
4. æ˜¯å¦å­˜åœ¨å¼‚å¸¸æˆ–å¯ç–‘æƒ…å†µ
5. æ˜¯å¦ç¬¦åˆæŠ¥é”€è¦æ±‚

è¯·æä¾›è¯¦ç»†çš„å®¡æ ¸æ„è§ï¼ŒåŒ…æ‹¬é—®é¢˜å’Œæ”¹è¿›å»ºè®®ã€‚"""
        
        user_prompt = f"è¯·å®¡æ ¸ä»¥ä¸‹å‘ç¥¨ï¼š\n\n{invoice_summary}{validation_info}"
        
        try:
            result = self._call_api(system_prompt, user_prompt)
            return result
        except Exception as e:
            return f"å®¡æ ¸å¤±è´¥ï¼š{str(e)}"
    
    def analyze_all_invoices(self, invoices):
        """
        åˆ†ææ‰€æœ‰å‘ç¥¨ï¼Œæä¾›æ•´ä½“åˆ†ææŠ¥å‘Š
        
        å‚æ•°:
            invoices: å‘ç¥¨åˆ—è¡¨
        
        è¿”å›:
            åˆ†ææŠ¥å‘Šæ–‡æœ¬
        """
        if not invoices:
            return "æš‚æ— å‘ç¥¨æ•°æ®å¯ä¾›åˆ†æ"
        
        # æ„å»ºç»Ÿè®¡ä¿¡æ¯
        total_count = len(invoices)
        total_amount = sum(float(inv.get('total_amount', 0) or 0) for inv in invoices)
        avg_amount = total_amount / total_count if total_count > 0 else 0
        
        # ç»Ÿè®¡é”€å”®æ–¹
        sellers = {}
        for inv in invoices:
            seller = inv.get('seller', 'æœªçŸ¥')
            if seller not in sellers:
                sellers[seller] = {'count': 0, 'amount': 0}
            sellers[seller]['count'] += 1
            sellers[seller]['amount'] += float(inv.get('total_amount', 0) or 0)
        
        # ç»Ÿè®¡æ ‡ç­¾
        tags_count = {}
        for inv in invoices:
            for tag in inv.get('tags', []):
                tags_count[tag] = tags_count.get(tag, 0) + 1
        
        # æ„å»ºæ‘˜è¦
        summary = f"""å‘ç¥¨ç»Ÿè®¡æ‘˜è¦ï¼š
- å‘ç¥¨æ€»æ•°ï¼š{total_count} å¼ 
- æ€»é‡‘é¢ï¼šÂ¥{total_amount:.2f}
- å¹³å‡é‡‘é¢ï¼šÂ¥{avg_amount:.2f}
- ä¸»è¦é”€å”®æ–¹ï¼š{', '.join(list(sellers.keys())[:5])}
- ä¸»è¦æ ‡ç­¾ï¼š{', '.join(list(tags_count.keys())[:5]) if tags_count else 'æ— '}"""
        
        system_prompt = """ä½ æ˜¯ä¸€ä¸ªå‘ç¥¨æ•°æ®åˆ†æä¸“å®¶ã€‚è¯·å¯¹å‘ç¥¨æ•°æ®æä¾›æ•´ä½“åˆ†æï¼ŒåŒ…æ‹¬ï¼š
1. æ•°æ®åˆ†å¸ƒç‰¹å¾
2. å¼‚å¸¸æƒ…å†µè¯†åˆ«
3. è¶‹åŠ¿åˆ†æ
4. ç®¡ç†å»ºè®®

è¯·ç”¨ä¸“ä¸šã€ç®€æ´çš„ä¸­æ–‡å›ç­”ã€‚"""
        
        user_prompt = f"è¯·åˆ†æä»¥ä¸‹å‘ç¥¨æ•°æ®ï¼š\n\n{summary}"
        
        try:
            result = self._call_api(system_prompt, user_prompt)
            return result
        except Exception as e:
            return f"åˆ†æå¤±è´¥ï¼š{str(e)}"
    
    def _build_invoice_summary(self, invoice):
        """æ„å»ºå‘ç¥¨ä¿¡æ¯æ‘˜è¦"""
        items_text = ""
        items = invoice.get('items', [])
        if items:
            items_text = "\nå•†å“æ˜ç»†ï¼š\n"
            for i, item in enumerate(items[:10], 1):  # æœ€å¤šæ˜¾ç¤º10ä¸ªå•†å“
                name = item.get('name', '')
                amount = item.get('amount', 0)
                category = item.get('category', '')
                items_text += f"  {i}. {name} (åˆ†ç±»: {category}, é‡‘é¢: Â¥{amount:.2f})\n"
            if len(items) > 10:
                items_text += f"  ... è¿˜æœ‰ {len(items) - 10} ä¸ªå•†å“\n"
        
        summary = f"""å‘ç¥¨å·ç ï¼š{invoice.get('invoice_number', 'æœªçŸ¥')}
å¼€ç¥¨æ—¥æœŸï¼š{invoice.get('date', 'æœªçŸ¥')}
é”€å”®æ–¹ï¼š{invoice.get('seller', 'æœªçŸ¥')}
è´­ä¹°æ–¹ï¼š{invoice.get('buyer', 'æœªçŸ¥')}
æ€»é‡‘é¢ï¼šÂ¥{invoice.get('total_amount', 0):.2f}
æ ‡ç­¾ï¼š{', '.join(invoice.get('tags', [])) if invoice.get('tags') else 'æ— '}{items_text}"""
        
        return summary

class InvoiceParser:
    """å‘ç¥¨è§£æå™¨"""

    def __init__(self):
        self.category_mapping = {
            'ç”µå­å…ƒä»¶': 'è€—æ',
            'å¡‘æ–™åˆ¶å“': 'è€—æ',
            'ç¢³çº¤ç»´': 'è€—æ',
            'PCB': 'è€—æ',
            'çº¿å¤¹': 'è€—æ',
            'æ—¥ç”¨æ‚å“': 'å…¶ä»–',
            'åˆè®¡': 'å…¶ä»–'
        }

        # ä»é…ç½®ä¸­åŠ è½½ OCR è¯­è¨€è®¾ç½®ï¼Œä½œä¸ºå‘ç¥¨è§£ææ—¶çš„é»˜è®¤è¯­è¨€
        cfg = load_config()
        self.ocr_lang = cfg.get('ocr_lang', '') or None

    def extract_text_from_pdf(self, pdf_path):
        """ä»PDFä¸­æå–æ–‡æœ¬"""
        try:
            with pdfplumber.open(pdf_path) as pdf:
                text = ''
                for page in pdf.pages:
                    page_text = page.extract_text()
                    if page_text:
                        text += page_text + '\n'
                return text
        except Exception as e:
            print(f"PDFè§£æé”™è¯¯ {pdf_path}: {e}")
            return ""

    def parse_invoice(self, pdf_path):
        """è§£æå‘ç¥¨ä¿¡æ¯"""
        text = self.extract_text_from_pdf(pdf_path)
        if not text:
            return None

        # å…ˆè§£ææ˜ç»†
        items = self.extract_items(text)

        # åŒæ—¶ä»æ–‡æœ¬ä¸­è§£æâ€œä»·ç¨åˆè®¡ï¼ˆå°å†™ï¼‰â€ä½œä¸ºå«ç¨æ€»é‡‘é¢
        text_total = self.extract_total_amount(text)

        # ä¼˜å…ˆä½¿ç”¨æ–‡æœ¬ä¸­çš„ä»·ç¨åˆè®¡ï¼ˆå«ç¨é‡‘é¢ï¼‰ï¼Œæ²¡æœ‰æ—¶å†ä½¿ç”¨æ˜ç»†é‡‘é¢ä¹‹å’Œ
        if text_total and text_total > 0:
            total_amount = text_total
        elif items:
            items_total = sum(float(item.get('amount', 0) or 0) for item in items)
            total_amount = round(items_total, 2)
        else:
            total_amount = 0.0

        invoice_data = {
            'invoice_number': self.extract_invoice_number(text),
            'date': self.extract_date(text),
            'seller': self.extract_seller(text),
            'buyer': self.extract_buyer(text),
            'items': items,
            'total_amount': total_amount,
            'file_path': pdf_path,
            'tags': [],  # åˆå§‹åŒ–æ ‡ç­¾ä¸ºç©ºåˆ—è¡¨
            'validation': None  # éªŒè¯ç»“æœï¼Œå°†åœ¨éªŒè¯æ—¶å¡«å……
        }

        return invoice_data
    
    def validate_invoice(self, invoice, all_invoices=None):
        """
        éªŒè¯å‘ç¥¨æ•°æ®çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§
        è¿”å›éªŒè¯ç»“æœå­—å…¸ï¼ŒåŒ…å«ï¼š
        - is_valid: æ˜¯å¦é€šè¿‡éªŒè¯
        - errors: é”™è¯¯åˆ—è¡¨
        - warnings: è­¦å‘Šåˆ—è¡¨
        """
        errors = []
        warnings = []
        
        # 1. å¿…å¡«å­—æ®µæ£€æŸ¥
        if not invoice.get('invoice_number') or invoice.get('invoice_number', '').strip() == '':
            errors.append('å‘ç¥¨å·ç ä¸ºç©º')
        
        if not invoice.get('date') or invoice.get('date', '').strip() == '':
            errors.append('å¼€ç¥¨æ—¥æœŸä¸ºç©º')
        
        if not invoice.get('seller') or invoice.get('seller', '').strip() == '':
            warnings.append('é”€å”®æ–¹ä¸ºç©º')
        
        buyer = (invoice.get('buyer') or '').strip()
        if not buyer:
            warnings.append('è´­ä¹°æ–¹ä¸ºç©º')
        else:
            # è´­ä¹°æ–¹æŠ¬å¤´æ ¡éªŒï¼šä¸é…ç½®ä¸­çš„ buyer_expected_name å¯¹æ¯”
            cfg = load_config()
            expected_buyer = (cfg.get('buyer_expected_name') or 'è‹å·å¤§å­¦').strip()
            if expected_buyer and buyer != expected_buyer:
                # æŠ¬å¤´ä¸ä¸€è‡´æŒ‰â€œé”™è¯¯â€å¤„ç†ï¼Œä¾¿äºç­›æŸ¥
                errors.append(f'è´­ä¹°æ–¹æŠ¬å¤´ä¸åŒ¹é…ï¼Œå½“å‰ä¸ºâ€œ{buyer}â€ï¼ŒæœŸæœ›ä¸ºâ€œ{expected_buyer}â€')
        
        # 2. é‡‘é¢æ ¡éªŒ
        total_amount = invoice.get('total_amount', 0)
        items = invoice.get('items', [])
        
        if total_amount <= 0:
            errors.append('æ€»é‡‘é¢æ— æ•ˆï¼ˆâ‰¤0ï¼‰')
        
        if items:
            # è®¡ç®—æ˜ç»†é‡‘é¢æ€»å’Œ
            items_total = 0.0
            for item in items:
                try:
                    # ä½¿ç”¨å«ç¨é‡‘é¢ï¼ˆå¦‚æœæœ‰ï¼‰
                    amount = float(item.get('amount', 0) or 0)
                    tax = float(item.get('tax_amount', 0) or 0)
                    items_total += amount + tax
                except (ValueError, TypeError):
                    pass
            
            # å…è®¸ä¸€å®šçš„è¯¯å·®ï¼ˆ0.01å…ƒï¼‰ï¼Œå› ä¸ºå¯èƒ½æœ‰å››èˆäº”å…¥
            if abs(items_total - total_amount) > 0.01:
                if abs(items_total - total_amount) > 1.0:
                    errors.append(f'æ˜ç»†é‡‘é¢æ€»å’Œï¼ˆÂ¥{items_total:.2f}ï¼‰ä¸æ€»é‡‘é¢ï¼ˆÂ¥{total_amount:.2f}ï¼‰ä¸ä¸€è‡´ï¼Œå·®å¼‚ï¼šÂ¥{abs(items_total - total_amount):.2f}')
                else:
                    warnings.append(f'æ˜ç»†é‡‘é¢æ€»å’Œï¼ˆÂ¥{items_total:.2f}ï¼‰ä¸æ€»é‡‘é¢ï¼ˆÂ¥{total_amount:.2f}ï¼‰æœ‰è½»å¾®å·®å¼‚ï¼šÂ¥{abs(items_total - total_amount):.2f}')
        else:
            warnings.append('æ²¡æœ‰å•†å“æ˜ç»†')
        
        # 3. å‘ç¥¨å·é‡å¤æ£€æµ‹ï¼ˆå¦‚æœæä¾›äº†æ‰€æœ‰å‘ç¥¨åˆ—è¡¨ï¼‰
        if all_invoices is not None:
            invoice_number = invoice.get('invoice_number', '').strip()
            if invoice_number:
                duplicate_count = sum(1 for inv in all_invoices 
                                    if inv.get('invoice_number', '').strip() == invoice_number 
                                    and inv.get('file_path') != invoice.get('file_path'))
                if duplicate_count > 0:
                    errors.append(f'å‘ç¥¨å·é‡å¤ï¼ˆå‘ç° {duplicate_count} å¼ ç›¸åŒå‘ç¥¨å·çš„å‘ç¥¨ï¼‰')
        
        # 4. æ–‡ä»¶è·¯å¾„æ£€æŸ¥
        file_path = invoice.get('file_path', '')
        if not file_path:
            errors.append('æ–‡ä»¶è·¯å¾„ä¸ºç©º')
        elif not os.path.exists(file_path):
            errors.append(f'æ–‡ä»¶ä¸å­˜åœ¨ï¼š{file_path}')
        
        # 5. å•†å“æ˜ç»†æ£€æŸ¥
        for idx, item in enumerate(items, 1):
            if not item.get('name') or not item.get('name', '').strip():
                warnings.append(f'ç¬¬ {idx} é¡¹å•†å“åç§°ä¸ºç©º')
            
            try:
                quantity = float(item.get('quantity', 0) or 0)
                price = float(item.get('price', 0) or 0)
                amount = float(item.get('amount', 0) or 0)
                
                if quantity <= 0:
                    warnings.append(f'ç¬¬ {idx} é¡¹å•†å“æ•°é‡æ— æ•ˆï¼ˆâ‰¤0ï¼‰')
                if price < 0:
                    warnings.append(f'ç¬¬ {idx} é¡¹å•†å“å•ä»·ä¸ºè´Ÿ')
                if amount < 0:
                    warnings.append(f'ç¬¬ {idx} é¡¹å•†å“é‡‘é¢ä¸ºè´Ÿ')
                
                # æ£€æŸ¥æ•°é‡Ã—å•ä»·æ˜¯å¦ç­‰äºé‡‘é¢ï¼ˆå…è®¸å°è¯¯å·®ï¼‰
                expected_amount = quantity * price
                if abs(expected_amount - amount) > 0.01:
                    warnings.append(f'ç¬¬ {idx} é¡¹å•†å“ï¼šæ•°é‡Ã—å•ä»·ï¼ˆ{quantity}Ã—{price:.2f}={expected_amount:.2f}ï¼‰ä¸é‡‘é¢ï¼ˆ{amount:.2f}ï¼‰ä¸ä¸€è‡´')
            except (ValueError, TypeError):
                warnings.append(f'ç¬¬ {idx} é¡¹å•†å“æ•°å€¼æ ¼å¼é”™è¯¯')
        
        # è¿”å›éªŒè¯ç»“æœ
        is_valid = len(errors) == 0
        validation_result = {
            'is_valid': is_valid,
            'errors': errors,
            'warnings': warnings,
            'checked_at': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        }
        
        return validation_result

    def extract_invoice_number(self, text):
        """æå–å‘ç¥¨å·ç """
        patterns = [
            r'å‘ç¥¨å·ç [ï¼š:]\s*(\d+)',
            r'å‘ç¥¨å·[ï¼š:]\s*(\d+)',
            r'(\d{20})',  # 20ä½æ•°å­—å‘ç¥¨å·
        ]

        for pattern in patterns:
            match = re.search(pattern, text)
            if match:
                return match.group(1)
        return ""

    def extract_date(self, text):
        """æå–å¼€ç¥¨æ—¥æœŸ"""
        patterns = [
            r'å¼€ç¥¨æ—¥æœŸ[ï¼š:]\s*(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)',
            r'(\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥)',
            r'(\d{4}-\d{1,2}-\d{1,2})',
        ]

        for pattern in patterns:
            match = re.search(pattern, text)
            if match:
                return match.group(1)
        return ""

    def extract_seller(self, text):
        """æå–é”€å”®æ–¹"""
        patterns = [
            r'é”€\s*åç§°[ï¼š:]\s*([^\n]+)',
            r'é”€æ–¹[ï¼š:]\s*([^\n]+)',
        ]

        for pattern in patterns:
            match = re.search(pattern, text)
            if match:
                return match.group(1).strip()
        return ""

    def extract_buyer(self, text):
        """æå–è´­ä¹°æ–¹"""
        patterns = [
            r'è´­\s*åç§°[ï¼š:]\s*([^é”€\n]+)',
            r'è´­æ–¹[ï¼š:]\s*([^é”€\n]+)',
            r'åç§°[ï¼š:]\s*([^\n]*?)\s*é”€\s*åç§°',
        ]

        for pattern in patterns:
            match = re.search(pattern, text)
            if match:
                buyer = match.group(1).strip()
                # æ¸…ç†å¯èƒ½çš„æ‚è´¨
                buyer = re.sub(r'é”€\s*åç§°.*', '', buyer)
                return buyer.strip()
        return ""

    def extract_items(self, text):
        """æå–å•†å“æ˜ç»†"""
        # ç›´æ¥ä½¿ç”¨ç²¾ç¡®çš„è§£ææ–¹æ³•
        return self.extract_items_alternative(text)

    def extract_items_alternative(self, text):
        """æ›¿ä»£çš„å•†å“æ˜ç»†æå–æ–¹æ³•"""
        items = []

        # ç²¾ç¡®åŒ¹é…ç”µå­å‘ç¥¨çš„å•†å“è¡Œæ ¼å¼
        # æ ¼å¼ï¼šé¡¹ç›®åç§° è§„æ ¼å‹å· å•ä½ æ•°é‡ å•ä»· é‡‘é¢ ç¨ç‡ ç¨é¢
        lines = text.split('\n')

        for line in lines:
            line = line.strip()

            # æŸ¥æ‰¾åŒ…å«*çš„é¡¹ç›®è¡Œï¼Œä½†æ’é™¤è¡¨å¤´å’Œæ±‡æ€»è¡Œ
            if '*' in line and not any(keyword in line for keyword in ['åˆè®¡', 'ä»·ç¨åˆè®¡']):
                # åˆ†å‰²è¡Œå†…å®¹
                parts = re.split(r'\s+', line)

                # æˆ‘ä»¬ä¸å†å¼ºä¾èµ–å›ºå®šä½ç½®ï¼Œè€Œæ˜¯ï¼š
                # 1. æ‰¾åˆ°ç¬¬ä¸€ä¸ªåŒ…å«â€œ%â€çš„å­—æ®µï¼ˆç¨ç‡ï¼‰
                # 2. åœ¨ç¨ç‡ä¹‹å‰ï¼Œæœ€åä¸€ä¸ªæ•°å­—è§†ä¸ºâ€œé‡‘é¢â€ï¼Œå€’æ•°ç¬¬äºŒä¸ªæ•°å­—è§†ä¸ºâ€œå•ä»·â€ï¼Œå†å¾€å‰ä¸€ä¸ªè§†ä¸ºâ€œæ•°é‡â€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                try:
                    percent_idx = None
                    for i, p in enumerate(parts):
                        if '%' in p:
                            percent_idx = i
                            break

                    search_end = percent_idx if percent_idx is not None else len(parts)

                    numeric_indices = []
                    for i, p in enumerate(parts[:search_end]):
                        try:
                            v = float(p)
                            numeric_indices.append((i, v))
                        except ValueError:
                            continue

                    if not numeric_indices:
                        # æ²¡æœ‰æ•°å­—ï¼Œæ”¾å¼ƒæœ¬è¡Œ
                        continue

                    # é‡‘é¢ï¼ˆæœªç¨ï¼‰ï¼šç¨ç‡å‰æœ€åä¸€ä¸ªæ•°å­—
                    amount_idx, amount_no_tax = numeric_indices[-1]

                    # å•ä»·ï¼šé‡‘é¢å‰ä¸€ä¸ªæ•°å­—ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä¸é‡‘é¢ç›¸åŒã€‚
                    # å¯¹äºåªæœ‰ä¸¤ä¸ªæ•°å­—ä¸”ç¬¬ä¸€ä¸ªæ˜æ˜¾å¼‚å¸¸ï¼ˆå¦‚ 1202.65 ä¸ 202.65ï¼‰ï¼Œ
                    # ç›´æ¥è®¤ä¸ºå•ä»·ç­‰äºé‡‘é¢ï¼Œå‰é¢çš„æ•°å­—è§†ä¸ºå™ªå£°ã€‚
                    if len(numeric_indices) >= 2:
                        if len(numeric_indices) == 2:
                            price_idx, price_no_tax = amount_idx, amount_no_tax
                        else:
                            price_idx, price_no_tax = numeric_indices[-2]
                    else:
                        price_idx, price_no_tax = amount_idx, amount_no_tax

                    # æ•°é‡ï¼šå†å¾€å‰ä¸€ä¸ªæ•°å­—ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™æ ¹æ® é‡‘é¢/å•ä»· ä¼°ç®—æˆ–é»˜è®¤ä¸º 1
                    if len(numeric_indices) >= 3:
                        qty_idx, quantity = numeric_indices[-3]
                    else:
                        quantity = 1.0
                        if price_no_tax > 0:
                            est_qty = amount_no_tax / price_no_tax
                            # å¦‚æœæ¥è¿‘æ•´æ•°ï¼Œåˆ™é‡‡ç”¨ä¼°ç®—æ•°é‡
                            if abs(est_qty - round(est_qty)) < 1e-3:
                                quantity = float(round(est_qty))

                    # ç¨é¢ï¼šåœ¨ç¨ç‡å­—æ®µä¹‹åçš„ç¬¬ä¸€ä¸ªæ•°å­—
                    tax_amount = 0.0
                    if percent_idx is not None and percent_idx + 1 < len(parts):
                        for p in parts[percent_idx + 1:]:
                            try:
                                tax_amount = float(p)
                                break
                            except ValueError:
                                continue

                    # å«ç¨é‡‘é¢ / å•ä»·
                    amount_with_tax = amount_no_tax + tax_amount
                    price_with_tax = amount_with_tax / quantity if quantity not in (0, None) else amount_with_tax

                    # å¦‚æœæ˜¯æŠ˜æ‰£è¡Œï¼ˆé‡‘é¢ä¸ºè´Ÿï¼‰ï¼Œä¸å¸Œæœ›å‡ºç°è´Ÿå•ä»·ï¼š
                    # - å•ä»·è®¾ä¸ºé‡‘é¢çš„ç»å¯¹å€¼
                    # - æ•°é‡å›ºå®šä¸º 1ï¼ˆè¡¨ç¤ºä¸€ç¬”æŠ˜æ‰£ï¼‰
                    # è¿™æ ·åœ¨ç•Œé¢ä¸­çœ‹åˆ°çš„æ˜¯â€œå•ä»·ä¸ºæ­£ï¼Œé‡‘é¢ä¸ºè´Ÿâ€çš„æŠ˜æ‰£è¡Œï¼Œæ›´ç¬¦åˆç›´è§‰ã€‚
                    if amount_with_tax < 0:
                        price_with_tax = abs(amount_with_tax)
                        quantity = 1.0

                    # å•ä½ï¼šç¬¬ä¸€ä¸ªæ•°å­—å‰ä¸€ä¸ªå­—æ®µé€šå¸¸æ˜¯å•ä½ï¼Œä¾‹å¦‚ â€œâ€¦ ä¸ª 3 2.27 6.83 â€¦â€
                    first_num_idx = numeric_indices[0][0]
                    unit_idx = first_num_idx - 1
                    unit = 'ä¸ª'
                    if unit_idx >= 0:
                        unit = parts[unit_idx]

                    # å•†å“åç§°ï¼šå•ä½ä¹‹å‰çš„æ‰€æœ‰å­—æ®µ
                    name_parts = parts[:unit_idx] if unit_idx > 0 else parts[:amount_idx]
                    product_name = ' '.join(name_parts).strip()

                    # è§„æ ¼ï¼šç®€å•å–åç§°ä¸­çš„ç¬¬äºŒæ®µä½œä¸ºè§„æ ¼ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    spec = ''
                    if len(name_parts) > 1:
                        spec = name_parts[-1]

                    category = self.auto_categorize(product_name)

                    # æŠ˜æ‰£è¡Œåœ¨åç§°åé¢åŠ ä¸Šâ€œï¼ˆæŠ˜æ‰£ï¼‰â€ä»¥ä¾¿è¯†åˆ«
                    if amount_with_tax < 0 or 'ä¼˜æƒ ' in line:
                        product_name = (product_name + 'ï¼ˆæŠ˜æ‰£ï¼‰').strip()

                    item = {
                        'category': category,
                        'name': product_name,
                        'unit': unit,
                        'quantity': quantity,
                        # å¯¹å¤–æš´éœ²çš„å•ä»·/é‡‘é¢å…¨éƒ¨ä¸ºâ€œå«ç¨ä»·â€
                        'price': price_with_tax,
                        'amount': amount_with_tax,
                        'spec': spec
                    }
                    items.append(item)

                except Exception:
                    # å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ç®€å•è§£æ
                    self.parse_item_simple(line, items)

        return items

    def parse_item_simple(self, line, items):
        """ç®€å•è§£æå•†å“è¡Œï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ³•ï¼‰"""
        if '*' in line:
            parts = line.split()
            name_part = None
            amount_part = None

            for part in parts:
                if '*' in part:
                    name_part = part
                # æŸ¥æ‰¾é‡‘é¢ï¼ˆè·³è¿‡ç¨é¢ï¼Œæ‰¾è¾ƒå¤§çš„é‡‘é¢ï¼‰
                if re.match(r'^\d+\.?\d*$', part):
                    try:
                        value = float(part)
                        if value > 0 and (amount_part is None or value > amount_part):
                            amount_part = value
                    except:
                        continue

            if name_part and amount_part:
                category = self.auto_categorize(name_part)
                items.append({
                    'category': category,
                    'name': name_part,
                    'unit': 'ä¸ª',
                    'quantity': 1.0,
                    'price': amount_part,
                    'amount': amount_part,
                    'spec': ''
                })

    def parse_item_line(self, line):
        """è§£æå•†å“è¡Œ"""
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ†å‰²å¯èƒ½çš„å•†å“ä¿¡æ¯
        # åŒ¹é…æ¨¡å¼ï¼šé¡¹ç›®åç§° è§„æ ¼å‹å· å•ä½ æ•°é‡ å•ä»· é‡‘é¢ ç¨ç‡ ç¨é¢

        # ç®€åŒ–è§£æï¼ŒæŸ¥æ‰¾åŒ…å«*çš„å•†å“åç§°å’Œé‡‘é¢
        if '*' in line:
            parts = line.split()
            if len(parts) >= 3:
                try:
                    # å°è¯•æ‰¾åˆ°å•†å“åç§°ï¼ˆåŒ…å«*çš„ï¼‰å’Œé‡‘é¢
                    name_part = None
                    amount_part = None

                    for part in parts:
                        if '*' in part:
                            name_part = part
                        # æŸ¥æ‰¾é‡‘é¢ï¼ˆåŒ…å«æ•°å­—å’Œå°æ•°ç‚¹ï¼‰
                        if re.match(r'^\d+\.?\d*$', part):
                            amount_part = float(part)

                    if name_part and amount_part:
                        # è‡ªåŠ¨åˆ†ç±»
                        category = self.auto_categorize(name_part)

                        return {
                            'category': category,
                            'name': name_part,
                            'unit': 'ä¸ª',  # é»˜è®¤å•ä½
                            'quantity': 1.0,  # é»˜è®¤æ•°é‡
                            'price': amount_part,
                            'amount': amount_part,
                            'spec': ''  # è§„æ ¼å‹å·
                        }
                except:
                    pass

        return None

    def auto_categorize(self, product_name):
        """è‡ªåŠ¨åˆ†ç±»å•†å“"""
        for keyword, category in self.category_mapping.items():
            if keyword in product_name:
                return category
        return 'å…¶ä»–'

    def extract_total_amount(self, text):
        """æå–æ€»é‡‘é¢"""
        # è¿™é‡Œåªå–â€œä»·ç¨åˆè®¡ï¼ˆå°å†™ï¼‰â€å¯¹åº”çš„å«ç¨é‡‘é¢ï¼Œé¿å…è¯¯æŠ“åˆ°å‰é¢çš„â€œåˆè®¡ï¼ˆæœªç¨é‡‘é¢ï¼‰â€
        patterns = [
            r'ä»·ç¨åˆè®¡.*?[ï¼ˆ(]å°å†™[ï¼‰)]\s*Â¥?\s*(\d+\.?\d*)',
            r'ä»·ç¨åˆè®¡[ï¼š:]\s*Â¥?\s*(\d+\.?\d*)',
        ]

        for pattern in patterns:
            match = re.search(pattern, text)
            if match:
                try:
                    return float(match.group(1))
                except:
                    continue
        return 0.0


class InvoiceProcessor(QThread):
    """å‘ç¥¨å¤„ç†çº¿ç¨‹"""
    progress = pyqtSignal(int)
    finished = pyqtSignal(list)
    error = pyqtSignal(str)

    def __init__(self, pdf_files):
        super().__init__()
        self.pdf_files = pdf_files
        self.parser = InvoiceParser()

    def run(self):
        """å¤„ç†å‘ç¥¨æ–‡ä»¶"""
        invoices = []

        for i, pdf_file in enumerate(self.pdf_files):
            try:
                invoice = self.parser.parse_invoice(pdf_file)
                if invoice:
                    invoices.append(invoice)
                self.progress.emit(int((i + 1) / len(self.pdf_files) * 100))
            except Exception as e:
                self.error.emit(f"å¤„ç†æ–‡ä»¶ {pdf_file} æ—¶å‡ºé”™: {str(e)}")

        self.finished.emit(invoices)


class PurchaseRecordMatcher(QThread):
    """è´­ä¹°è®°å½• OCR åŒ¹é…ä¸é‡å‘½åçº¿ç¨‹"""

    progress = pyqtSignal(int)
    finished = pyqtSignal(dict)
    error = pyqtSignal(str)

    def __init__(self, folder, files, invoices):
        super().__init__()
        self.folder = folder
        self.files = files
        self.invoices = invoices or []

    # ---------------- å†…éƒ¨å·¥å…·æ–¹æ³•ï¼Œä¸ç•Œé¢å®Œå…¨è§£è€¦ï¼Œä»…åšè®¡ç®— ----------------
    def _extract_paid_amount_from_image(self, img_path):
        """ä»å›¾ç‰‡ä¸­è¯†åˆ«å®ä»˜é‡‘é¢ï¼Œä»…ç”¨äºçº¿ç¨‹å†…éƒ¨è°ƒç”¨"""
        try:
            image = Image.open(img_path)
        except Exception as e:
            print(f"OCR æ‰“å¼€å›¾ç‰‡å¤±è´¥ {img_path}: {e}")
            return None

        try:
            text = ocr_image_to_string(image)
        except Exception as e:
            print(f"OCR è¯†åˆ«å¤±è´¥ {img_path}: {e}")
            return None

        if not text:
            return None

        lines = text.splitlines()
        amount_pattern = re.compile(r'([0-9]+(?:\.[0-9]{1,2})?)')

        keywords = ['å®ä»˜', 'å®æ”¶', 'å®ä»˜é‡‘é¢', 'æ”¯ä»˜é‡‘é¢', 'åº”ä»˜é‡‘é¢', 'åˆè®¡', 'æ€»è®¡']
        candidate_amounts = []

        for line in lines:
            if any(k in line for k in keywords):
                for m in amount_pattern.finditer(line.replace(',', '')):
                    try:
                        val = float(m.group(1))
                        candidate_amounts.append(val)
                    except ValueError:
                        continue

        if candidate_amounts:
            return max(candidate_amounts)

        all_amounts = []
        for line in lines:
            for m in amount_pattern.finditer(line.replace(',', '')):
                try:
                    val = float(m.group(1))
                    all_amounts.append(val)
                except ValueError:
                    continue

        if all_amounts:
            return max(all_amounts)

        return None

    def _find_invoice_by_amount(self, amount, tol=0.01):
        """æ ¹æ®é‡‘é¢åœ¨å‘ç¥¨åˆ—è¡¨ä¸­åŒ¹é…å‘ç¥¨"""
        if amount is None:
            return None

        # ä»é…ç½®ä¸­è¯»å–åŒ¹é…é‡‘é¢å®¹å·®è®¾ç½®
        cfg = load_config()
        tol = float(cfg.get('match_tolerance', tol) or tol)

        for inv in self.invoices:
            try:
                inv_amount = float(inv.get('total_amount', 0) or 0)
            except Exception:
                continue

            if abs(inv_amount - amount) <= tol:
                return inv

        return None

    # ---------------- çº¿ç¨‹ä¸»æµç¨‹ ----------------
    def run(self):
        matched_count = 0
        unmatched_files = []
        error_files = []

        total = len(self.files) if self.files else 0
        if total == 0:
            self.finished.emit({
                "total": 0,
                "matched": 0,
                "unmatched_files": [],
                "error_files": [],
                "folder": self.folder,
            })
            return

        try:
            for i, img_path in enumerate(self.files):
                try:
                    paid_amount = self._extract_paid_amount_from_image(img_path)
                    if paid_amount is None:
                        unmatched_files.append(os.path.basename(img_path))
                    else:
                        invoice = self._find_invoice_by_amount(paid_amount)
                        if not invoice:
                            unmatched_files.append(os.path.basename(img_path))
                        else:
                            inv_no = (invoice.get('invoice_number') or '').strip() or 'NOINVNO'
                            new_name = f"{inv_no}_{paid_amount:.2f}_{os.path.basename(img_path)}"
                            new_path = os.path.join(self.folder, new_name)

                            counter = 1
                            base_new_name, ext = os.path.splitext(new_name)
                            while os.path.exists(new_path):
                                new_name = f"{base_new_name}_{counter}{ext}"
                                new_path = os.path.join(self.folder, new_name)
                                counter += 1

                            os.rename(img_path, new_path)
                            matched_count += 1
                except Exception:
                    error_files.append(os.path.basename(img_path))

                self.progress.emit(int((i + 1) / total * 100))

        except Exception as e:
            self.error.emit(str(e))
            return

        self.finished.emit({
            "total": total,
            "matched": matched_count,
            "unmatched_files": unmatched_files,
            "error_files": error_files,
            "folder": self.folder,
        })

class AIWorker(QThread):
    """AI å¤„ç†å·¥ä½œçº¿ç¨‹ï¼Œé¿å…é˜»å¡UI"""
    finished = pyqtSignal(str)  # ä¼ é€’ç»“æœ
    error = pyqtSignal(str)  # ä¼ é€’é”™è¯¯ä¿¡æ¯
    
    def __init__(self, ai_client, method_name, *args, **kwargs):
        super().__init__()
        self.ai_client = ai_client
        self.method_name = method_name
        self.args = args
        self.kwargs = kwargs
    
    def run(self):
        """åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡ŒAIè°ƒç”¨"""
        try:
            method = getattr(self.ai_client, self.method_name)
            result = method(*self.args, **self.kwargs)
            self.finished.emit(result)
        except Exception as e:
            self.error.emit(str(e))


class AIWorker(QThread):
    """AI å¤„ç†å·¥ä½œçº¿ç¨‹ï¼Œé¿å…é˜»å¡UI"""
    finished = pyqtSignal(str)  # ä¼ é€’ç»“æœ
    error = pyqtSignal(str)  # ä¼ é€’é”™è¯¯ä¿¡æ¯
    
    def __init__(self, ai_client, method_name, *args, **kwargs):
        super().__init__()
        self.ai_client = ai_client
        self.method_name = method_name
        self.args = args
        self.kwargs = kwargs
    
    def run(self):
        """åœ¨åå°çº¿ç¨‹ä¸­æ‰§è¡ŒAIè°ƒç”¨"""
        try:
            method = getattr(self.ai_client, self.method_name)
            result = method(*self.args, **self.kwargs)
            self.finished.emit(result)
        except Exception as e:
            self.error.emit(str(e))


class InvoicePreviewDialog(QDialog):
    """å‘ç¥¨é¢„è§ˆå¯¹è¯æ¡†ï¼Œåœ¨è½¯ä»¶å†…éƒ¨æ»šåŠ¨æŸ¥çœ‹PDFç¬¬ä¸€é¡µ"""

    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle('å‘ç¥¨é¢„è§ˆ')
        # é€‚å½“å¤§ä¸€ç‚¹ï¼Œæ–¹ä¾¿é˜…è¯»
        self.resize(900, 1000)

        layout = QVBoxLayout(self)
        
        # å·¥å…·æ 
        toolbar_layout = QHBoxLayout()
        toolbar_layout.setSpacing(6)
        
        self.zoom_in_btn = QPushButton('ğŸ”+ æ”¾å¤§')
        self.zoom_in_btn.setProperty('btnType', 'ghost')
        self.zoom_in_btn.clicked.connect(self.zoom_in)
        toolbar_layout.addWidget(self.zoom_in_btn)
        
        self.zoom_out_btn = QPushButton('ğŸ”- ç¼©å°')
        self.zoom_out_btn.setProperty('btnType', 'ghost')
        self.zoom_out_btn.clicked.connect(self.zoom_out)
        toolbar_layout.addWidget(self.zoom_out_btn)
        
        self.zoom_reset_btn = QPushButton('â†º é‡ç½®')
        self.zoom_reset_btn.setProperty('btnType', 'ghost')
        self.zoom_reset_btn.clicked.connect(self.zoom_reset)
        toolbar_layout.addWidget(self.zoom_reset_btn)
        
        self.zoom_label = QLabel('100%')
        self.zoom_label.setMinimumWidth(50)
        toolbar_layout.addWidget(self.zoom_label)
        
        toolbar_layout.addStretch(1)
        layout.addLayout(toolbar_layout)

        self.scroll_area = QScrollArea(self)
        self.scroll_area.setWidgetResizable(True)
        # å¯ç”¨é¼ æ ‡æ»šè½®ç¼©æ”¾
        self.scroll_area.wheelEvent = self.wheel_event_handler

        self.image_label = QLabel()
        self.image_label.setAlignment(Qt.AlignCenter)
        self.scroll_area.setWidget(self.image_label)

        layout.addWidget(self.scroll_area)
        
        # åˆå§‹åŒ–
        self.original_pixmap = None
        self.zoom_factor = 1.0

    def set_pixmap(self, pixmap: QPixmap):
        """è®¾ç½®è¦æ˜¾ç¤ºçš„å‘ç¥¨å›¾ç‰‡"""
        self.original_pixmap = pixmap
        self.zoom_factor = 1.0
        self._update_display()
    
    def _update_display(self):
        """æ›´æ–°æ˜¾ç¤º"""
        if not self.original_pixmap:
            return
        
        # æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è®¡ç®—å°ºå¯¸
        original_size = self.original_pixmap.size()
        scaled_width = int(original_size.width() * self.zoom_factor)
        scaled_height = int(original_size.height() * self.zoom_factor)
        
        scaled_pixmap = self.original_pixmap.scaled(
            scaled_width,
            scaled_height,
            Qt.KeepAspectRatio,
            Qt.SmoothTransformation
        )
        self.image_label.setPixmap(scaled_pixmap)
        self.image_label.adjustSize()
        
        # æ›´æ–°ç¼©æ”¾æ¯”ä¾‹æ˜¾ç¤º
        zoom_percent = int(self.zoom_factor * 100)
        self.zoom_label.setText(f'{zoom_percent}%')
    
    def zoom_in(self):
        """æ”¾å¤§"""
        if self.original_pixmap:
            self.zoom_factor = min(self.zoom_factor * 1.2, 5.0)  # æœ€å¤§5å€
            self._update_display()
    
    def zoom_out(self):
        """ç¼©å°"""
        if self.original_pixmap:
            self.zoom_factor = max(self.zoom_factor / 1.2, 0.2)  # æœ€å°0.2å€
            self._update_display()
    
    def zoom_reset(self):
        """é‡ç½®ç¼©æ”¾"""
        if self.original_pixmap:
            self.zoom_factor = 1.0
            self._update_display()
    
    def wheel_event_handler(self, event):
        """é¼ æ ‡æ»šè½®äº‹ä»¶ï¼šCtrl+æ»šè½®ç¼©æ”¾"""
        if event.modifiers() == Qt.ControlModifier and self.original_pixmap:
            # Ctrl + æ»šè½®ç¼©æ”¾
            delta = event.angleDelta().y()
            if delta > 0:
                self.zoom_in()
            else:
                self.zoom_out()
        else:
            # æ™®é€šæ»šè½®æ»šåŠ¨
            QScrollArea.wheelEvent(self.scroll_area, event)


class SettingsDialog(QDialog):
    """è®¾ç½®å¯¹è¯æ¡†"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle('è®¾ç½®')
        self.setModal(True)
        self.setMinimumWidth(520)
        self.setMinimumHeight(600)
        self.resize(560, 700)  # è®¾ç½®åˆé€‚çš„åˆå§‹å¤§å°
        
        # ä¸»å¸ƒå±€
        main_layout = QVBoxLayout(self)
        main_layout.setSpacing(0)
        main_layout.setContentsMargins(0, 0, 0, 0)
        
        # åˆ›å»ºæ»šåŠ¨åŒºåŸŸ
        scroll_area = QScrollArea()
        scroll_area.setWidgetResizable(True)
        scroll_area.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
        scroll_area.setVerticalScrollBarPolicy(Qt.ScrollBarAsNeeded)
        scroll_area.setFrameShape(QScrollArea.NoFrame)
        
        # åˆ›å»ºå†…å®¹éƒ¨ä»¶
        content_widget = QWidget()
        layout = QVBoxLayout(content_widget)
        layout.setSpacing(15)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # ========== Tesseract OCR è·¯å¾„è®¾ç½® ==========
        tesseract_group = QGroupBox('Tesseract OCR é…ç½®')
        tesseract_layout = QVBoxLayout(tesseract_group)
        
        desc_label = QLabel('è¯·é€‰æ‹© Tesseract-OCR çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼ˆtesseract.exeï¼‰ï¼š')
        desc_label.setWordWrap(True)
        tesseract_layout.addWidget(desc_label)
        
        path_layout = QHBoxLayout()
        self.tesseract_path_edit = QLineEdit()
        self.tesseract_path_edit.setPlaceholderText('ä¾‹å¦‚ï¼šC:\\Program Files\\Tesseract-OCR\\tesseract.exe')
        
        # åŠ è½½å½“å‰é…ç½®
        config = load_config()
        current_path = config.get('tesseract_path', '')
        if current_path:
            self.tesseract_path_edit.setText(current_path)
        else:
            # å°è¯•è‡ªåŠ¨æ£€æµ‹å¹¶æ˜¾ç¤º
            auto_path = detect_tesseract_path()
            if auto_path:
                self.tesseract_path_edit.setText(auto_path)
        
        path_layout.addWidget(self.tesseract_path_edit)
        
        browse_btn = QPushButton('æµè§ˆ...')
        browse_btn.clicked.connect(self.browse_tesseract_path)
        path_layout.addWidget(browse_btn)
        
        tesseract_layout.addLayout(path_layout)
        
        # æµ‹è¯•æŒ‰é’®
        test_btn = QPushButton('æµ‹è¯•è·¯å¾„')
        test_btn.clicked.connect(self.test_tesseract_path)
        tesseract_layout.addWidget(test_btn)
        
        layout.addWidget(tesseract_group)

        # ========== OCR / åŒ¹é…è¡Œä¸ºè®¾ç½® ==========
        behavior_group = QGroupBox('è¯†åˆ«ä¸åŒ¹é…è¡Œä¸º')
        behavior_layout = QVBoxLayout(behavior_group)

        # OCR è¯­è¨€
        ocr_lang_layout = QHBoxLayout()
        ocr_lang_label = QLabel('OCR è¯­è¨€ï¼š')
        self.ocr_lang_combo = QComboBox()
        self.ocr_lang_combo.addItem('è‡ªåŠ¨ï¼ˆä¸æŒ‡å®šï¼Œé»˜è®¤è¯†åˆ«ï¼‰', '')
        self.ocr_lang_combo.addItem('ä¸­æ–‡ + è‹±æ–‡ï¼ˆchi_sim+engï¼‰', 'chi_sim+eng')
        self.ocr_lang_combo.addItem('ä»…ä¸­æ–‡ï¼ˆchi_simï¼‰', 'chi_sim')
        self.ocr_lang_combo.addItem('ä»…è‹±æ–‡ï¼ˆengï¼‰', 'eng')

        current_ocr_lang = config.get('ocr_lang', '')
        index = self.ocr_lang_combo.findData(current_ocr_lang)
        if index >= 0:
            self.ocr_lang_combo.setCurrentIndex(index)

        ocr_lang_layout.addWidget(ocr_lang_label)
        ocr_lang_layout.addWidget(self.ocr_lang_combo)
        behavior_layout.addLayout(ocr_lang_layout)

        # å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡å‘ç¥¨
        self.auto_load_checkbox = QCheckBox('å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„å‘ç¥¨æ•°æ®')
        self.auto_load_checkbox.setChecked(config.get('auto_load_invoices', True))
        behavior_layout.addWidget(self.auto_load_checkbox)

        # åŒ¹é…é‡‘é¢å®¹å·®
        match_tol_layout = QHBoxLayout()
        match_tol_label = QLabel('åŒ¹é…é‡‘é¢å®¹å·®ï¼š')
        self.match_tol_spin = QDoubleSpinBox()
        self.match_tol_spin.setRange(0.00, 10.00)
        self.match_tol_spin.setDecimals(2)
        self.match_tol_spin.setSingleStep(0.01)
        self.match_tol_spin.setSuffix(' å…ƒ')
        self.match_tol_spin.setValue(float(config.get('match_tolerance', 0.01) or 0.01))

        match_tol_layout.addWidget(match_tol_label)
        match_tol_layout.addWidget(self.match_tol_spin)
        behavior_layout.addLayout(match_tol_layout)

        layout.addWidget(behavior_group)
        
        # ========== æ•°æ®ç®¡ç†è®¾ç½® ==========
        data_group = QGroupBox('æ•°æ®ç®¡ç†')
        data_layout = QVBoxLayout(data_group)
        
        # è‡ªåŠ¨å¤‡ä»½
        backup_layout = QHBoxLayout()
        self.auto_backup_checkbox = QCheckBox('å¯ç”¨è‡ªåŠ¨å¤‡ä»½')
        self.auto_backup_checkbox.setChecked(config.get('auto_backup', False))
        backup_layout.addWidget(self.auto_backup_checkbox)
        
        backup_interval_label = QLabel('å¤‡ä»½é—´éš”ï¼ˆå¤©ï¼‰ï¼š')
        self.backup_interval_spin = QDoubleSpinBox()
        self.backup_interval_spin.setRange(1, 30)
        self.backup_interval_spin.setDecimals(0)
        self.backup_interval_spin.setValue(float(config.get('backup_interval', 7) or 7))
        self.backup_interval_spin.setEnabled(self.auto_backup_checkbox.isChecked())
        self.auto_backup_checkbox.toggled.connect(self.backup_interval_spin.setEnabled)
        
        backup_layout.addWidget(backup_interval_label)
        backup_layout.addWidget(self.backup_interval_spin)
        backup_layout.addStretch(1)
        data_layout.addLayout(backup_layout)
        
        # é»˜è®¤å¤‡ä»½è·¯å¾„
        backup_path_layout = QHBoxLayout()
        backup_path_label = QLabel('é»˜è®¤å¤‡ä»½è·¯å¾„ï¼š')
        self.backup_path_edit = QLineEdit()
        self.backup_path_edit.setPlaceholderText('ç•™ç©ºåˆ™ä½¿ç”¨ç¨‹åºç›®å½•')
        backup_path = config.get('backup_path', '')
        if backup_path:
            self.backup_path_edit.setText(backup_path)
        
        backup_path_layout.addWidget(backup_path_label)
        backup_path_layout.addWidget(self.backup_path_edit)
        
        backup_browse_btn = QPushButton('æµè§ˆ...')
        backup_browse_btn.clicked.connect(self.browse_backup_path)
        backup_path_layout.addWidget(backup_browse_btn)
        data_layout.addLayout(backup_path_layout)
        
        layout.addWidget(data_group)
        
        # ========== å¯¼å‡ºè®¾ç½® ==========
        export_group = QGroupBox('å¯¼å‡ºè®¾ç½®')
        export_layout = QVBoxLayout(export_group)
        
        # é»˜è®¤å¯¼å‡ºè·¯å¾„
        export_path_layout = QHBoxLayout()
        export_path_label = QLabel('é»˜è®¤å¯¼å‡ºè·¯å¾„ï¼š')
        self.export_path_edit = QLineEdit()
        self.export_path_edit.setPlaceholderText('ç•™ç©ºåˆ™æ¯æ¬¡è¯¢é—®')
        export_path = config.get('export_path', '')
        if export_path:
            self.export_path_edit.setText(export_path)
        
        export_path_layout.addWidget(export_path_label)
        export_path_layout.addWidget(self.export_path_edit)
        
        export_browse_btn = QPushButton('æµè§ˆ...')
        export_browse_btn.clicked.connect(self.browse_export_path)
        export_path_layout.addWidget(export_browse_btn)
        export_layout.addLayout(export_path_layout)
        
        # å¯¼å‡ºæ—¶åŒ…å«éªŒè¯ä¿¡æ¯
        self.include_validation_checkbox = QCheckBox('å¯¼å‡ºæ—¶åŒ…å«éªŒè¯ä¿¡æ¯')
        self.include_validation_checkbox.setChecked(config.get('export_include_validation', True))
        export_layout.addWidget(self.include_validation_checkbox)
        
        layout.addWidget(export_group)
        
        # ========== éªŒè¯è®¾ç½® ==========
        validation_group = QGroupBox('éªŒè¯è®¾ç½®')
        validation_layout = QVBoxLayout(validation_group)
        
        # å¯¼å…¥æ—¶è‡ªåŠ¨éªŒè¯
        self.auto_validate_checkbox = QCheckBox('å¯¼å…¥å‘ç¥¨æ—¶è‡ªåŠ¨éªŒè¯')
        self.auto_validate_checkbox.setChecked(config.get('auto_validate', True))
        validation_layout.addWidget(self.auto_validate_checkbox)
        
        # éªŒè¯ä¸¥æ ¼ç¨‹åº¦
        strict_layout = QHBoxLayout()
        strict_label = QLabel('éªŒè¯ä¸¥æ ¼ç¨‹åº¦ï¼š')
        self.validation_strict_combo = QComboBox()
        self.validation_strict_combo.addItem('å®½æ¾ï¼ˆä»…æ£€æŸ¥ä¸¥é‡é”™è¯¯ï¼‰', 'loose')
        self.validation_strict_combo.addItem('æ ‡å‡†ï¼ˆæ£€æŸ¥é”™è¯¯å’Œé‡è¦è­¦å‘Šï¼‰', 'normal')
        self.validation_strict_combo.addItem('ä¸¥æ ¼ï¼ˆæ£€æŸ¥æ‰€æœ‰é—®é¢˜ï¼‰', 'strict')
        
        strict_level = config.get('validation_strictness', 'normal')
        index = self.validation_strict_combo.findData(strict_level)
        if index >= 0:
            self.validation_strict_combo.setCurrentIndex(index)
        
        strict_layout.addWidget(strict_label)
        strict_layout.addWidget(self.validation_strict_combo)
        validation_layout.addLayout(strict_layout)
        
        layout.addWidget(validation_group)
        
        # ========== æŠ¬å¤´è®¾ç½® ==========
        ui_group = QGroupBox('æŠ¬å¤´/ç•Œé¢è®¾ç½®')
        ui_layout = QVBoxLayout(ui_group)
        
        # å‘ç¥¨æŠ¬å¤´æ ¡éªŒåç§°
        buyer_layout = QHBoxLayout()
        buyer_label = QLabel('æœŸæœ›è´­ä¹°æ–¹æŠ¬å¤´ï¼š')
        self.buyer_expected_edit = QLineEdit()
        self.buyer_expected_edit.setPlaceholderText('ä¾‹å¦‚ï¼šè‹å·å¤§å­¦')
        self.buyer_expected_edit.setText(config.get('buyer_expected_name', 'è‹å·å¤§å­¦'))
        buyer_layout.addWidget(buyer_label)
        buyer_layout.addWidget(self.buyer_expected_edit)
        ui_layout.addLayout(buyer_layout)
        
        # å‘ç¥¨åˆ—è¡¨æ˜¾ç¤ºé¡¹
        list_display_layout = QHBoxLayout()
        list_display_label = QLabel('åˆ—è¡¨æ˜¾ç¤ºï¼š')
        self.show_tags_checkbox = QCheckBox('æ˜¾ç¤ºæ ‡ç­¾')
        self.show_tags_checkbox.setChecked(config.get('list_show_tags', True))
        self.show_validation_checkbox = QCheckBox('æ˜¾ç¤ºéªŒè¯çŠ¶æ€')
        self.show_validation_checkbox.setChecked(config.get('list_show_validation', True))
        
        list_display_layout.addWidget(list_display_label)
        list_display_layout.addWidget(self.show_tags_checkbox)
        list_display_layout.addWidget(self.show_validation_checkbox)
        list_display_layout.addStretch(1)
        ui_layout.addLayout(list_display_layout)
        
        layout.addWidget(ui_group)
        
        # ========== å…¶ä»–è®¾ç½® ==========
        other_group = QGroupBox('å…¶ä»–è®¾ç½®')
        other_layout = QVBoxLayout(other_group)
        
        # ä¿å­˜æ—¶æ˜¾ç¤ºæç¤º
        self.show_save_prompt_checkbox = QCheckBox('ä¿å­˜æ•°æ®æ—¶æ˜¾ç¤ºæç¤º')
        self.show_save_prompt_checkbox.setChecked(config.get('show_save_prompt', True))
        other_layout.addWidget(self.show_save_prompt_checkbox)
        
        # åˆ é™¤å‰ç¡®è®¤
        self.confirm_delete_checkbox = QCheckBox('åˆ é™¤å‘ç¥¨å‰ç¡®è®¤')
        self.confirm_delete_checkbox.setChecked(config.get('confirm_delete', True))
        other_layout.addWidget(self.confirm_delete_checkbox)
        
        layout.addWidget(other_group)
        
        # ========== AI è®¾ç½® ==========
        ai_group = QGroupBox('AI åˆ†æè®¾ç½®')
        ai_layout = QVBoxLayout(ai_group)
        
        # API Key è¾“å…¥
        api_key_desc = QLabel('DeepSeek API Keyï¼ˆç”¨äº AI å‘ç¥¨åˆ†æå’Œå®¡æ ¸åŠŸèƒ½ï¼‰ï¼š')
        api_key_desc.setWordWrap(True)
        ai_layout.addWidget(api_key_desc)
        
        api_key_layout = QHBoxLayout()
        self.api_key_edit = QLineEdit()
        self.api_key_edit.setPlaceholderText('è¾“å…¥ DeepSeek API Keyï¼Œç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤å€¼')
        self.api_key_edit.setEchoMode(QLineEdit.Password)  # éšè—è¾“å…¥
        
        # åŠ è½½å½“å‰é…ç½®
        current_api_key = config.get('deepseek_api_key', '')
        if current_api_key:
            self.api_key_edit.setText(current_api_key)
        
        api_key_layout.addWidget(self.api_key_edit)
        
        # æ˜¾ç¤º/éšè—å¯†ç æŒ‰é’®
        toggle_password_btn = QPushButton('ğŸ‘')
        toggle_password_btn.setMaximumWidth(40)
        toggle_password_btn.setCheckable(True)
        toggle_password_btn.setToolTip('æ˜¾ç¤º/éšè— API Key')
        toggle_password_btn.toggled.connect(lambda checked: self.api_key_edit.setEchoMode(QLineEdit.Normal if checked else QLineEdit.Password))
        api_key_layout.addWidget(toggle_password_btn)
        
        ai_layout.addLayout(api_key_layout)
        
        # API Key è¯´æ˜
        api_key_hint = QLabel('æç¤ºï¼šå¯åœ¨ https://platform.deepseek.com/ è·å– API Key')
        api_key_hint.setStyleSheet('color: #666; font-size: 9pt;')
        api_key_hint.setWordWrap(True)
        ai_layout.addWidget(api_key_hint)
        
        layout.addWidget(ai_group)
        
        # æ·»åŠ æ‹‰ä¼¸ï¼Œç¡®ä¿å†…å®¹ä»é¡¶éƒ¨å¼€å§‹
        layout.addStretch(1)
        
        # å°†å†…å®¹éƒ¨ä»¶è®¾ç½®åˆ°æ»šåŠ¨åŒºåŸŸ
        scroll_area.setWidget(content_widget)
        
        # å°†æ»šåŠ¨åŒºåŸŸæ·»åŠ åˆ°ä¸»å¸ƒå±€
        main_layout.addWidget(scroll_area)
        
        # æŒ‰é’®åŒºåŸŸï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼Œä¸å‚ä¸æ»šåŠ¨ï¼‰
        button_container = QWidget()
        button_container.setStyleSheet('background-color: #ffffff; border-top: 1px solid #e5e7eb;')
        button_layout = QHBoxLayout(button_container)
        button_layout.setContentsMargins(15, 10, 15, 10)
        button_layout.setSpacing(10)
        button_layout.addStretch(1)
        
        ok_btn = QPushButton('ç¡®å®š')
        ok_btn.setProperty('btnType', 'primary')
        ok_btn.setMinimumWidth(80)
        ok_btn.clicked.connect(self.accept)
        button_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton('å–æ¶ˆ')
        cancel_btn.setMinimumWidth(80)
        cancel_btn.clicked.connect(self.reject)
        button_layout.addWidget(cancel_btn)
        
        # å°†æŒ‰é’®å®¹å™¨æ·»åŠ åˆ°ä¸»å¸ƒå±€
        main_layout.addWidget(button_container)
    
    def browse_tesseract_path(self):
        """æµè§ˆé€‰æ‹© Tesseract å¯æ‰§è¡Œæ–‡ä»¶"""
        current_path = self.tesseract_path_edit.text()
        start_dir = os.path.dirname(current_path) if current_path else ''
        
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é€‰æ‹© Tesseract-OCR å¯æ‰§è¡Œæ–‡ä»¶',
            start_dir,
            'å¯æ‰§è¡Œæ–‡ä»¶ (*.exe);;æ‰€æœ‰æ–‡ä»¶ (*.*)'
        )
        
        if file_path:
            self.tesseract_path_edit.setText(file_path)
    
    def test_tesseract_path(self):
        """æµ‹è¯• Tesseract è·¯å¾„æ˜¯å¦æœ‰æ•ˆ"""
        path = self.tesseract_path_edit.text().strip()
        
        if not path:
            QMessageBox.warning(self, 'æç¤º', 'è¯·è¾“å…¥ Tesseract è·¯å¾„ã€‚')
            return
        
        if not os.path.isfile(path):
            QMessageBox.warning(self, 'è·¯å¾„æ— æ•ˆ', f'æ–‡ä»¶ä¸å­˜åœ¨ï¼š\n{path}')
            return
        
        if not path.lower().endswith('tesseract.exe'):
            QMessageBox.warning(self, 'è·¯å¾„æ— æ•ˆ', 'è¯·é€‰æ‹© tesseract.exe æ–‡ä»¶ã€‚')
            return
        
        # å°è¯•åˆå§‹åŒ–å¹¶æµ‹è¯•
        try:
            old_cmd = pytesseract.pytesseract.tesseract_cmd
            pytesseract.pytesseract.tesseract_cmd = path
            tessdir = os.path.dirname(path)
            old_prefix = os.environ.get("TESSDATA_PREFIX", "")
            os.environ["TESSDATA_PREFIX"] = tessdir
            
            # ç®€å•æµ‹è¯•ï¼šè·å–ç‰ˆæœ¬ä¿¡æ¯
            version = pytesseract.get_tesseract_version()
            
            # æ¢å¤
            pytesseract.pytesseract.tesseract_cmd = old_cmd
            if old_prefix:
                os.environ["TESSDATA_PREFIX"] = old_prefix
            
            QMessageBox.information(
                self,
                'æµ‹è¯•æˆåŠŸ',
                f'Tesseract OCR è·¯å¾„æœ‰æ•ˆï¼\n\nç‰ˆæœ¬ï¼š{version}'
            )
        except Exception as e:
            QMessageBox.warning(
                self,
                'æµ‹è¯•å¤±è´¥',
                f'æ— æ³•ä½¿ç”¨è¯¥è·¯å¾„ï¼š\n{str(e)}\n\nè¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚'
            )
    
    def get_tesseract_path(self):
        """è·å–ç”¨æˆ·è®¾ç½®çš„ Tesseract è·¯å¾„"""
        return self.tesseract_path_edit.text().strip()

    def browse_backup_path(self):
        """æµè§ˆé€‰æ‹©å¤‡ä»½è·¯å¾„"""
        current_path = self.backup_path_edit.text()
        start_dir = current_path if current_path and os.path.exists(current_path) else ''
        
        folder = QFileDialog.getExistingDirectory(
            self,
            'é€‰æ‹©å¤‡ä»½æ–‡ä»¶å¤¹',
            start_dir
        )
        
        if folder:
            self.backup_path_edit.setText(folder)
    
    def browse_export_path(self):
        """æµè§ˆé€‰æ‹©å¯¼å‡ºè·¯å¾„"""
        current_path = self.export_path_edit.text()
        start_dir = current_path if current_path and os.path.exists(current_path) else ''
        
        folder = QFileDialog.getExistingDirectory(
            self,
            'é€‰æ‹©é»˜è®¤å¯¼å‡ºæ–‡ä»¶å¤¹',
            start_dir
        )
        
        if folder:
            self.export_path_edit.setText(folder)
    
    def get_settings(self):
        """ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰å¯é…ç½®é¡¹"""
        return {
            'tesseract_path': self.get_tesseract_path(),
            'ocr_lang': self.ocr_lang_combo.currentData(),
            'auto_load_invoices': self.auto_load_checkbox.isChecked(),
            'match_tolerance': float(self.match_tol_spin.value()),
            # æ•°æ®ç®¡ç†
            'auto_backup': self.auto_backup_checkbox.isChecked(),
            'backup_interval': int(self.backup_interval_spin.value()),
            'backup_path': self.backup_path_edit.text().strip(),
            # å¯¼å‡ºè®¾ç½®
            'export_path': self.export_path_edit.text().strip(),
            'export_include_validation': self.include_validation_checkbox.isChecked(),
            # éªŒè¯è®¾ç½®
            'auto_validate': self.auto_validate_checkbox.isChecked(),
            'validation_strictness': self.validation_strict_combo.currentData(),
            # ç•Œé¢è®¾ç½®
            'list_show_tags': self.show_tags_checkbox.isChecked(),
            'list_show_validation': self.show_validation_checkbox.isChecked(),
            'buyer_expected_name': self.buyer_expected_edit.text().strip(),
            # å…¶ä»–è®¾ç½®
            'show_save_prompt': self.show_save_prompt_checkbox.isChecked(),
            'confirm_delete': self.confirm_delete_checkbox.isChecked(),
            # AI è®¾ç½®
            'deepseek_api_key': self.api_key_edit.text().strip(),
        }


class TagsDialog(QDialog):
    """æ ‡ç­¾ç®¡ç†å¯¹è¯æ¡†"""
    
    def __init__(self, parent=None, current_tags=None):
        super().__init__(parent)
        self.setWindowTitle('ç®¡ç†æ ‡ç­¾')
        self.setModal(True)
        self.setMinimumWidth(400)
        
        self.current_tags = set(current_tags or [])
        
        layout = QVBoxLayout(self)
        layout.setSpacing(15)
        
        # å½“å‰æ ‡ç­¾æ˜¾ç¤º
        current_group = QGroupBox('å½“å‰æ ‡ç­¾')
        current_layout = QVBoxLayout(current_group)
        
        self.tags_list = QListWidget()
        self.tags_list.setMaximumHeight(120)
        self.update_tags_display()
        current_layout.addWidget(self.tags_list)
        
        # åˆ é™¤æŒ‰é’®
        delete_btn = QPushButton('åˆ é™¤é€‰ä¸­æ ‡ç­¾')
        delete_btn.setProperty('btnType', 'danger')
        delete_btn.clicked.connect(self.delete_selected_tag)
        current_layout.addWidget(delete_btn)
        
        layout.addWidget(current_group)
        
        # æ·»åŠ æ ‡ç­¾åŒºåŸŸ
        add_group = QGroupBox('æ·»åŠ æ ‡ç­¾')
        add_layout = QVBoxLayout(add_group)
        
        # å¸¸ç”¨æ ‡ç­¾å¿«é€Ÿæ·»åŠ 
        common_label = QLabel('å¸¸ç”¨æ ‡ç­¾ï¼š')
        add_layout.addWidget(common_label)
        
        common_tags_layout = QHBoxLayout()
        common_tags = ['å·²æœ‰æ”¯ä»˜è®°å½•', 'å·²æŠ¥é”€', 'å¾…å®¡æ ¸', 'é‡è¦', 'å¾…ä»˜æ¬¾']
        for tag in common_tags:
            btn = QPushButton(tag)
            btn.setProperty('btnType', 'ghost')
            btn.clicked.connect(lambda checked, t=tag: self.add_tag(t))
            common_tags_layout.addWidget(btn)
        add_layout.addLayout(common_tags_layout)
        
        # è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥
        custom_layout = QHBoxLayout()
        self.custom_tag_input = QLineEdit()
        self.custom_tag_input.setPlaceholderText('è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾åç§°...')
        self.custom_tag_input.returnPressed.connect(self.add_custom_tag)
        custom_layout.addWidget(QLabel('è‡ªå®šä¹‰æ ‡ç­¾ï¼š'))
        custom_layout.addWidget(self.custom_tag_input)
        
        add_custom_btn = QPushButton('æ·»åŠ ')
        add_custom_btn.setProperty('btnType', 'primary')
        add_custom_btn.clicked.connect(self.add_custom_tag)
        custom_layout.addWidget(add_custom_btn)
        
        add_layout.addLayout(custom_layout)
        layout.addWidget(add_group)
        
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        button_layout.addStretch(1)
        
        ok_btn = QPushButton('ç¡®å®š')
        ok_btn.setProperty('btnType', 'primary')
        ok_btn.clicked.connect(self.accept)
        button_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton('å–æ¶ˆ')
        cancel_btn.clicked.connect(self.reject)
        button_layout.addWidget(cancel_btn)
        
        layout.addLayout(button_layout)
    
    def update_tags_display(self):
        """æ›´æ–°æ ‡ç­¾åˆ—è¡¨æ˜¾ç¤º"""
        self.tags_list.clear()
        for tag in sorted(self.current_tags):
            self.tags_list.addItem(tag)
    
    def add_tag(self, tag):
        """æ·»åŠ æ ‡ç­¾"""
        if tag and tag.strip():
            tag = tag.strip()
            self.current_tags.add(tag)
            self.update_tags_display()
            self.custom_tag_input.clear()
    
    def add_custom_tag(self):
        """æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾"""
        tag = self.custom_tag_input.text().strip()
        if tag:
            self.add_tag(tag)
    
    def delete_selected_tag(self):
        """åˆ é™¤é€‰ä¸­çš„æ ‡ç­¾"""
        current_item = self.tags_list.currentItem()
        if current_item:
            tag = current_item.text()
            self.current_tags.discard(tag)
            self.update_tags_display()
    
    def get_tags(self):
        """è·å–å½“å‰æ ‡ç­¾åˆ—è¡¨"""
        return list(self.current_tags)


class HelpDialog(QDialog):
    """è¯´æ˜å¯¹è¯æ¡† - æ˜¾ç¤ºå…è´£å£°æ˜å’Œå¼€å‘è€…ä¿¡æ¯"""
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle('è¯´æ˜')
        self.setModal(True)
        self.setMinimumWidth(600)
        self.setMinimumHeight(500)
        
        layout = QVBoxLayout(self)
        layout.setSpacing(15)
        
        # ä½¿ç”¨æ ‡ç­¾é¡µç»„ç»‡å†…å®¹
        tab_widget = QTabWidget()
        
        # ========== å¼€å‘è€…ä¿¡æ¯æ ‡ç­¾é¡µ ==========
        dev_tab = QWidget()
        dev_layout = QVBoxLayout(dev_tab)
        dev_layout.setSpacing(15)
        
        # åº”ç”¨ä¿¡æ¯
        app_info_group = QGroupBox('åº”ç”¨ä¿¡æ¯')
        app_info_layout = QVBoxLayout(app_info_group)
        app_info_text = QTextEdit()
        app_info_text.setReadOnly(True)
        app_info_text.setPlainText("""
åº”ç”¨åç§°ï¼šå‘ç¥¨è‡ªåŠ¨ç®¡ç†åˆ†ç±»ç³»ç»Ÿ
ç‰ˆæœ¬ï¼š2.4.3
å¼€å‘è€…ï¼šçŸ³æ®·ç¿
æ‰€å±å•ä½ï¼šè‹å·å¤§å­¦ï¼ˆSoochow Universityï¼‰
ä¸“ä¸šï¼š22EEï¼ˆç”µå­ä¿¡æ¯å·¥ç¨‹ï¼‰

åŠŸèƒ½ç®€ä»‹ï¼š
æœ¬è½¯ä»¶ç”¨äºè¾…åŠ©æ•´ç†å’Œåˆæ­¥è¯†åˆ«å‘ç¥¨ã€è´¦å•ä¿¡æ¯ï¼Œæ–¹ä¾¿è¿›è¡Œåˆ†ç±»ã€ç»Ÿè®¡ä¸ç®€å•æ ¸å¯¹ã€‚
æ”¯æŒPDFå‘ç¥¨å¯¼å…¥ã€OCRè¯†åˆ«ã€å•†å“æ˜ç»†æå–ã€è´­ä¹°è®°å½•åŒ¹é…ç­‰åŠŸèƒ½ã€‚
        """.strip())
        app_info_layout.addWidget(app_info_text)
        dev_layout.addWidget(app_info_group)
        
        # è”ç³»æ–¹å¼
        contact_group = QGroupBox('è”ç³»æ–¹å¼')
        contact_layout = QVBoxLayout(contact_group)
        contact_text = QTextEdit()
        contact_text.setReadOnly(True)
        contact_text.setPlainText("""
é‚®ç®±ï¼šSYRQuartz@gmail.com
ä¸ªäººä¸»é¡µï¼šhttps://quartzsyr.github.io/photograph/
        """.strip())
        contact_layout.addWidget(contact_text)
        dev_layout.addWidget(contact_group)
        
        # æŠ€æœ¯æ ˆ
        tech_group = QGroupBox('æŠ€æœ¯æ ˆ')
        tech_layout = QVBoxLayout(tech_group)
        tech_text = QTextEdit()
        tech_text.setReadOnly(True)
        tech_text.setPlainText("""
å¼€å‘è¯­è¨€ï¼šPython 3
GUIæ¡†æ¶ï¼šPyQt5
PDFå¤„ç†ï¼špdfplumber
OCRè¯†åˆ«ï¼šTesseract-OCR, pytesseract
å›¾åƒå¤„ç†ï¼šPIL, OpenCV
æ•°æ®å¤„ç†ï¼špandas, numpy
å›¾è¡¨ç»˜åˆ¶ï¼šmatplotlib
        """.strip())
        tech_layout.addWidget(tech_text)
        dev_layout.addWidget(tech_group)
        
        tab_widget.addTab(dev_tab, 'å¼€å‘è€…ä¿¡æ¯')
        
        # ========== å…è´£å£°æ˜æ ‡ç­¾é¡µ ==========
        disclaimer_tab = QWidget()
        disclaimer_layout = QVBoxLayout(disclaimer_tab)
        disclaimer_layout.setSpacing(15)
        
        # ä½¿ç”¨è¯´æ˜
        usage_group = QGroupBox('ä½¿ç”¨è¯´æ˜')
        usage_layout = QVBoxLayout(usage_group)
        usage_text = QTextEdit()
        usage_text.setReadOnly(True)
        usage_text.setPlainText("""
ã€ä½¿ç”¨è¯´æ˜ã€‘

1. æœ¬è½¯ä»¶ä»…å¯¹ç¥¨æ®/è´¦å•ä¿¡æ¯è¿›è¡Œåˆæ­¥è¯†åˆ«å’Œæ•´ç†ï¼Œè¯†åˆ«ç»“æœå¯èƒ½å­˜åœ¨é”™è¯¯ã€é—æ¼æˆ–ä¸å®Œæ•´çš„æƒ…å†µã€‚

2. è¯·åŠ¡å¿…å¯¹è½¯ä»¶è¾“å‡ºç»“æœè¿›è¡Œäººå·¥å¤æ ¸ï¼Œä¸è¦å°†è¯†åˆ«ç»“æœä½œä¸ºå”¯ä¸€ä¾æ®è¿›è¡Œè´¢åŠ¡æˆ–æ³•å¾‹å†³ç­–ã€‚

3. å¦‚é‡åˆ°æ˜æ˜¾å¼‚å¸¸ç»“æœï¼Œå»ºè®®é‡æ–°å¯¼å…¥æ•°æ®æˆ–è”ç³»ä½œè€…åé¦ˆã€‚

4. è½¯ä»¶å¯èƒ½å‡ºé”™ï¼Œä»…ä¾›å‚è€ƒï¼Œè¯·åŠ¡å¿…æ³¨æ„è¾¨åˆ«ç»“æœã€‚
        """.strip())
        usage_layout.addWidget(usage_text)
        disclaimer_layout.addWidget(usage_group)
        
        # å…è´£å£°æ˜
        disclaimer_group = QGroupBox('å…è´£å£°æ˜')
        disclaimer_layout_inner = QVBoxLayout(disclaimer_group)
        disclaimer_text = QTextEdit()
        disclaimer_text.setReadOnly(True)
        disclaimer_text.setPlainText("""
ã€å…è´£å£°æ˜ã€‘

1. æœ¬è½¯ä»¶ä»¥"ç°çŠ¶"æä¾›ï¼Œä¸å¯¹åŠŸèƒ½çš„å‡†ç¡®æ€§ã€å®Œæ•´æ€§æˆ–é€‚ç”¨æ€§ä½œå‡ºä»»ä½•æ˜ç¤ºæˆ–é»˜ç¤ºæ‹…ä¿ã€‚

2. å› ä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬è½¯ä»¶æ‰€äº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±ï¼Œç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…ï¼Œä½œè€…ä¸å¯¹ç”±æ­¤é€ æˆçš„åæœæ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚

3. å®‰è£…å’Œä½¿ç”¨æœ¬è½¯ä»¶å³è§†ä¸ºæ‚¨å·²å……åˆ†ç†è§£å¹¶åŒæ„æœ¬å…è´£å£°æ˜çš„å…¨éƒ¨å†…å®¹ã€‚

4. æœ¬è½¯ä»¶ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ï¼Œä¸å¾—ç”¨äºå•†ä¸šç”¨é€”æˆ–ä»»ä½•å¯èƒ½äº§ç”Ÿæ³•å¾‹åæœçš„åœºæ™¯ã€‚

5. ä½œè€…ä¿ç•™éšæ—¶ä¿®æ”¹ã€æ›´æ–°æˆ–ç»ˆæ­¢æœ¬è½¯ä»¶çš„æƒåˆ©ï¼Œæ— éœ€äº‹å…ˆé€šçŸ¥ã€‚

6. å¦‚å› ä½¿ç”¨æœ¬è½¯ä»¶è€Œäº§ç”Ÿçš„ä»»ä½•çº çº·ï¼Œä½¿ç”¨è€…åº”è‡ªè¡Œæ‰¿æ‹…å…¨éƒ¨è´£ä»»ã€‚
        """.strip())
        disclaimer_layout_inner.addWidget(disclaimer_text)
        disclaimer_layout.addWidget(disclaimer_group)
        
        # ç‰ˆæƒä¿¡æ¯
        copyright_group = QGroupBox('ç‰ˆæƒä¿¡æ¯')
        copyright_layout = QVBoxLayout(copyright_group)
        copyright_text = QTextEdit()
        copyright_text.setReadOnly(True)
        copyright_text.setPlainText("""
ç‰ˆæƒæ‰€æœ‰ Â© 2024-2025 çŸ³æ®·ç¿

æœ¬è½¯ä»¶åŠå…¶æºä»£ç å—ç‰ˆæƒæ³•ä¿æŠ¤ã€‚æœªç»æˆæƒï¼Œä¸å¾—å¤åˆ¶ã€ä¿®æ”¹ã€åˆ†å‘æˆ–ç”¨äºå•†ä¸šç›®çš„ã€‚

å¼€æºè®¸å¯ï¼šæœ¬è½¯ä»¶é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œå…è®¸è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘ï¼Œä½†éœ€ä¿ç•™ç‰ˆæƒå£°æ˜ã€‚
        """.strip())
        copyright_layout.addWidget(copyright_text)
        disclaimer_layout.addWidget(copyright_group)
        
        tab_widget.addTab(disclaimer_tab, 'å…è´£å£°æ˜')
        
        layout.addWidget(tab_widget)
        
        # æŒ‰é’®åŒºåŸŸ
        button_layout = QHBoxLayout()
        button_layout.addStretch(1)
        
        ok_btn = QPushButton('ç¡®å®š')
        ok_btn.setProperty('btnType', 'primary')
        ok_btn.clicked.connect(self.accept)
        button_layout.addWidget(ok_btn)
        
        layout.addLayout(button_layout)


class InvoiceManager(QMainWindow):
    """å‘ç¥¨ç®¡ç†ä¸»çª—å£"""

    def __init__(self):
        super().__init__()
        self.invoices = []
        self.parser = InvoiceParser()
        self.match_worker = None
        self.ai_worker = None  # AIå·¥ä½œçº¿ç¨‹
        # åˆå§‹åŒ– AI å®¢æˆ·ç«¯ï¼ˆä»é…ç½®ä¸­è¯»å– API keyï¼‰
        self.init_ai_client()
        self.init_ui()

        # æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦åœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸Šä¸€æ¬¡çš„å‘ç¥¨æ•°æ®
        cfg = load_config()
        if cfg.get('auto_load_invoices', True):
            self.load_invoices()
    
    def init_ai_client(self):
        """åˆå§‹åŒ– AI å®¢æˆ·ç«¯"""
        try:
            cfg = load_config()
            api_key = cfg.get('deepseek_api_key', '')
            # å¦‚æœé…ç½®ä¸­æœ‰ API keyï¼Œä½¿ç”¨é…ç½®çš„ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤å€¼
            if api_key:
                self.ai_client = DeepSeekInvoiceAI(api_key=api_key, mock_mode=False)
            else:
                self.ai_client = DeepSeekInvoiceAI(mock_mode=False)
        except Exception as e:
            print(f"AIå®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼: {e}")
            self.ai_client = DeepSeekInvoiceAI(mock_mode=True)

    def init_ui(self):
        """åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢"""
        self.setWindowTitle('å‘ç¥¨è‡ªåŠ¨ç®¡ç†åˆ†ç±»ç³»ç»Ÿ')
        self.setGeometry(100, 100, 1200, 800)

        # åˆ›å»ºä¸­å¤®éƒ¨ä»¶
        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        # ä¸»å¸ƒå±€
        main_layout = QVBoxLayout(central_widget)

        # ===== é¡¶éƒ¨å¯¼èˆªæ ï¼ˆä»¿ Web é¡¶éƒ¨èœå•ï¼‰ =====
        top_nav = QWidget()
        top_nav.setObjectName('topNav')
        top_nav_layout = QHBoxLayout(top_nav)
        top_nav_layout.setContentsMargins(12, 6, 12, 6)
        top_nav_layout.setSpacing(4)

        self.nav_btn_home = QPushButton('å‘ç¥¨ç®¡ç†')
        self.nav_btn_home.setObjectName('topNavButton')
        self.nav_btn_home.setCheckable(True)
        self.nav_btn_home.setChecked(True)
        self.nav_btn_home.clicked.connect(lambda: self.on_top_nav_clicked(self.nav_btn_home))
        top_nav_layout.addWidget(self.nav_btn_home)

        self.nav_btn_stats = QPushButton('ç»Ÿè®¡åˆ†æ')
        self.nav_btn_stats.setObjectName('topNavButton')
        self.nav_btn_stats.setCheckable(True)
        self.nav_btn_stats.setChecked(False)
        self.nav_btn_stats.clicked.connect(lambda: self.on_top_nav_clicked(self.nav_btn_stats))
        top_nav_layout.addWidget(self.nav_btn_stats)

        top_nav_layout.addStretch(1)

        # è¯´æ˜æŒ‰é’®
        self.help_btn = QPushButton('ğŸ“– è¯´æ˜')
        self.help_btn.setObjectName('topNavButton')
        self.help_btn.clicked.connect(self.show_help_info)
        top_nav_layout.addWidget(self.help_btn)

        # è®¾ç½®æŒ‰é’®
        self.settings_btn = QPushButton('âš™ è®¾ç½®')
        self.settings_btn.setObjectName('topNavButton')
        self.settings_btn.clicked.connect(self.open_settings)
        top_nav_layout.addWidget(self.settings_btn)

        # é¡¶éƒ¨å³ä¾§å¼€å‘è€…ä¿¡æ¯ï¼ˆå«è”ç³»æ–¹å¼ä¸ç‰ˆæƒï¼‰
        self.dev_info_label = QLabel('Quartz Â· Soochow U Â· 22EE  |  è”ç³»æ–¹å¼: SYRQuartz@gmail.com  |  ç‰ˆæƒæ‰€æœ‰')
        self.dev_info_label.setObjectName('devInfo')
        top_nav_layout.addWidget(self.dev_info_label)

        main_layout.addWidget(top_nav)

        # ===== ä¸­é—´å†…å®¹åŒºï¼šä½¿ç”¨ QStackedWidget ç®¡ç†å¤šä¸ªé¡µé¢ =====
        self.content_stack = QStackedWidget()
        main_layout.addWidget(self.content_stack)

        # ---------- é¡µé¢ 1ï¼šå‘ç¥¨ç®¡ç†ä¸»é¡µ ----------
        self.page_home = QWidget()
        home_layout = QVBoxLayout(self.page_home)

        # é¡¶éƒ¨æ•´ä½“åŒºåŸŸï¼ˆæ ‡é¢˜ + æŒ‰é’® + æ±‡æ€»ä¿¡æ¯ï¼‰
        top_container = QVBoxLayout()
        top_container.setSpacing(6)

        # é¡¶éƒ¨ç¬¬ä¸€è¡Œï¼šåº”ç”¨æ ‡é¢˜ + å³ä¾§æ±‡æ€»ä¿¡æ¯
        header_layout = QHBoxLayout()

        title_label = QLabel('å‘ç¥¨è‡ªåŠ¨ç®¡ç†åˆ†ç±»ç³»ç»Ÿ')
        title_label.setObjectName('appTitle')
        header_layout.addWidget(title_label)
        header_layout.addStretch(1)

        # å³ä¾§æ±‡æ€»ä¿¡æ¯ï¼šæ€»é‡‘é¢ + å‘ç¥¨æ•°é‡
        summary_layout = QVBoxLayout()
        summary_layout.setAlignment(Qt.AlignRight | Qt.AlignVCenter)

        self.total_label = QLabel('æ€»é‡‘é¢ï¼šÂ¥0.00')
        self.total_label.setObjectName('summaryLabel')
        summary_layout.addWidget(self.total_label)

        self.count_label = QLabel('å…± 0 å¼ å‘ç¥¨')
        self.count_label.setObjectName('summaryLabel')
        summary_layout.addWidget(self.count_label)

        summary_container = QWidget()
        summary_container.setLayout(summary_layout)
        header_layout.addWidget(summary_container)

        top_container.addLayout(header_layout)

        # é¡¶éƒ¨ç¬¬äºŒè¡Œï¼šæ“ä½œæŒ‰é’®è¡Œ
        toolbar_layout = QHBoxLayout()
        toolbar_layout.setSpacing(10)

        self.import_btn = QPushButton('æ‰¹é‡å¯¼å…¥å‘ç¥¨')
        # ä¸»æ“ä½œæŒ‰é’®ï¼šæ‰¹é‡å¯¼å…¥
        self.import_btn.setProperty('btnType', 'primary')
        self.import_btn.clicked.connect(self.import_invoices)
        toolbar_layout.addWidget(self.import_btn)

        self.export_btn = QPushButton('å¯¼å‡ºè´¦å•')
        # æ¬¡çº§ä¸»æŒ‰é’®ï¼šå¯¼å‡º
        self.export_btn.setProperty('btnType', 'primary')
        self.export_btn.clicked.connect(self.export_bill)
        self.export_btn.setEnabled(False)
        toolbar_layout.addWidget(self.export_btn)

        self.clear_btn = QPushButton('æ¸…ç©ºæ•°æ®')
        # å±é™©æ“ä½œæŒ‰é’®ï¼šæ¸…ç©ºæ•°æ®
        self.clear_btn.setProperty('btnType', 'danger')
        self.clear_btn.clicked.connect(self.clear_data)
        toolbar_layout.addWidget(self.clear_btn)

        # è´­ä¹°è®°å½•åŒ¹é…æŒ‰é’®ï¼šæ‰¹é‡ OCR è¯†åˆ«å®ä»˜é‡‘é¢å¹¶ä¸å‘ç¥¨åŒ¹é…åé‡å‘½å
        self.match_records_btn = QPushButton('åŒ¹é…è´­ä¹°è®°å½•å¹¶é‡å‘½å')
        self.match_records_btn.setProperty('btnType', 'ghost')
        self.match_records_btn.clicked.connect(self.match_purchase_records)
        toolbar_layout.addWidget(self.match_records_btn)

        # æŠŠæŒ‰é’®æ•´ä½“é å·¦ï¼Œå³ä¾§ç•™ç©º
        toolbar_layout.addStretch(1)

        top_container.addLayout(toolbar_layout)

        home_layout.addLayout(top_container)

        # åˆ›å»ºåˆ†å‰²å™¨
        splitter = QSplitter(Qt.Horizontal)

        # å·¦ä¾§é¢æ¿ - å‘ç¥¨åˆ—è¡¨
        left_panel = QWidget()
        left_layout = QVBoxLayout(left_panel)

        left_layout.addWidget(QLabel('å‘ç¥¨åˆ—è¡¨'))
        
        # æ·»åŠ æœç´¢æ¡†
        search_layout = QHBoxLayout()
        search_label = QLabel('ğŸ”')
        search_label.setMaximumWidth(30)
        search_layout.addWidget(search_label)
        
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText('æœç´¢å‘ç¥¨ï¼ˆå‘ç¥¨å·ã€é”€å”®æ–¹ã€æ–‡ä»¶åã€æ ‡ç­¾ç­‰ï¼‰')
        self.search_input.textChanged.connect(self.on_search_text_changed)
        search_layout.addWidget(self.search_input)
        
        # æ¸…é™¤æœç´¢æŒ‰é’®
        self.clear_search_btn = QPushButton('âœ•')
        self.clear_search_btn.setMaximumWidth(30)
        self.clear_search_btn.setToolTip('æ¸…é™¤æœç´¢')
        self.clear_search_btn.clicked.connect(self.clear_search)
        self.clear_search_btn.setVisible(False)
        search_layout.addWidget(self.clear_search_btn)
        
        left_layout.addLayout(search_layout)

        self.invoice_list = QListWidget()
        self.invoice_list.itemClicked.connect(self.show_invoice_details)
        left_layout.addWidget(self.invoice_list)
        
        # å­˜å‚¨è¿‡æ»¤åçš„å‘ç¥¨ç´¢å¼•æ˜ å°„ï¼ˆç”¨äºç‚¹å‡»æ—¶å®šä½åˆ°åŸå§‹åˆ—è¡¨ï¼‰
        self.filtered_invoice_indices = []

        splitter.addWidget(left_panel)
        
        # å³ä¾§é¢æ¿ - ä»…è¯¦æƒ… + ç¼–è¾‘ï¼ˆå·²å»æ‰é¢„è§ˆåŒºï¼‰
        right_panel = QWidget()
        right_layout = QVBoxLayout(right_panel)
        
        # å‘ç¥¨è¯¦æƒ…
        detail_group = QGroupBox('å‘ç¥¨è¯¦æƒ…')
        detail_layout = QVBoxLayout(detail_group)

        self.detail_text = QTextEdit()
        self.detail_text.setReadOnly(True)
        self.detail_text.setStyleSheet("background-color: #fcfcfc;")
        # è®¾ç½®å›ºå®šé«˜åº¦ï¼Œé¿å…å ç”¨è¿‡å¤šç©ºé—´ï¼Œä¸ºå•†å“æ˜ç»†ç•™å‡ºç©ºé—´
        self.detail_text.setMaximumHeight(140)
        self.detail_text.setMinimumHeight(100)
        detail_layout.addWidget(self.detail_text)

        # æ–‡ä»¶ç®¡ç†æŒ‰é’®ç»„ï¼ˆä¸¤è¡Œå¸ƒå±€ï¼Œç¡®ä¿æ‰€æœ‰æŒ‰é’®éƒ½èƒ½æ˜¾ç¤ºï¼‰
        file_management_container = QWidget()
        file_management_layout = QVBoxLayout(file_management_container)
        file_management_layout.setContentsMargins(0, 0, 0, 0)
        file_management_layout.setSpacing(6)
        
        # ç¬¬ä¸€è¡Œï¼šå‰3ä¸ªæŒ‰é’®
        row1_layout = QHBoxLayout()
        row1_layout.setSpacing(6)
        
        self.open_file_btn = QPushButton('ğŸ“„ æ‰“å¼€æ–‡ä»¶')
        self.open_file_btn.setProperty('btnType', 'ghost')
        self.open_file_btn.clicked.connect(self.open_invoice_file)
        self.open_file_btn.setEnabled(False)
        row1_layout.addWidget(self.open_file_btn)
        
        self.show_in_explorer_btn = QPushButton('ğŸ“ åœ¨æ–‡ä»¶å¤¹ä¸­æ˜¾ç¤º')
        self.show_in_explorer_btn.setProperty('btnType', 'ghost')
        self.show_in_explorer_btn.clicked.connect(self.show_file_in_explorer)
        self.show_in_explorer_btn.setEnabled(False)
        row1_layout.addWidget(self.show_in_explorer_btn)
        
        self.copy_path_btn = QPushButton('ğŸ“‹ å¤åˆ¶è·¯å¾„')
        self.copy_path_btn.setProperty('btnType', 'ghost')
        self.copy_path_btn.clicked.connect(self.copy_file_path)
        self.copy_path_btn.setEnabled(False)
        row1_layout.addWidget(self.copy_path_btn)
        
        row1_layout.addStretch(1)
        file_management_layout.addLayout(row1_layout)
        
        # ç¬¬äºŒè¡Œï¼šå2ä¸ªæŒ‰é’®
        row2_layout = QHBoxLayout()
        row2_layout.setSpacing(6)
        
        self.relink_file_btn = QPushButton('ğŸ”— é‡æ–°å…³è”')
        self.relink_file_btn.setProperty('btnType', 'ghost')
        self.relink_file_btn.clicked.connect(self.relink_invoice_file)
        self.relink_file_btn.setEnabled(False)
        row2_layout.addWidget(self.relink_file_btn)
        
        self.copy_file_btn = QPushButton('ğŸ“¦ å¤åˆ¶æ–‡ä»¶')
        self.copy_file_btn.setProperty('btnType', 'ghost')
        self.copy_file_btn.clicked.connect(self.copy_invoice_file)
        self.copy_file_btn.setEnabled(False)
        row2_layout.addWidget(self.copy_file_btn)
        
        row2_layout.addStretch(1)
        file_management_layout.addLayout(row2_layout)
        
        detail_layout.addWidget(file_management_container)
        
        # æ ‡ç­¾ç®¡ç†å’ŒéªŒè¯æŒ‰é’®
        tags_layout = QHBoxLayout()
        self.manage_tags_btn = QPushButton('ğŸ·ï¸ ç®¡ç†æ ‡ç­¾')
        self.manage_tags_btn.setProperty('btnType', 'ghost')
        self.manage_tags_btn.clicked.connect(self.manage_invoice_tags)
        self.manage_tags_btn.setEnabled(False)
        tags_layout.addWidget(self.manage_tags_btn)
        
        self.validate_btn = QPushButton('âœ“ éªŒè¯å‘ç¥¨')
        self.validate_btn.setProperty('btnType', 'ghost')
        self.validate_btn.clicked.connect(self.validate_current_invoice)
        self.validate_btn.setEnabled(False)
        tags_layout.addWidget(self.validate_btn)
        
        tags_layout.addStretch(1)
        detail_layout.addLayout(tags_layout)
        
        # AI åˆ†ææŒ‰é’®ç»„
        ai_layout = QHBoxLayout()
        self.ai_analyze_btn = QPushButton('ğŸ¤– AIåˆ†æ')
        self.ai_analyze_btn.setProperty('btnType', 'ghost')
        self.ai_analyze_btn.clicked.connect(self.ai_analyze_invoice)
        self.ai_analyze_btn.setEnabled(False)
        self.ai_analyze_btn.setToolTip('ä½¿ç”¨AIåˆ†æå‘ç¥¨æ•°æ®')
        ai_layout.addWidget(self.ai_analyze_btn)
        
        self.ai_suggest_btn = QPushButton('ğŸ’¡ AIå»ºè®®')
        self.ai_suggest_btn.setProperty('btnType', 'ghost')
        self.ai_suggest_btn.clicked.connect(self.ai_suggest_invoice)
        self.ai_suggest_btn.setEnabled(False)
        self.ai_suggest_btn.setToolTip('è·å–AIæ ‡ç­¾å’Œæ“ä½œå»ºè®®')
        ai_layout.addWidget(self.ai_suggest_btn)
        
        self.ai_review_btn = QPushButton('ğŸ” AIå®¡æ ¸')
        self.ai_review_btn.setProperty('btnType', 'ghost')
        self.ai_review_btn.clicked.connect(self.ai_review_invoice)
        self.ai_review_btn.setEnabled(False)
        self.ai_review_btn.setToolTip('ä½¿ç”¨AIå®¡æ ¸å‘ç¥¨ä¿¡æ¯')
        ai_layout.addWidget(self.ai_review_btn)
        
        ai_layout.addStretch(1)
        detail_layout.addLayout(ai_layout)
        
        right_layout.addWidget(detail_group)

        # å•†å“æ˜ç»†è¡¨æ ¼
        table_group = QGroupBox('å•†å“æ˜ç»†')
        table_layout = QVBoxLayout(table_group)

        self.items_table = QTableWidget()
        self.items_table.setColumnCount(6)
        self.items_table.setHorizontalHeaderLabels(['åˆ†ç±»', 'å•†å“åç§°', 'æ•°é‡', 'å•ä»·', 'é‡‘é¢', 'è§„æ ¼'])
        # è¡¨æ ¼å¤–è§‚ä¼˜åŒ–
        self.items_table.setAlternatingRowColors(True)
        self.items_table.setStyleSheet(
            "QTableWidget { gridline-color: #dddddd; }"
            "QHeaderView::section { background-color: #f0f0f0; font-weight: bold; }"
        )
        self.items_table.horizontalHeader().setStretchLastSection(True)
        self.items_table.cellChanged.connect(self.on_item_changed)
        # è®¾ç½®è¡¨æ ¼æœ€å°é«˜åº¦ï¼Œç¡®ä¿å•†å“æ˜ç»†åŒºåŸŸå¯è§
        self.items_table.setMinimumHeight(150)
        table_layout.addWidget(self.items_table)

        # ç¼–è¾‘æŒ‰é’®
        edit_layout = QHBoxLayout()
        self.edit_category_btn = QPushButton('ä¿®æ”¹åˆ†ç±»')
        self.edit_category_btn.setProperty('btnType', 'ghost')
        self.edit_category_btn.clicked.connect(self.edit_category)
        edit_layout.addWidget(self.edit_category_btn)

        self.add_item_btn = QPushButton('æ·»åŠ å•†å“')
        self.add_item_btn.setProperty('btnType', 'primary')
        self.add_item_btn.clicked.connect(self.add_item)
        edit_layout.addWidget(self.add_item_btn)

        self.delete_item_btn = QPushButton('åˆ é™¤å•†å“')
        self.delete_item_btn.setProperty('btnType', 'danger')
        self.delete_item_btn.clicked.connect(self.delete_item)
        edit_layout.addWidget(self.delete_item_btn)

        table_layout.addLayout(edit_layout)
        # å°†å•†å“æ˜ç»†è¡¨æ ¼æ·»åŠ åˆ°å¸ƒå±€ï¼Œå¹¶è®¾ç½®æ‹‰ä¼¸å› å­ï¼Œç¡®ä¿å®ƒèƒ½å ç”¨å‰©ä½™ç©ºé—´
        right_layout.addWidget(table_group, stretch=2)  # ç»™å•†å“æ˜ç»†æ›´å¤§çš„æƒé‡ï¼Œç¡®ä¿å¯è§

        splitter.addWidget(right_panel)
        splitter.setSizes([400, 800])

        home_layout.addWidget(splitter)

        # è¿›åº¦æ¡
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        home_layout.addWidget(self.progress_bar)

        # å°†ä¸»é¡µåŠ å…¥æ ˆ
        self.content_stack.addWidget(self.page_home)

        # ---------- é¡µé¢ 2ï¼šç»Ÿè®¡åˆ†æ ----------
        self.page_stats = QWidget()
        stats_layout = QVBoxLayout(self.page_stats)
        
        # ä½¿ç”¨æ»šåŠ¨åŒºåŸŸï¼Œæ”¯æŒå¤šä¸ªç»Ÿè®¡è¡¨æ ¼
        stats_scroll = QScrollArea()
        stats_scroll.setWidgetResizable(True)
        stats_scroll_content = QWidget()
        stats_scroll_layout = QVBoxLayout(stats_scroll_content)
        stats_scroll_layout.setSpacing(15)

        # ========== ç»Ÿè®¡æ€»è§ˆ ==========
        stats_group = QGroupBox('ç»Ÿè®¡æ€»è§ˆ')
        stats_group_layout = QVBoxLayout(stats_group)
        stats_group_layout.setSpacing(10)

        # åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯
        summary_header_layout = QHBoxLayout()
        self.stats_summary_label = QLabel('å…± 0 å¼ å‘ç¥¨ï¼Œåˆè®¡é‡‘é¢ Â¥0.00')
        self.stats_summary_label.setStyleSheet('font-size: 14pt; font-weight: bold;')
        summary_header_layout.addWidget(self.stats_summary_label)
        summary_header_layout.addStretch(1)
        
        # AIæ•´ä½“åˆ†ææŒ‰é’®
        self.ai_analyze_all_btn = QPushButton('ğŸ¤– AIæ•´ä½“åˆ†æ')
        self.ai_analyze_all_btn.setProperty('btnType', 'primary')
        self.ai_analyze_all_btn.clicked.connect(self.ai_analyze_all_invoices)
        self.ai_analyze_all_btn.setEnabled(False)
        self.ai_analyze_all_btn.setToolTip('ä½¿ç”¨AIåˆ†ææ‰€æœ‰å‘ç¥¨æ•°æ®')
        summary_header_layout.addWidget(self.ai_analyze_all_btn)
        
        stats_group_layout.addLayout(summary_header_layout)
        
        # è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
        detail_stats_layout = QHBoxLayout()
        detail_stats_layout.setSpacing(20)
        
        self.stats_detail_label = QLabel('')
        self.stats_detail_label.setWordWrap(True)
        detail_stats_layout.addWidget(self.stats_detail_label)
        
        stats_group_layout.addLayout(detail_stats_layout)
        stats_scroll_layout.addWidget(stats_group)

        # ========== æŒ‰é”€å”®æ–¹ç»Ÿè®¡ ==========
        stats_seller_group = QGroupBox('æŒ‰é”€å”®æ–¹ç»Ÿè®¡')
        seller_layout = QVBoxLayout(stats_seller_group)

        self.stats_seller_table = QTableWidget()
        self.stats_seller_table.setColumnCount(4)
        self.stats_seller_table.setHorizontalHeaderLabels(['é”€å”®æ–¹', 'å‘ç¥¨æ•°é‡', 'åˆè®¡é‡‘é¢', 'å æ¯”'])
        self.stats_seller_table.horizontalHeader().setStretchLastSection(True)
        self.stats_seller_table.setAlternatingRowColors(True)
        seller_layout.addWidget(self.stats_seller_table)

        # é”€å”®æ–¹å›¾è¡¨
        seller_chart_layout = QHBoxLayout()
        self.seller_chart_canvas = self.create_pie_chart_canvas()
        seller_chart_layout.addWidget(self.seller_chart_canvas)
        seller_layout.addLayout(seller_chart_layout)
        
        stats_scroll_layout.addWidget(stats_seller_group)
        
        # ========== æŒ‰åˆ†ç±»ç»Ÿè®¡ ==========
        stats_category_group = QGroupBox('æŒ‰å•†å“åˆ†ç±»ç»Ÿè®¡')
        category_layout = QVBoxLayout(stats_category_group)
        
        self.stats_category_table = QTableWidget()
        self.stats_category_table.setColumnCount(4)
        self.stats_category_table.setHorizontalHeaderLabels(['åˆ†ç±»', 'å•†å“æ•°é‡', 'åˆè®¡é‡‘é¢', 'å æ¯”'])
        self.stats_category_table.horizontalHeader().setStretchLastSection(True)
        self.stats_category_table.setAlternatingRowColors(True)
        category_layout.addWidget(self.stats_category_table)
        
        # åˆ†ç±»å›¾è¡¨
        category_chart_layout = QHBoxLayout()
        self.category_chart_canvas = self.create_pie_chart_canvas()
        category_chart_layout.addWidget(self.category_chart_canvas)
        category_layout.addLayout(category_chart_layout)
        
        stats_scroll_layout.addWidget(stats_category_group)
        
        # ========== æŒ‰æ—¥æœŸç»Ÿè®¡ ==========
        stats_date_group = QGroupBox('æŒ‰æ—¥æœŸç»Ÿè®¡')
        date_layout = QVBoxLayout(stats_date_group)
        
        # æ—¥æœŸç»Ÿè®¡é€‰é¡¹
        date_options_layout = QHBoxLayout()
        date_options_layout.addWidget(QLabel('ç»Ÿè®¡ç»´åº¦ï¼š'))
        self.date_stats_type_combo = QComboBox()
        self.date_stats_type_combo.addItem('æŒ‰æœˆç»Ÿè®¡', 'month')
        self.date_stats_type_combo.addItem('æŒ‰å¹´ç»Ÿè®¡', 'year')
        self.date_stats_type_combo.addItem('æŒ‰æ—¥ç»Ÿè®¡', 'day')
        self.date_stats_type_combo.currentIndexChanged.connect(self.update_stats_view)
        date_options_layout.addWidget(self.date_stats_type_combo)
        date_options_layout.addStretch(1)
        date_layout.addLayout(date_options_layout)
        
        self.stats_date_table = QTableWidget()
        self.stats_date_table.setColumnCount(4)
        self.stats_date_table.setHorizontalHeaderLabels(['æ—¥æœŸ', 'å‘ç¥¨æ•°é‡', 'åˆè®¡é‡‘é¢', 'å æ¯”'])
        self.stats_date_table.horizontalHeader().setStretchLastSection(True)
        self.stats_date_table.setAlternatingRowColors(True)
        date_layout.addWidget(self.stats_date_table)
        
        # æ—¥æœŸè¶‹åŠ¿å›¾è¡¨
        date_chart_layout = QHBoxLayout()
        self.date_chart_canvas = self.create_bar_chart_canvas()
        date_chart_layout.addWidget(self.date_chart_canvas)
        date_layout.addLayout(date_chart_layout)
        
        stats_scroll_layout.addWidget(stats_date_group)
        
        # ========== æŒ‰æ ‡ç­¾ç»Ÿè®¡ ==========
        stats_tag_group = QGroupBox('æŒ‰æ ‡ç­¾ç»Ÿè®¡')
        tag_layout = QVBoxLayout(stats_tag_group)
        
        self.stats_tag_table = QTableWidget()
        self.stats_tag_table.setColumnCount(4)
        self.stats_tag_table.setHorizontalHeaderLabels(['æ ‡ç­¾', 'å‘ç¥¨æ•°é‡', 'åˆè®¡é‡‘é¢', 'å æ¯”'])
        self.stats_tag_table.horizontalHeader().setStretchLastSection(True)
        self.stats_tag_table.setAlternatingRowColors(True)
        tag_layout.addWidget(self.stats_tag_table)
        
        stats_scroll_layout.addWidget(stats_tag_group)
        
        # ========== éªŒè¯çŠ¶æ€ç»Ÿè®¡ ==========
        stats_validation_group = QGroupBox('éªŒè¯çŠ¶æ€ç»Ÿè®¡')
        validation_layout = QVBoxLayout(stats_validation_group)
        
        self.stats_validation_table = QTableWidget()
        self.stats_validation_table.setColumnCount(3)
        self.stats_validation_table.setHorizontalHeaderLabels(['éªŒè¯çŠ¶æ€', 'å‘ç¥¨æ•°é‡', 'åˆè®¡é‡‘é¢'])
        self.stats_validation_table.horizontalHeader().setStretchLastSection(True)
        self.stats_validation_table.setAlternatingRowColors(True)
        validation_layout.addWidget(self.stats_validation_table)
        
        stats_scroll_layout.addWidget(stats_validation_group)
        
        # è®¾ç½®æ»šåŠ¨åŒºåŸŸå†…å®¹
        stats_scroll.setWidget(stats_scroll_content)
        stats_layout.addWidget(stats_scroll)

        self.content_stack.addWidget(self.page_stats)

        # çŠ¶æ€æ 
        self.status_bar = self.statusBar()
        self.status_bar.showMessage('å°±ç»ª')
    
    def create_pie_chart_canvas(self):
        """åˆ›å»ºé¥¼å›¾ç”»å¸ƒ"""
        fig = Figure(figsize=(6, 4))
        canvas = FigureCanvas(fig)
        canvas.setMinimumHeight(300)
        return canvas
    
    def create_bar_chart_canvas(self):
        """åˆ›å»ºæŸ±çŠ¶å›¾ç”»å¸ƒ"""
        fig = Figure(figsize=(8, 4))
        canvas = FigureCanvas(fig)
        canvas.setMinimumHeight(300)
        return canvas
    
    def update_pie_chart(self, canvas, data_dict, title, total_amount):
        """æ›´æ–°é¥¼å›¾"""
        if not data_dict or total_amount == 0:
            canvas.figure.clear()
            ax = canvas.figure.add_subplot(111)
            ax.text(0.5, 0.5, 'æš‚æ— æ•°æ®', ha='center', va='center', fontsize=14)
            ax.axis('off')
            canvas.draw()
            return
        
        # åªæ˜¾ç¤ºå‰10ä¸ªæœ€å¤§çš„é¡¹ç›®ï¼Œå…¶ä»–åˆå¹¶ä¸º"å…¶ä»–"
        sorted_items = sorted(data_dict.items(), key=lambda x: x[1]['amount'], reverse=True)
        if len(sorted_items) > 10:
            top_items = sorted_items[:9]
            other_amount = sum(item[1]['amount'] for item in sorted_items[9:])
            other_count = sum(item[1]['count'] for item in sorted_items[9:])
            if other_amount > 0:
                top_items.append(('å…¶ä»–', {'amount': other_amount, 'count': other_count}))
            sorted_items = top_items
        
        labels = [item[0] for item in sorted_items]
        amounts = [item[1]['amount'] for item in sorted_items]
        colors = plt.cm.Set3(range(len(labels)))
        
        canvas.figure.clear()
        ax = canvas.figure.add_subplot(111)
        
        # åˆ›å»ºé¥¼å›¾ï¼Œç¡®ä¿ä¸­æ–‡æ ‡ç­¾æ­£ç¡®æ˜¾ç¤º
        wedges, texts, autotexts = ax.pie(
            amounts,
            labels=labels,
            autopct=lambda pct: f'{pct:.1f}%',
            startangle=90,
            colors=colors,
            textprops={'fontsize': 9}
        )
        
        # è°ƒæ•´æ ‡ç­¾ä½ç½®å’Œæ ·å¼ï¼Œç¡®ä¿ä¸­æ–‡æ˜¾ç¤º
        for text in texts:
            text.set_fontsize(9)
            # å¦‚æœæ ‡ç­¾å¤ªé•¿ï¼Œæˆªæ–­å¹¶æ·»åŠ çœç•¥å·
            label_text = text.get_text()
            if len(label_text) > 10:
                text.set_text(label_text[:9] + '...')
        
        # è°ƒæ•´ç™¾åˆ†æ¯”æ–‡æœ¬
        for autotext in autotexts:
            autotext.set_color('white')
            autotext.set_fontweight('bold')
            autotext.set_fontsize(9)
        
        ax.set_title(title, fontsize=12, fontweight='bold', pad=10)
        canvas.draw()
    
    def update_bar_chart(self, canvas, data_dict, title, xlabel='æ—¥æœŸ', ylabel='é‡‘é¢ï¼ˆå…ƒï¼‰'):
        """æ›´æ–°æŸ±çŠ¶å›¾"""
        if not data_dict:
            canvas.figure.clear()
            ax = canvas.figure.add_subplot(111)
            ax.text(0.5, 0.5, 'æš‚æ— æ•°æ®', ha='center', va='center', fontsize=14)
            ax.axis('off')
            canvas.draw()
            return
        
        # æŒ‰æ—¥æœŸæ’åº
        sorted_items = sorted(data_dict.items(), key=lambda x: x[0])
        
        # é™åˆ¶æ˜¾ç¤ºæ•°é‡ï¼Œé¿å…å›¾è¡¨è¿‡äºæ‹¥æŒ¤
        if len(sorted_items) > 20:
            sorted_items = sorted_items[-20:]  # åªæ˜¾ç¤ºæœ€è¿‘20ä¸ª
        
        dates = [item[0] for item in sorted_items]
        amounts = [item[1]['amount'] for item in sorted_items]
        
        canvas.figure.clear()
        ax = canvas.figure.add_subplot(111)
        
        # åˆ›å»ºæŸ±çŠ¶å›¾
        bars = ax.bar(range(len(dates)), amounts, color='#2563eb', alpha=0.7, edgecolor='#1e40af', linewidth=1)
        
        # è®¾ç½®xè½´æ ‡ç­¾ï¼Œç¡®ä¿ä¸­æ–‡æ­£ç¡®æ˜¾ç¤º
        ax.set_xticks(range(len(dates)))
        ax.set_xticklabels(dates, rotation=45, ha='right', fontsize=8)
        
        # è®¾ç½®æ ‡é¢˜å’Œæ ‡ç­¾ï¼Œç¡®ä¿ä¸­æ–‡æ­£ç¡®æ˜¾ç¤º
        ax.set_title(title, fontsize=12, fontweight='bold', pad=10)
        ax.set_xlabel(xlabel, fontsize=10)
        ax.set_ylabel(ylabel, fontsize=10)
        
        # æ·»åŠ ç½‘æ ¼
        ax.grid(True, alpha=0.3, axis='y')
        
        # åœ¨æŸ±å­ä¸Šæ˜¾ç¤ºæ•°å€¼ï¼ˆå¦‚æœç©ºé—´è¶³å¤Ÿï¼‰
        if len(dates) <= 15:
            for i, (bar, amount) in enumerate(zip(bars, amounts)):
                height = bar.get_height()
                ax.text(bar.get_x() + bar.get_width()/2., height,
                       f'Â¥{amount:.0f}',
                       ha='center', va='bottom', fontsize=7)
        
        # è°ƒæ•´å¸ƒå±€
        canvas.figure.tight_layout()
        canvas.draw()

    def import_invoices(self):
        """æ‰¹é‡å¯¼å…¥å‘ç¥¨"""
        files, _ = QFileDialog.getOpenFileNames(
            self, 'é€‰æ‹©å‘ç¥¨æ–‡ä»¶', '', 'PDFæ–‡ä»¶ (*.pdf);;æ‰€æœ‰æ–‡ä»¶ (*.*)'
        )

        if not files:
            return

        self.progress_bar.setVisible(True)
        self.progress_bar.setValue(0)
        self.status_bar.showMessage('æ­£åœ¨å¤„ç†å‘ç¥¨...')

        # ç¦ç”¨å¯¼å…¥æŒ‰é’®
        self.import_btn.setEnabled(False)

        # åˆ›å»ºå¤„ç†çº¿ç¨‹
        self.processor = InvoiceProcessor(files)
        self.processor.progress.connect(self.update_progress)
        self.processor.finished.connect(self.on_import_finished)
        self.processor.error.connect(self.on_import_error)
        self.processor.start()

    def update_progress(self, value):
        """æ›´æ–°è¿›åº¦æ¡"""
        self.progress_bar.setValue(value)

    def on_import_finished(self, invoices):
        """å¯¼å…¥å®Œæˆ"""
        added_count = 0
        duplicate_count = 0
        validation_errors = []
        validation_warnings = []

        for inv in invoices:
            if self._is_duplicate_invoice(inv):
                duplicate_count += 1
                continue
            
            # è‡ªåŠ¨éªŒè¯å‘ç¥¨
            validation_result = self.parser.validate_invoice(inv, self.invoices)
            inv['validation'] = validation_result
            
            # ç»Ÿè®¡éªŒè¯é—®é¢˜
            if validation_result['errors']:
                validation_errors.append({
                    'invoice': inv.get('invoice_number', 'æœªçŸ¥'),
                    'errors': validation_result['errors']
                })
            if validation_result['warnings']:
                validation_warnings.append({
                    'invoice': inv.get('invoice_number', 'æœªçŸ¥'),
                    'warnings': validation_result['warnings']
                })
            
            self.invoices.append(inv)
            added_count += 1

        # æ›´æ–°ç•Œé¢
        self.update_invoice_list()
        self.update_total_label()
        self.update_stats_view()
        self.progress_bar.setVisible(False)
        self.import_btn.setEnabled(True)
        self.export_btn.setEnabled(bool(self.invoices))

        # æ„å»ºæç¤ºä¿¡æ¯
        msg_parts = [f'æˆåŠŸå¯¼å…¥ {added_count} å¼ å‘ç¥¨']
        
        if duplicate_count > 0:
            msg_parts.append(f'è·³è¿‡é‡å¤å‘ç¥¨ {duplicate_count} å¼ ')
        
        if validation_errors:
            error_count = len(validation_errors)
            msg_parts.append(f'å‘ç° {error_count} å¼ å‘ç¥¨æœ‰é”™è¯¯')
        
        if validation_warnings:
            warning_count = len(validation_warnings)
            msg_parts.append(f'å‘ç° {warning_count} å¼ å‘ç¥¨æœ‰è­¦å‘Š')
        
        self.status_bar.showMessage(' | '.join(msg_parts))
        
        # æ˜¾ç¤ºè¯¦ç»†éªŒè¯ç»“æœ
        if validation_errors or validation_warnings or duplicate_count > 0:
            detail_msg = f'æˆåŠŸå¯¼å…¥ {added_count} å¼ å‘ç¥¨ã€‚\n\n'
            
            if duplicate_count > 0:
                detail_msg += f'è·³è¿‡é‡å¤å‘ç¥¨ï¼š{duplicate_count} å¼ \n'
            
            if validation_errors:
                detail_msg += f'\nå‘ç° {len(validation_errors)} å¼ å‘ç¥¨æœ‰é”™è¯¯ï¼š\n'
                for item in validation_errors[:5]:  # æœ€å¤šæ˜¾ç¤º5ä¸ª
                    detail_msg += f"  â€¢ {item['invoice']}: {', '.join(item['errors'][:2])}\n"
                if len(validation_errors) > 5:
                    detail_msg += f"  ... è¿˜æœ‰ {len(validation_errors) - 5} å¼ å‘ç¥¨æœ‰é”™è¯¯\n"
            
            if validation_warnings:
                detail_msg += f'\nå‘ç° {len(validation_warnings)} å¼ å‘ç¥¨æœ‰è­¦å‘Šï¼ˆå¯å¿½ç•¥ï¼‰ï¼š\n'
                for item in validation_warnings[:3]:  # æœ€å¤šæ˜¾ç¤º3ä¸ª
                    detail_msg += f"  â€¢ {item['invoice']}: {', '.join(item['warnings'][:1])}\n"
                if len(validation_warnings) > 3:
                    detail_msg += f"  ... è¿˜æœ‰ {len(validation_warnings) - 3} å¼ å‘ç¥¨æœ‰è­¦å‘Š\n"
            
            detail_msg += '\næç¤ºï¼šå¯ä»¥åœ¨å‘ç¥¨è¯¦æƒ…ä¸­æŸ¥çœ‹å®Œæ•´çš„éªŒè¯ä¿¡æ¯ã€‚'
            
            QMessageBox.information(self, 'å¯¼å…¥å®Œæˆ', detail_msg)
        else:
            QMessageBox.information(self, 'å¯¼å…¥å®Œæˆ', f'æˆåŠŸå¯¼å…¥ {added_count} å¼ å‘ç¥¨ï¼Œæ‰€æœ‰å‘ç¥¨éªŒè¯é€šè¿‡ã€‚')

    def on_import_error(self, error_msg):
        """å¯¼å…¥é”™è¯¯"""
        QMessageBox.warning(self, 'å¯¼å…¥é”™è¯¯', error_msg)

    # ===== é¡¶éƒ¨å¯¼èˆªäº¤äº’ï¼ˆå½“å‰åªæ˜¯æ ·å¼å’Œé€‰ä¸­æ€ï¼Œåç»­å¯æ‰©å±•ä¸ºå¤šé¡µé¢ï¼‰ =====
    def on_top_nav_clicked(self, clicked_btn):
        """é¡¶éƒ¨å¯¼èˆªæŒ‰é’®ç‚¹å‡»æ—¶ï¼Œé«˜äº®å½“å‰é€‰é¡¹ï¼ˆé¢„ç•™å¤šé¡µé¢åˆ‡æ¢å…¥å£ï¼‰"""
        # ä¿è¯å¯¼èˆªæŒ‰é’®äº’æ–¥é€‰ä¸­
        for btn in [self.nav_btn_home, self.nav_btn_stats]:
            btn.setChecked(btn is clicked_btn)

        # æ ¹æ®å½“å‰é€‰ä¸­æŒ‰é’®åˆ‡æ¢å†…å®¹é¡µé¢
        if clicked_btn is self.nav_btn_home:
            self.content_stack.setCurrentWidget(self.page_home)
        elif clicked_btn is self.nav_btn_stats:
            # åˆ‡æ¢åˆ°ç»Ÿè®¡åˆ†æé¡µé¢å‰ï¼Œå…ˆåˆ·æ–°ç»Ÿè®¡æ•°æ®
            self.update_stats_view()
            self.content_stack.setCurrentWidget(self.page_stats)

    def update_stats_view(self):
        """åˆ·æ–°ç»Ÿè®¡åˆ†æé¡µé¢çš„æ•°æ®"""
        # æ›´æ–°AIæ•´ä½“åˆ†ææŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_analyze_all_btn'):
            self.ai_analyze_all_btn.setEnabled(bool(self.invoices))
        
        if not self.invoices:
            # æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡è¡¨æ ¼
            self.stats_summary_label.setText('å…± 0 å¼ å‘ç¥¨ï¼Œåˆè®¡é‡‘é¢ Â¥0.00')
            self.stats_detail_label.setText('')
            self.stats_seller_table.setRowCount(0)
            self.stats_category_table.setRowCount(0)
            self.stats_date_table.setRowCount(0)
            self.stats_tag_table.setRowCount(0)
            self.stats_validation_table.setRowCount(0)
            return
        
        total_count = len(self.invoices)
        total_amount = 0.0
        seller_stats = {}
        category_stats = {}
        date_stats = {}
        tag_stats = {}
        validation_stats = {'é€šè¿‡': {'count': 0, 'amount': 0.0}, 
                          'æœ‰é”™è¯¯': {'count': 0, 'amount': 0.0},
                          'æœ‰è­¦å‘Š': {'count': 0, 'amount': 0.0},
                          'æœªéªŒè¯': {'count': 0, 'amount': 0.0}}
        
        amounts = []
        date_stats_type = self.date_stats_type_combo.currentData() if hasattr(self, 'date_stats_type_combo') else 'month'

        for inv in self.invoices:
            amount = float(inv.get('total_amount', 0) or 0)
            total_amount += amount
            amounts.append(amount)
            
            # é”€å”®æ–¹ç»Ÿè®¡
            seller = inv.get('seller', 'æœªçŸ¥')
            if seller not in seller_stats:
                seller_stats[seller] = {'count': 0, 'amount': 0.0}
            seller_stats[seller]['count'] += 1
            seller_stats[seller]['amount'] += amount
            
            # åˆ†ç±»ç»Ÿè®¡
            items = inv.get('items', [])
            for item in items:
                category = item.get('category', 'å…¶ä»–')
                item_amount = float(item.get('amount', 0) or 0)
                if category not in category_stats:
                    category_stats[category] = {'count': 0, 'amount': 0.0}
                category_stats[category]['count'] += 1
                category_stats[category]['amount'] += item_amount
            
            # æ—¥æœŸç»Ÿè®¡
            date_str = inv.get('date', '')
            if date_str:
                try:
                    # è§£ææ—¥æœŸ
                    if 'å¹´' in date_str and 'æœˆ' in date_str:
                        # æ ¼å¼ï¼š2025å¹´12æœˆ02æ—¥
                        parts = date_str.replace('æ—¥', '').split('å¹´')
                        if len(parts) == 2:
                            year = parts[0]
                            month_day = parts[1].split('æœˆ')
                            if len(month_day) == 2:
                                month = month_day[0]
                                day = month_day[1]
                                
                                if date_stats_type == 'year':
                                    date_key = year + 'å¹´'
                                elif date_stats_type == 'month':
                                    date_key = f"{year}å¹´{month}æœˆ"
                                else:  # day
                                    date_key = date_str
                                
                                if date_key not in date_stats:
                                    date_stats[date_key] = {'count': 0, 'amount': 0.0}
                                date_stats[date_key]['count'] += 1
                                date_stats[date_key]['amount'] += amount
                except:
                    pass
            
            # æ ‡ç­¾ç»Ÿè®¡
            tags = inv.get('tags', [])
            if tags:
                for tag in tags:
                    if tag not in tag_stats:
                        tag_stats[tag] = {'count': 0, 'amount': 0.0}
                    tag_stats[tag]['count'] += 1
                    tag_stats[tag]['amount'] += amount
            
            # éªŒè¯çŠ¶æ€ç»Ÿè®¡
            validation = inv.get('validation')
            if validation:
                if not validation['is_valid']:
                    validation_stats['æœ‰é”™è¯¯']['count'] += 1
                    validation_stats['æœ‰é”™è¯¯']['amount'] += amount
                elif validation['warnings']:
                    validation_stats['æœ‰è­¦å‘Š']['count'] += 1
                    validation_stats['æœ‰è­¦å‘Š']['amount'] += amount
                else:
                    validation_stats['é€šè¿‡']['count'] += 1
                    validation_stats['é€šè¿‡']['amount'] += amount
            else:
                validation_stats['æœªéªŒè¯']['count'] += 1
                validation_stats['æœªéªŒè¯']['amount'] += amount

        # è®¡ç®—è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
        avg_amount = total_amount / total_count if total_count > 0 else 0
        max_amount = max(amounts) if amounts else 0
        min_amount = min(amounts) if amounts else 0
        
        # æ›´æ–°é¡¶éƒ¨æ±‡æ€»æ–‡å­—
        self.stats_summary_label.setText(
            f'å…± {total_count} å¼ å‘ç¥¨ï¼Œåˆè®¡é‡‘é¢ Â¥{total_amount:.2f}'
        )
        
        # æ›´æ–°è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯
        detail_text = f"""
å¹³å‡é‡‘é¢ï¼šÂ¥{avg_amount:.2f}  |  æœ€å¤§é‡‘é¢ï¼šÂ¥{max_amount:.2f}  |  æœ€å°é‡‘é¢ï¼šÂ¥{min_amount:.2f}
        """
        self.stats_detail_label.setText(detail_text.strip())

        # ========== æ›´æ–°æŒ‰é”€å”®æ–¹ç»Ÿè®¡è¡¨ ==========
        rows = len(seller_stats)
        self.stats_seller_table.setRowCount(rows)
        sorted_sellers = sorted(seller_stats.items(), key=lambda x: x[1]['amount'], reverse=True)
        for row, (seller, data) in enumerate(sorted_sellers):
            self.stats_seller_table.setItem(row, 0, QTableWidgetItem(seller))
            self.stats_seller_table.setItem(row, 1, QTableWidgetItem(str(data['count'])))
            self.stats_seller_table.setItem(row, 2, QTableWidgetItem(f"Â¥{data['amount']:.2f}"))
            percentage = (data['amount'] / total_amount * 100) if total_amount > 0 else 0
            self.stats_seller_table.setItem(row, 3, QTableWidgetItem(f"{percentage:.1f}%"))
        
        # æ›´æ–°é”€å”®æ–¹é¥¼å›¾
        if hasattr(self, 'seller_chart_canvas'):
            self.update_pie_chart(self.seller_chart_canvas, seller_stats, 'æŒ‰é”€å”®æ–¹é‡‘é¢åˆ†å¸ƒ', total_amount)

        # ========== æ›´æ–°æŒ‰åˆ†ç±»ç»Ÿè®¡è¡¨ ==========
        rows = len(category_stats)
        self.stats_category_table.setRowCount(rows)
        sorted_categories = sorted(category_stats.items(), key=lambda x: x[1]['amount'], reverse=True)
        for row, (category, data) in enumerate(sorted_categories):
            self.stats_category_table.setItem(row, 0, QTableWidgetItem(category))
            self.stats_category_table.setItem(row, 1, QTableWidgetItem(str(data['count'])))
            self.stats_category_table.setItem(row, 2, QTableWidgetItem(f"Â¥{data['amount']:.2f}"))
            percentage = (data['amount'] / total_amount * 100) if total_amount > 0 else 0
            self.stats_category_table.setItem(row, 3, QTableWidgetItem(f"{percentage:.1f}%"))
        
        # æ›´æ–°åˆ†ç±»é¥¼å›¾
        if hasattr(self, 'category_chart_canvas'):
            category_total = sum(data['amount'] for data in category_stats.values())
            self.update_pie_chart(self.category_chart_canvas, category_stats, 'æŒ‰å•†å“åˆ†ç±»é‡‘é¢åˆ†å¸ƒ', category_total)

        # ========== æ›´æ–°æŒ‰æ—¥æœŸç»Ÿè®¡è¡¨ ==========
        rows = len(date_stats)
        self.stats_date_table.setRowCount(rows)
        sorted_dates = sorted(date_stats.items(), key=lambda x: x[0], reverse=True)
        for row, (date_key, data) in enumerate(sorted_dates):
            self.stats_date_table.setItem(row, 0, QTableWidgetItem(date_key))
            self.stats_date_table.setItem(row, 1, QTableWidgetItem(str(data['count'])))
            self.stats_date_table.setItem(row, 2, QTableWidgetItem(f"Â¥{data['amount']:.2f}"))
            percentage = (data['amount'] / total_amount * 100) if total_amount > 0 else 0
            self.stats_date_table.setItem(row, 3, QTableWidgetItem(f"{percentage:.1f}%"))
        
        # æ›´æ–°æ—¥æœŸè¶‹åŠ¿æŸ±çŠ¶å›¾
        if hasattr(self, 'date_chart_canvas'):
            date_type_name = {'month': 'æœˆåº¦', 'year': 'å¹´åº¦', 'day': 'æ—¥æœŸ'}.get(date_stats_type, 'æ—¥æœŸ')
            self.update_bar_chart(self.date_chart_canvas, date_stats, f'{date_type_name}é‡‘é¢è¶‹åŠ¿', 'æ—¥æœŸ', 'é‡‘é¢ï¼ˆå…ƒï¼‰')

        # ========== æ›´æ–°æŒ‰æ ‡ç­¾ç»Ÿè®¡è¡¨ ==========
        rows = len(tag_stats)
        self.stats_tag_table.setRowCount(rows)
        sorted_tags = sorted(tag_stats.items(), key=lambda x: x[1]['amount'], reverse=True)
        for row, (tag, data) in enumerate(sorted_tags):
            self.stats_tag_table.setItem(row, 0, QTableWidgetItem(tag))
            self.stats_tag_table.setItem(row, 1, QTableWidgetItem(str(data['count'])))
            self.stats_tag_table.setItem(row, 2, QTableWidgetItem(f"Â¥{data['amount']:.2f}"))
            percentage = (data['amount'] / total_amount * 100) if total_amount > 0 else 0
            self.stats_tag_table.setItem(row, 3, QTableWidgetItem(f"{percentage:.1f}%"))

        # ========== æ›´æ–°éªŒè¯çŠ¶æ€ç»Ÿè®¡è¡¨ ==========
        rows = len([k for k, v in validation_stats.items() if v['count'] > 0])
        self.stats_validation_table.setRowCount(rows)
        row = 0
        for status, data in validation_stats.items():
            if data['count'] > 0:
                self.stats_validation_table.setItem(row, 0, QTableWidgetItem(status))
                self.stats_validation_table.setItem(row, 1, QTableWidgetItem(str(data['count'])))
                self.stats_validation_table.setItem(row, 2, QTableWidgetItem(f"Â¥{data['amount']:.2f}"))
                row += 1

    def update_invoice_list(self, search_text=None):
        """æ›´æ–°å‘ç¥¨åˆ—è¡¨"""
        self.invoice_list.clear()
        self.filtered_invoice_indices = []
        
        cfg = load_config()
        show_tags = cfg.get('list_show_tags', True)
        show_validation = cfg.get('list_show_validation', True)
        
        # å¦‚æœæ²¡æœ‰æœç´¢æ–‡æœ¬ï¼Œä½¿ç”¨ç©ºå­—ç¬¦ä¸²è¿›è¡ŒåŒ¹é…ï¼ˆæ˜¾ç¤ºæ‰€æœ‰ï¼‰
        if search_text is None:
            search_text = getattr(self, 'search_input', None)
            if search_text:
                search_text = search_text.text().strip().lower()
            else:
                search_text = ''
        
        # è¿‡æ»¤å‘ç¥¨
        filtered_invoices = []
        for idx, invoice in enumerate(self.invoices):
            if self._invoice_matches_search(invoice, search_text):
                filtered_invoices.append((idx, invoice))
        
        # æ˜¾ç¤ºè¿‡æ»¤åçš„å‘ç¥¨
        for original_idx, invoice in filtered_invoices:
            self.filtered_invoice_indices.append(original_idx)
            
            file_name = os.path.basename(invoice['file_path'])
            amount = invoice.get('total_amount', 0)
            seller = invoice.get('seller', 'æœªçŸ¥')
            
            # æ˜¾ç¤ºæ ‡ç­¾ä¿¡æ¯ï¼ˆæ ¹æ®é…ç½®ï¼‰
            tags = invoice.get('tags', [])
            tags_str = f" [{', '.join(tags)}]" if tags and show_tags else ""
            
            # æ˜¾ç¤ºéªŒè¯çŠ¶æ€æ ‡è®°ï¼ˆæ ¹æ®é…ç½®ï¼‰
            validation = invoice.get('validation')
            validation_mark = ''
            if show_validation and validation:
                if not validation['is_valid']:
                    validation_mark = ' âš ï¸'
                elif validation['warnings']:
                    validation_mark = ' âš¡'
            
            item_text = f"{file_name} - {seller} - Â¥{amount:.2f}{tags_str}{validation_mark}"
            
            # åˆ›å»ºåˆ—è¡¨é¡¹
            item = QListWidgetItem(item_text)
            
            # å¦‚æœæœ‰éªŒè¯é”™è¯¯ï¼Œä½¿ç”¨çº¢è‰²èƒŒæ™¯
            if validation and not validation['is_valid']:
                item.setBackground(QBrush(QColor(255, 240, 240)))  # æµ…çº¢è‰²èƒŒæ™¯
                item.setForeground(QBrush(QColor(200, 0, 0)))  # æ·±çº¢è‰²æ–‡å­—
            # å¦‚æœæœ‰æ ‡ç­¾ï¼Œè®¾ç½®ä¸åŒçš„é¢œè‰²
            elif tags:
                # æ ¹æ®æ ‡ç­¾è®¾ç½®é¢œè‰²ï¼ˆä¼˜å…ˆçº§ï¼šå·²æœ‰æ”¯ä»˜è®°å½• > å·²æŠ¥é”€ > å¾…å®¡æ ¸ > é‡è¦ > å…¶ä»–ï¼‰
                if 'å·²æœ‰æ”¯ä»˜è®°å½•' in tags:
                    item.setForeground(QBrush(QColor(34, 139, 34)))  # ç»¿è‰²
                elif 'å·²æŠ¥é”€' in tags:
                    item.setForeground(QBrush(QColor(30, 144, 255)))  # è“è‰²
                elif 'å¾…å®¡æ ¸' in tags:
                    item.setForeground(QBrush(QColor(255, 140, 0)))  # æ©™è‰²
                elif 'é‡è¦' in tags:
                    item.setForeground(QBrush(QColor(220, 20, 60)))  # çº¢è‰²
                else:
                    item.setForeground(QBrush(QColor(138, 43, 226)))  # ç´«è‰²
            
            # æ·»åŠ åˆ°åˆ—è¡¨
            self.invoice_list.addItem(item)

        # åŒæ—¶æ›´æ–°æ€»é‡‘é¢æ˜¾ç¤ºï¼ˆæ˜¾ç¤ºè¿‡æ»¤åçš„ç»Ÿè®¡ï¼‰
        self.update_total_label(filtered_invoices=[inv for _, inv in filtered_invoices])
        
        # æ›´æ–°æ¸…é™¤æœç´¢æŒ‰é’®çš„å¯è§æ€§
        if hasattr(self, 'clear_search_btn'):
            self.clear_search_btn.setVisible(bool(search_text))

    def update_total_label(self, filtered_invoices=None):
        """æ›´æ–°ç•Œé¢å³ä¸Šè§’çš„æ€»é‡‘é¢æ˜¾ç¤ºï¼ˆæ‰€æœ‰å‘ç¥¨ä»·ç¨åˆè®¡ä¹‹å’Œï¼‰"""
        if filtered_invoices is not None:
            # æ˜¾ç¤ºè¿‡æ»¤åçš„ç»Ÿè®¡
            total = 0.0
            for inv in filtered_invoices:
                total += float(inv.get('total_amount', 0) or 0)
            self.total_label.setText(f"æ€»é‡‘é¢ï¼šÂ¥{total:.2f}")
            if hasattr(self, 'count_label'):
                total_count = len(self.invoices)
                filtered_count = len(filtered_invoices)
                if filtered_count < total_count:
                    self.count_label.setText(f"å…± {filtered_count}/{total_count} å¼ å‘ç¥¨ï¼ˆå·²è¿‡æ»¤ï¼‰")
                else:
                    self.count_label.setText(f"å…± {total_count} å¼ å‘ç¥¨")
        else:
            # æ˜¾ç¤ºå…¨éƒ¨ç»Ÿè®¡
            total = 0.0
            for inv in self.invoices:
                total += float(inv.get('total_amount', 0) or 0)
            self.total_label.setText(f"æ€»é‡‘é¢ï¼šÂ¥{total:.2f}")
            if hasattr(self, 'count_label'):
                self.count_label.setText(f"å…± {len(self.invoices)} å¼ å‘ç¥¨")

    def show_invoice_details(self, item):
        """æ˜¾ç¤ºå‘ç¥¨è¯¦æƒ…"""
        list_index = self.invoice_list.row(item)
        # å¦‚æœè¿›è¡Œäº†æœç´¢è¿‡æ»¤ï¼Œéœ€è¦æ˜ å°„å›åŸå§‹ç´¢å¼•
        if hasattr(self, 'filtered_invoice_indices') and self.filtered_invoice_indices:
            if list_index < len(self.filtered_invoice_indices):
                original_index = self.filtered_invoice_indices[list_index]
                if original_index < len(self.invoices):
                    invoice = self.invoices[original_index]
                    self.display_invoice_details(invoice)
                    self.display_invoice_items(invoice)
        else:
            # æ²¡æœ‰è¿‡æ»¤ï¼Œç›´æ¥ä½¿ç”¨åˆ—è¡¨ç´¢å¼•
            if list_index < len(self.invoices):
                invoice = self.invoices[list_index]
                self.display_invoice_details(invoice)
                self.display_invoice_items(invoice)

    def _invoice_matches_search(self, invoice, search_text):
        """æ£€æŸ¥å‘ç¥¨æ˜¯å¦åŒ¹é…æœç´¢æ–‡æœ¬"""
        if not search_text:
            return True
        
        search_text = search_text.lower()
        
        # æœç´¢å‘ç¥¨å·
        invoice_number = (invoice.get('invoice_number') or '').lower()
        if search_text in invoice_number:
            return True
        
        # æœç´¢é”€å”®æ–¹
        seller = (invoice.get('seller') or '').lower()
        if search_text in seller:
            return True
        
        # æœç´¢è´­ä¹°æ–¹
        buyer = (invoice.get('buyer') or '').lower()
        if search_text in buyer:
            return True
        
        # æœç´¢æ–‡ä»¶å
        file_path = invoice.get('file_path', '')
        file_name = os.path.basename(file_path).lower()
        if search_text in file_name:
            return True
        
        # æœç´¢æ ‡ç­¾
        tags = invoice.get('tags', [])
        for tag in tags:
            if search_text in tag.lower():
                return True
        
        # æœç´¢å•†å“åç§°
        items = invoice.get('items', [])
        for item in items:
            item_name = (item.get('name') or '').lower()
            if search_text in item_name:
                return True
            # æœç´¢å•†å“åˆ†ç±»
            category = (item.get('category') or '').lower()
            if search_text in category:
                return True
        
        # æœç´¢é‡‘é¢ï¼ˆæ”¯æŒæ•°å­—æœç´¢ï¼‰
        try:
            search_amount = float(search_text)
            total_amount = float(invoice.get('total_amount', 0) or 0)
            if abs(total_amount - search_amount) < 0.01:  # å…è®¸å°çš„æµ®ç‚¹è¯¯å·®
                return True
        except ValueError:
            pass
        
        # æœç´¢æ—¥æœŸ
        date_str = (invoice.get('date') or '').lower()
        if search_text in date_str:
            return True
        
        return False
    
    def on_search_text_changed(self, text):
        """æœç´¢æ–‡æœ¬æ”¹å˜æ—¶çš„å¤„ç†"""
        search_text = text.strip().lower()
        self.update_invoice_list(search_text=search_text)
    
    def clear_search(self):
        """æ¸…é™¤æœç´¢"""
        if hasattr(self, 'search_input'):
            self.search_input.clear()
            self.update_invoice_list(search_text='')
    
    def resizeEvent(self, event):
        """çª—å£å°ºå¯¸å˜åŒ–æ—¶çš„å¤„ç†"""
        super().resizeEvent(event)

    def display_invoice_details(self, invoice):
        """æ˜¾ç¤ºå‘ç¥¨åŸºæœ¬ä¿¡æ¯"""
        file_path = invoice.get('file_path', '')
        file_exists = file_path and os.path.exists(file_path)
        file_status = 'âœ“ æ–‡ä»¶å­˜åœ¨' if file_exists else 'âœ— æ–‡ä»¶ä¸å­˜åœ¨'
        
        # è·å–æ ‡ç­¾ä¿¡æ¯
        tags = invoice.get('tags', [])
        tags_text = ', '.join(tags) if tags else 'æ— '
        
        # è·å–éªŒè¯çŠ¶æ€
        validation = invoice.get('validation')
        if validation:
            if validation['is_valid']:
                validation_status = 'âœ“ éªŒè¯é€šè¿‡'
                if validation['warnings']:
                    validation_status += f'ï¼ˆ{len(validation["warnings"])} ä¸ªè­¦å‘Šï¼‰'
            else:
                validation_status = f'âœ— éªŒè¯å¤±è´¥ï¼ˆ{len(validation["errors"])} ä¸ªé”™è¯¯'
                if validation['warnings']:
                    validation_status += f'ï¼Œ{len(validation["warnings"])} ä¸ªè­¦å‘Š'
                validation_status += 'ï¼‰'
        else:
            validation_status = 'æœªéªŒè¯'
        
        details = f"""
å‘ç¥¨å·ç : {invoice.get('invoice_number', 'æœªçŸ¥')}
å¼€ç¥¨æ—¥æœŸ: {invoice.get('date', 'æœªçŸ¥')}
é”€å”®æ–¹: {invoice.get('seller', 'æœªçŸ¥')}
è´­ä¹°æ–¹: {invoice.get('buyer', 'æœªçŸ¥')}
æ€»é‡‘é¢: Â¥{invoice.get('total_amount', 0):.2f}
æ ‡ç­¾: {tags_text}
éªŒè¯çŠ¶æ€: {validation_status}
æ–‡ä»¶è·¯å¾„: {file_path}
æ–‡ä»¶çŠ¶æ€: {file_status}
        """
        self.detail_text.setPlainText(details.strip())
        
        # æ›´æ–°æ–‡ä»¶ç®¡ç†æŒ‰é’®çŠ¶æ€
        has_file = bool(file_path)
        self.open_file_btn.setEnabled(has_file and file_exists)
        self.show_in_explorer_btn.setEnabled(has_file and file_exists)
        self.copy_path_btn.setEnabled(has_file)
        self.relink_file_btn.setEnabled(has_file)
        self.copy_file_btn.setEnabled(has_file and file_exists)
        
        # æ›´æ–°æ ‡ç­¾ç®¡ç†æŒ‰é’®çŠ¶æ€
        if hasattr(self, 'manage_tags_btn'):
            self.manage_tags_btn.setEnabled(True)
        
        # æ›´æ–°éªŒè¯æŒ‰é’®çŠ¶æ€
        if hasattr(self, 'validate_btn'):
            self.validate_btn.setEnabled(True)
        
        # æ›´æ–°AIæŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_analyze_btn'):
            self.ai_analyze_btn.setEnabled(True)
        if hasattr(self, 'ai_suggest_btn'):
            self.ai_suggest_btn.setEnabled(True)
        if hasattr(self, 'ai_review_btn'):
            self.ai_review_btn.setEnabled(True)

    def display_invoice_items(self, invoice):
        """æ˜¾ç¤ºå•†å“æ˜ç»†"""
        items = invoice.get('items', [])
        self.items_table.setRowCount(len(items))

        for row, item in enumerate(items):
            self.items_table.setItem(row, 0, QTableWidgetItem(item.get('category', '')))
            self.items_table.setItem(row, 1, QTableWidgetItem(item.get('name', '')))
            self.items_table.setItem(row, 2, QTableWidgetItem(str(item.get('quantity', 1))))
            self.items_table.setItem(row, 3, QTableWidgetItem(f"{item.get('price', 0):.2f}"))
            self.items_table.setItem(row, 4, QTableWidgetItem(f"{item.get('amount', 0):.2f}"))
            self.items_table.setItem(row, 5, QTableWidgetItem(item.get('spec', '')))

    def on_item_changed(self, row, column):
        """å•†å“ä¿¡æ¯æ”¹å˜"""
        if column == 0:  # åˆ†ç±»åˆ—
            item = self.items_table.item(row, column)
            if item:
                # æ›´æ–°å‘ç¥¨æ•°æ®
                current_invoice_index = self.invoice_list.currentRow()
                if current_invoice_index >= 0 and current_invoice_index < len(self.invoices):
                    invoice = self.invoices[current_invoice_index]
                    if 'items' in invoice and row < len(invoice['items']):
                        invoice['items'][row]['category'] = item.text()

    def edit_category(self):
        """ä¿®æ”¹åˆ†ç±»"""
        current_row = self.items_table.currentRow()
        if current_row >= 0:
            categories = ['è€—æ', 'è®¾å¤‡', 'å…¶ä»–']
            category, ok = QInputDialog.getItem(self, 'é€‰æ‹©åˆ†ç±»', 'åˆ†ç±»:', categories, 0, False)
            if ok:
                self.items_table.setItem(current_row, 0, QTableWidgetItem(category))

    def add_item(self):
        """æ·»åŠ å•†å“"""
        current_invoice_index = self.invoice_list.currentRow()
        if current_invoice_index >= 0:
            row_count = self.items_table.rowCount()
            self.items_table.insertRow(row_count)

            # é»˜è®¤å€¼
            self.items_table.setItem(row_count, 0, QTableWidgetItem('å…¶ä»–'))
            self.items_table.setItem(row_count, 1, QTableWidgetItem('æ–°å•†å“'))
            self.items_table.setItem(row_count, 2, QTableWidgetItem('1'))
            self.items_table.setItem(row_count, 3, QTableWidgetItem('0.00'))
            self.items_table.setItem(row_count, 4, QTableWidgetItem('0.00'))
            self.items_table.setItem(row_count, 5, QTableWidgetItem(''))

            # æ›´æ–°æ•°æ®
            invoice = self.invoices[current_invoice_index]
            if 'items' not in invoice:
                invoice['items'] = []
            invoice['items'].append({
                'category': 'å…¶ä»–',
                'name': 'æ–°å•†å“',
                'quantity': 1,
                'price': 0.0,
                'amount': 0.0,
                'spec': ''
            })

    def delete_item(self):
        """åˆ é™¤å•†å“"""
        current_row = self.items_table.currentRow()
        if current_row >= 0:
            self.items_table.removeRow(current_row)

            # æ›´æ–°æ•°æ®
            current_invoice_index = self.invoice_list.currentRow()
            if current_invoice_index >= 0:
                invoice = self.invoices[current_invoice_index]
                if 'items' in invoice and current_row < len(invoice['items']):
                    del invoice['items'][current_row]

    def export_bill(self):
        """å¯¼å‡ºè´¦å•"""
        if not self.invoices:
            QMessageBox.warning(self, 'è­¦å‘Š', 'æ²¡æœ‰å‘ç¥¨æ•°æ®å¯å¯¼å‡º')
            return

        # ä»é…ç½®è¯»å–é»˜è®¤å¯¼å‡ºè·¯å¾„
        cfg = load_config()
        default_path = cfg.get('export_path', '')
        if default_path and os.path.exists(default_path):
            default_file = os.path.join(default_path, 'è´¦å•.xlsx')
        else:
            default_file = 'è´¦å•.xlsx'
        
        file_path, _ = QFileDialog.getSaveFileName(
            self, 'ä¿å­˜è´¦å•', default_file, 'Excelæ–‡ä»¶ (*.xlsx);;æ‰€æœ‰æ–‡ä»¶ (*.*)'
        )

        if not file_path:
            return

        try:
            self.generate_bill_excel(file_path)
            QMessageBox.information(self, 'æˆåŠŸ', f'è´¦å•å·²ä¿å­˜åˆ°: {file_path}')
        except Exception as e:
            QMessageBox.critical(self, 'é”™è¯¯', f'å¯¼å‡ºå¤±è´¥: {str(e)}')

    def generate_bill_excel(self, file_path):
        """ç”Ÿæˆè´¦å•Excelæ–‡ä»¶"""
        bill_data = []
        # total_amount æŒ‰æ¯å¼ å‘ç¥¨çš„ã€Œä»·ç¨åˆè®¡ã€æ±‚å’Œï¼ˆå«ç¨ï¼‰ï¼Œ
        # è€Œä¸æ˜¯æŒ‰æ˜ç»†çš„æœªç¨é‡‘é¢ç´¯åŠ ï¼Œé¿å…æ¼ç®—ç¨é¢ã€‚
        total_amount = 0.0

        for invoice in self.invoices:
            # ç´¯åŠ æ¯å¼ å‘ç¥¨çš„ä»·ç¨åˆè®¡ï¼ˆå«ç¨ï¼‰
            total_amount += float(invoice.get('total_amount', 0) or 0)

            # é€è¡Œå±•å¼€å•†å“æ˜ç»†ï¼Œç”¨äºå¯¼å‡ºè´¦å•
            items = invoice.get('items', [])
            for item in items:
                bill_data.append({
                    'ä¸€çº§äº§å“åˆ†ç±»*': item.get('category', 'å…¶ä»–'),
                    'å•†å“åç§°*': item.get('name', ''),
                    'å•ä»·ï¼ˆå…ƒï¼‰*': item.get('price', 0),
                    'æ•°é‡*': item.get('quantity', 1),
                    'åŒ…è£…å•ä½': item.get('unit', 'ä¸ª'),
                    'å“ ç‰Œ': '',
                    'è´§å·': '',
                    'è§„æ ¼': item.get('spec', '')
                })

        # æ·»åŠ æ±‡æ€»è¡Œ
        if bill_data:
            bill_data.append({
                'ä¸€çº§äº§å“åˆ†ç±»*': '',
                'å•†å“åç§°*': 'åˆè®¡',
                'å•ä»·ï¼ˆå…ƒï¼‰*': '',
                'æ•°é‡*': '',
                'åŒ…è£…å•ä½': '',
                'å“ ç‰Œ': '',
                'è´§å·': '',
                'è§„æ ¼': f'æ€»é‡‘é¢: Â¥{total_amount:.2f}'
            })

            df = pd.DataFrame(bill_data)
            df.to_excel(file_path, index=False)

    def clear_data(self):
        """æ¸…ç©ºæ•°æ®"""
        # æ£€æŸ¥é…ç½®æ˜¯å¦éœ€è¦ç¡®è®¤
        cfg = load_config()
        if cfg.get('confirm_delete', True):
            reply = QMessageBox.question(self, 'ç¡®è®¤', 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ',
                                       QMessageBox.Yes | QMessageBox.No, QMessageBox.No)
            if reply != QMessageBox.Yes:
                return
        
        # æ‰§è¡Œæ¸…ç©º
        self.invoices.clear()
        # æ¸…ç©ºæœç´¢æ¡†
        if hasattr(self, 'search_input'):
            self.search_input.clear()
        self.invoice_list.clear()
        self.detail_text.clear()
        self.items_table.setRowCount(0)
        self.export_btn.setEnabled(False)
        self.total_label.setText('æ€»é‡‘é¢ï¼šÂ¥0.00')
        if hasattr(self, 'count_label'):
            self.count_label.setText('å…± 0 å¼ å‘ç¥¨')
        # æ¸…ç©ºç»Ÿè®¡è§†å›¾
        self.update_stats_view()
        self.status_bar.showMessage('æ•°æ®å·²æ¸…ç©º')

    # ================== å‘ç¥¨å»é‡ä¸è‡ªåŠ¨ä¿å­˜ / åŠ è½½åŠŸèƒ½ ==================
    def _is_duplicate_invoice(self, new_invoice):
        """
        åˆ¤æ–­ä¸€å¼ æ–°å‘ç¥¨æ˜¯å¦ä¸ç°æœ‰å‘ç¥¨é‡å¤ã€‚
        ä¼˜å…ˆä¾æ®ï¼šå‘ç¥¨å·ç  + å¼€ç¥¨æ—¥æœŸï¼›
        é€€è€Œæ±‚å…¶æ¬¡ï¼šæ–‡ä»¶è·¯å¾„å®Œå…¨ç›¸åŒã€‚
        """
        new_no = (new_invoice.get('invoice_number') or '').strip()
        new_date = (new_invoice.get('date') or '').strip()
        new_path = new_invoice.get('file_path')

        for inv in self.invoices:
            old_no = (inv.get('invoice_number') or '').strip()
            old_date = (inv.get('date') or '').strip()
            old_path = inv.get('file_path')

            # å‘ç¥¨å· + å¼€ç¥¨æ—¥æœŸéƒ½å­˜åœ¨ä¸”å®Œå…¨ç›¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯åŒä¸€å¼ å‘ç¥¨
            if new_no and old_no and new_date and old_date:
                if new_no == old_no and new_date == old_date:
                    return True

            # å¦åˆ™å¦‚æœæ–‡ä»¶è·¯å¾„å®Œå…¨ä¸€è‡´ï¼Œä¹Ÿè§†ä½œé‡å¤
            if new_path and old_path and new_path == old_path:
                return True

        return False

    def _get_autosave_path(self):
        """è·å–è‡ªåŠ¨ä¿å­˜æ–‡ä»¶çš„è·¯å¾„ï¼ˆç¨‹åºæ‰€åœ¨ç›®å½•ä¸‹çš„ JSON æ–‡ä»¶ï¼‰"""
        try:
            base_dir = os.path.dirname(os.path.abspath(sys.argv[0]))
        except Exception:
            base_dir = os.getcwd()
        return os.path.join(base_dir, 'invoices_autosave.json')

    def save_invoices(self):
        """å°†å½“å‰å‘ç¥¨æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ° JSON æ–‡ä»¶"""
        autosave_path = self._get_autosave_path()
        try:
            with open(autosave_path, 'w', encoding='utf-8') as f:
                # self.invoices ç»“æ„åªåŒ…å«åŸºæœ¬ç±»å‹ï¼ˆå­—ç¬¦ä¸²ã€æ•°å­—ã€åˆ—è¡¨ã€å­—å…¸ï¼‰ï¼Œå¯ç›´æ¥ JSON åºåˆ—åŒ–
                json.dump(self.invoices, f, ensure_ascii=False, indent=2)
        except Exception as e:
            # è‡ªåŠ¨ä¿å­˜å¤±è´¥ä¸æ‰“æ–­ç”¨æˆ·æ“ä½œï¼Œä»…åœ¨æ§åˆ¶å°è¾“å‡º
            print(f'è‡ªåŠ¨ä¿å­˜å‘ç¥¨æ•°æ®å¤±è´¥: {e}')

    def load_invoices(self):
        """å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ä¸Šä¸€æ¬¡ä¿å­˜çš„å‘ç¥¨æ•°æ®"""
        autosave_path = self._get_autosave_path()
        if not os.path.exists(autosave_path):
            return

        try:
            with open(autosave_path, 'r', encoding='utf-8') as f:
                data = json.load(f)

            if isinstance(data, list):
                self.invoices = data
                # ç¡®ä¿æ—§æ•°æ®ä¹Ÿæœ‰ tags å­—æ®µ
                for invoice in self.invoices:
                    if 'tags' not in invoice:
                        invoice['tags'] = []
                self.update_invoice_list()
                self.update_total_label()
                self.update_stats_view()
                self.export_btn.setEnabled(bool(self.invoices))
                if self.invoices:
                    self.status_bar.showMessage(f'å·²è‡ªåŠ¨åŠ è½½ä¸Šæ¬¡çš„ {len(self.invoices)} å¼ å‘ç¥¨æ•°æ®')
        except Exception as e:
            print(f'è‡ªåŠ¨åŠ è½½å‘ç¥¨æ•°æ®å¤±è´¥: {e}')

    def closeEvent(self, event):
        """çª—å£å…³é—­å‰è‡ªåŠ¨ä¿å­˜å½“å‰å‘ç¥¨æ•°æ®"""
        self.save_invoices()
        super().closeEvent(event)

    def show_help_info(self):
        """æ˜¾ç¤ºè¯´æ˜å¯¹è¯æ¡†ï¼ˆå…è´£å£°æ˜å’Œå¼€å‘è€…ä¿¡æ¯ï¼‰"""
        dialog = HelpDialog(self)
        dialog.exec_()

    def open_settings(self):
        """æ‰“å¼€è®¾ç½®å¯¹è¯æ¡†"""
        dialog = SettingsDialog(self)
        if dialog.exec_() == QDialog.Accepted:
            config = load_config()
            # è·å–æ—§é…ç½®ç”¨äºåˆ¤æ–­æ˜¯å¦æ”¹å˜äº† API key
            old_api_key = config.get('deepseek_api_key', '')
            # åˆå¹¶æ–°è®¾ç½®
            new_settings = dialog.get_settings()
            config.update(new_settings)
            new_api_key = new_settings.get('deepseek_api_key', '')
            
            if save_config(config):
                # å¦‚æœ API key æ”¹å˜äº†ï¼Œé‡æ–°åˆå§‹åŒ– AI å®¢æˆ·ç«¯
                if old_api_key != new_api_key:
                    self.init_ai_client()
                
                QMessageBox.information(
                    self,
                    'è®¾ç½®å·²ä¿å­˜',
                    'è®¾ç½®å·²ä¿å­˜ã€‚\n\nå¦‚æœä¿®æ”¹äº† API Keyï¼ŒAI åŠŸèƒ½å°†ç«‹å³ä½¿ç”¨æ–°çš„é…ç½®ã€‚'
                )
            else:
                QMessageBox.warning(self, 'ä¿å­˜å¤±è´¥', 'æ— æ³•ä¿å­˜é…ç½®æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™ã€‚')

    # ================== å‘ç¥¨æ–‡ä»¶ç®¡ç† ==================
    def get_current_invoice(self):
        """è·å–å½“å‰é€‰ä¸­çš„å‘ç¥¨"""
        index = self.invoice_list.currentRow()
        if index < 0 or index >= len(self.invoices):
            return None
        return self.invoices[index]

    def open_invoice_file(self):
        """ç”¨ç³»ç»Ÿé»˜è®¤ç¨‹åºæ‰“å¼€å‘ç¥¨PDFæ–‡ä»¶"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        file_path = invoice.get('file_path', '')
        if not file_path:
            QMessageBox.warning(self, 'é”™è¯¯', 'è¯¥å‘ç¥¨æ²¡æœ‰å…³è”æ–‡ä»¶è·¯å¾„')
            return
        
        if not os.path.exists(file_path):
            QMessageBox.warning(self, 'æ–‡ä»¶ä¸å­˜åœ¨', f'æ‰¾ä¸åˆ°æ–‡ä»¶ï¼š\n{file_path}\n\nè¯·ä½¿ç”¨"é‡æ–°å…³è”"åŠŸèƒ½æŒ‡å®šæ­£ç¡®çš„æ–‡ä»¶è·¯å¾„ã€‚')
            return
        
        try:
            # Windows ç³»ç»Ÿä½¿ç”¨ os.startfileï¼Œè·¨å¹³å°å¯ä»¥ä½¿ç”¨ subprocess
            if sys.platform == 'win32':
                os.startfile(file_path)
            else:
                import subprocess
                subprocess.run(['xdg-open', file_path] if sys.platform == 'linux' else ['open', file_path])
        except Exception as e:
            QMessageBox.critical(self, 'æ‰“å¼€å¤±è´¥', f'æ— æ³•æ‰“å¼€æ–‡ä»¶ï¼š\n{str(e)}')

    def show_file_in_explorer(self):
        """åœ¨èµ„æºç®¡ç†å™¨ä¸­æ˜¾ç¤ºæ–‡ä»¶"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        file_path = invoice.get('file_path', '')
        if not file_path:
            QMessageBox.warning(self, 'é”™è¯¯', 'è¯¥å‘ç¥¨æ²¡æœ‰å…³è”æ–‡ä»¶è·¯å¾„')
            return
        
        if not os.path.exists(file_path):
            QMessageBox.warning(self, 'æ–‡ä»¶ä¸å­˜åœ¨', f'æ‰¾ä¸åˆ°æ–‡ä»¶ï¼š\n{file_path}')
            return
        
        try:
            # Windows ç³»ç»Ÿ
            if sys.platform == 'win32':
                os.startfile(os.path.dirname(file_path))
            else:
                import subprocess
                folder = os.path.dirname(file_path)
                subprocess.run(['xdg-open', folder] if sys.platform == 'linux' else ['open', folder])
        except Exception as e:
            QMessageBox.critical(self, 'æ“ä½œå¤±è´¥', f'æ— æ³•æ‰“å¼€æ–‡ä»¶å¤¹ï¼š\n{str(e)}')

    def copy_file_path(self):
        """å¤åˆ¶æ–‡ä»¶è·¯å¾„åˆ°å‰ªè´´æ¿"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        file_path = invoice.get('file_path', '')
        if not file_path:
            QMessageBox.warning(self, 'é”™è¯¯', 'è¯¥å‘ç¥¨æ²¡æœ‰å…³è”æ–‡ä»¶è·¯å¾„')
            return
        
        try:
            from PyQt5.QtWidgets import QApplication
            clipboard = QApplication.clipboard()
            clipboard.setText(file_path)
            QMessageBox.information(self, 'å·²å¤åˆ¶', f'æ–‡ä»¶è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š\n{file_path}')
        except Exception as e:
            QMessageBox.critical(self, 'å¤åˆ¶å¤±è´¥', f'æ— æ³•å¤åˆ¶è·¯å¾„ï¼š\n{str(e)}')

    def relink_invoice_file(self):
        """é‡æ–°å…³è”å‘ç¥¨æ–‡ä»¶ï¼ˆå¦‚æœæ–‡ä»¶ç§»åŠ¨æˆ–é‡å‘½åäº†ï¼‰"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        old_path = invoice.get('file_path', '')
        
        # å¦‚æœæ—§è·¯å¾„å­˜åœ¨ï¼Œä»è¯¥ç›®å½•å¼€å§‹é€‰æ‹©
        start_dir = os.path.dirname(old_path) if old_path and os.path.exists(os.path.dirname(old_path)) else ''
        
        file_path, _ = QFileDialog.getOpenFileName(
            self,
            'é‡æ–°å…³è”å‘ç¥¨æ–‡ä»¶',
            start_dir,
            'PDFæ–‡ä»¶ (*.pdf);;æ‰€æœ‰æ–‡ä»¶ (*.*)'
        )
        
        if not file_path:
            return
        
        if not os.path.exists(file_path):
            QMessageBox.warning(self, 'é”™è¯¯', 'é€‰æ‹©çš„æ–‡ä»¶ä¸å­˜åœ¨')
            return
        
        # æ›´æ–°å‘ç¥¨çš„æ–‡ä»¶è·¯å¾„
        invoice['file_path'] = file_path
        
        # åˆ·æ–°æ˜¾ç¤º
        self.display_invoice_details(invoice)
        self.update_preview_for_invoice(invoice)
        self.update_invoice_list()
        
        # ä¿å­˜æ•°æ®
        self.save_invoices()
        
        QMessageBox.information(self, 'æˆåŠŸ', 'å‘ç¥¨æ–‡ä»¶å·²é‡æ–°å…³è”')

    def copy_invoice_file(self):
        """å¤åˆ¶å‘ç¥¨æ–‡ä»¶åˆ°æŒ‡å®šä½ç½®"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        file_path = invoice.get('file_path', '')
        if not file_path or not os.path.exists(file_path):
            QMessageBox.warning(self, 'æ–‡ä»¶ä¸å­˜åœ¨', 'æ‰¾ä¸åˆ°å‘ç¥¨æ–‡ä»¶ï¼Œæ— æ³•å¤åˆ¶')
            return
        
        # é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹
        target_dir = QFileDialog.getExistingDirectory(
            self,
            'é€‰æ‹©ç›®æ ‡æ–‡ä»¶å¤¹',
            os.path.dirname(file_path)
        )
        
        if not target_dir:
            return
        
        try:
            file_name = os.path.basename(file_path)
            target_path = os.path.join(target_dir, file_name)
            
            # å¦‚æœç›®æ ‡æ–‡ä»¶å·²å­˜åœ¨ï¼Œè¯¢é—®æ˜¯å¦è¦†ç›–
            if os.path.exists(target_path):
                reply = QMessageBox.question(
                    self,
                    'æ–‡ä»¶å·²å­˜åœ¨',
                    f'ç›®æ ‡ä½ç½®å·²å­˜åœ¨åŒåæ–‡ä»¶ï¼š\n{target_path}\n\næ˜¯å¦è¦†ç›–ï¼Ÿ',
                    QMessageBox.Yes | QMessageBox.No,
                    QMessageBox.No
                )
                if reply == QMessageBox.No:
                    return
            
            # å¤åˆ¶æ–‡ä»¶
            import shutil
            shutil.copy2(file_path, target_path)
            QMessageBox.information(self, 'æˆåŠŸ', f'æ–‡ä»¶å·²å¤åˆ¶åˆ°ï¼š\n{target_path}')
        except Exception as e:
            QMessageBox.critical(self, 'å¤åˆ¶å¤±è´¥', f'æ— æ³•å¤åˆ¶æ–‡ä»¶ï¼š\n{str(e)}')

    def manage_invoice_tags(self):
        """ç®¡ç†å‘ç¥¨æ ‡ç­¾"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        # è·å–å½“å‰æ ‡ç­¾
        current_tags = invoice.get('tags', [])
        
        # æ‰“å¼€æ ‡ç­¾ç®¡ç†å¯¹è¯æ¡†
        dialog = TagsDialog(self, current_tags)
        if dialog.exec_() == QDialog.Accepted:
            # æ›´æ–°å‘ç¥¨æ ‡ç­¾
            new_tags = dialog.get_tags()
            invoice['tags'] = new_tags
            
            # åˆ·æ–°æ˜¾ç¤º
            self.display_invoice_details(invoice)
            self.update_invoice_list()
            
            # ä¿å­˜æ•°æ®
            self.save_invoices()
            
            QMessageBox.information(self, 'æˆåŠŸ', 'æ ‡ç­¾å·²æ›´æ–°')

    def validate_current_invoice(self):
        """éªŒè¯å½“å‰é€‰ä¸­çš„å‘ç¥¨"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        # æ‰§è¡ŒéªŒè¯
        validation_result = self.parser.validate_invoice(invoice, self.invoices)
        invoice['validation'] = validation_result
        
        # åˆ·æ–°æ˜¾ç¤º
        self.display_invoice_details(invoice)
        self.update_invoice_list()
        self.save_invoices()
        
        # æ˜¾ç¤ºéªŒè¯ç»“æœå¯¹è¯æ¡†
        self.show_validation_result(invoice, validation_result)
    
    def show_validation_result(self, invoice, validation_result):
        """æ˜¾ç¤ºéªŒè¯ç»“æœå¯¹è¯æ¡†"""
        invoice_number = invoice.get('invoice_number', 'æœªçŸ¥')
        
        if validation_result['is_valid'] and not validation_result['warnings']:
            QMessageBox.information(
                self,
                'éªŒè¯é€šè¿‡',
                f'å‘ç¥¨ {invoice_number} éªŒè¯é€šè¿‡ï¼Œæ‰€æœ‰æ£€æŸ¥é¡¹å‡æ­£å¸¸ã€‚'
            )
        else:
            msg = f'å‘ç¥¨ {invoice_number} éªŒè¯ç»“æœï¼š\n\n'
            
            if not validation_result['is_valid']:
                msg += 'âŒ é”™è¯¯ï¼ˆå¿…é¡»ä¿®å¤ï¼‰ï¼š\n'
                for error in validation_result['errors']:
                    msg += f'  â€¢ {error}\n'
                msg += '\n'
            
            if validation_result['warnings']:
                msg += 'âš ï¸ è­¦å‘Šï¼ˆå»ºè®®æ£€æŸ¥ï¼‰ï¼š\n'
                for warning in validation_result['warnings']:
                    msg += f'  â€¢ {warning}\n'
            
            msg += f'\néªŒè¯æ—¶é—´ï¼š{validation_result.get("checked_at", "æœªçŸ¥")}'
            
            if validation_result['is_valid']:
                QMessageBox.warning(self, 'éªŒè¯å®Œæˆï¼ˆæœ‰è­¦å‘Šï¼‰', msg)
            else:
                QMessageBox.critical(self, 'éªŒè¯å¤±è´¥', msg)
    
    def ai_analyze_invoice(self):
        """ä½¿ç”¨AIåˆ†æå½“å‰å‘ç¥¨ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        # å¦‚æœå·²æœ‰çº¿ç¨‹åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
        if self.ai_worker and self.ai_worker.isRunning():
            self.ai_worker.terminate()
            self.ai_worker.wait()
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        if hasattr(self, 'ai_analyze_btn'):
            self.ai_analyze_btn.setEnabled(False)
        
        # æ˜¾ç¤ºåŠ è½½æç¤º
        self.status_bar.showMessage('AIæ­£åœ¨åˆ†æå‘ç¥¨ï¼Œè¯·ç¨å€™...')
        
        # åˆ›å»ºå·¥ä½œçº¿ç¨‹
        self.ai_worker = AIWorker(self.ai_client, 'analyze_invoice', invoice, self.invoices)
        self.ai_worker.finished.connect(lambda result: self._on_ai_analyze_finished(result))
        self.ai_worker.error.connect(lambda error: self._on_ai_error('AIåˆ†æ', error))
        self.ai_worker.start()
    
    def _on_ai_analyze_finished(self, result):
        """AIåˆ†æå®Œæˆå›è°ƒ"""
        # æ¢å¤æŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_analyze_btn'):
            self.ai_analyze_btn.setEnabled(True)
        
        # æ˜¾ç¤ºåˆ†æç»“æœå¯¹è¯æ¡†
        dialog = QDialog(self)
        dialog.setWindowTitle('AIåˆ†æç»“æœ')
        dialog.setModal(True)
        dialog.resize(600, 400)
        
        layout = QVBoxLayout(dialog)
        
        label = QLabel('AIåˆ†æç»“æœï¼š')
        label.setStyleSheet('font-weight: bold; font-size: 12pt;')
        layout.addWidget(label)
        
        text_edit = QTextEdit()
        text_edit.setReadOnly(True)
        text_edit.setPlainText(result)
        layout.addWidget(text_edit)
        
        btn_layout = QHBoxLayout()
        btn_layout.addStretch(1)
        close_btn = QPushButton('å…³é—­')
        close_btn.clicked.connect(dialog.accept)
        btn_layout.addWidget(close_btn)
        layout.addLayout(btn_layout)
        
        dialog.exec_()
        self.status_bar.showMessage('AIåˆ†æå®Œæˆ')
    
    def ai_suggest_invoice(self):
        """ä½¿ç”¨AIä¸ºå½“å‰å‘ç¥¨æä¾›å»ºè®®ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        # å¦‚æœå·²æœ‰çº¿ç¨‹åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
        if self.ai_worker and self.ai_worker.isRunning():
            self.ai_worker.terminate()
            self.ai_worker.wait()
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        if hasattr(self, 'ai_suggest_btn'):
            self.ai_suggest_btn.setEnabled(False)
        
        # æ˜¾ç¤ºåŠ è½½æç¤º
        self.status_bar.showMessage('AIæ­£åœ¨ç”Ÿæˆå»ºè®®ï¼Œè¯·ç¨å€™...')
        
        # åˆ›å»ºå·¥ä½œçº¿ç¨‹
        self.ai_worker = AIWorker(self.ai_client, 'suggest_tags_and_actions', invoice, self.invoices)
        self.ai_worker.finished.connect(lambda result: self._on_ai_suggest_finished(result))
        self.ai_worker.error.connect(lambda error: self._on_ai_error('AIå»ºè®®', error))
        self.ai_worker.start()
    
    def _on_ai_suggest_finished(self, result):
        """AIå»ºè®®å®Œæˆå›è°ƒ"""
        # æ¢å¤æŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_suggest_btn'):
            self.ai_suggest_btn.setEnabled(True)
        
        # æ˜¾ç¤ºå»ºè®®ç»“æœå¯¹è¯æ¡†
        dialog = QDialog(self)
        dialog.setWindowTitle('AIå»ºè®®')
        dialog.setModal(True)
        dialog.resize(600, 400)
        
        layout = QVBoxLayout(dialog)
        
        label = QLabel('AIå»ºè®®ï¼š')
        label.setStyleSheet('font-weight: bold; font-size: 12pt;')
        layout.addWidget(label)
        
        text_edit = QTextEdit()
        text_edit.setReadOnly(True)
        text_edit.setPlainText(result)
        layout.addWidget(text_edit)
        
        btn_layout = QHBoxLayout()
        btn_layout.addStretch(1)
        close_btn = QPushButton('å…³é—­')
        close_btn.clicked.connect(dialog.accept)
        btn_layout.addWidget(close_btn)
        layout.addLayout(btn_layout)
        
        dialog.exec_()
        self.status_bar.showMessage('AIå»ºè®®ç”Ÿæˆå®Œæˆ')
    
    def ai_review_invoice(self):
        """ä½¿ç”¨AIå®¡æ ¸å½“å‰å‘ç¥¨ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"""
        invoice = self.get_current_invoice()
        if not invoice:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€å¼ å‘ç¥¨')
            return
        
        # å¦‚æœå·²æœ‰çº¿ç¨‹åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
        if self.ai_worker and self.ai_worker.isRunning():
            self.ai_worker.terminate()
            self.ai_worker.wait()
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        if hasattr(self, 'ai_review_btn'):
            self.ai_review_btn.setEnabled(False)
        
        # æ˜¾ç¤ºåŠ è½½æç¤º
        self.status_bar.showMessage('AIæ­£åœ¨å®¡æ ¸å‘ç¥¨ï¼Œè¯·ç¨å€™...')
        
        # è·å–å·²æœ‰çš„éªŒè¯ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
        validation_result = invoice.get('validation')
        
        # åˆ›å»ºå·¥ä½œçº¿ç¨‹
        self.ai_worker = AIWorker(self.ai_client, 'review_invoice', invoice, validation_result)
        self.ai_worker.finished.connect(lambda result: self._on_ai_review_finished(result))
        self.ai_worker.error.connect(lambda error: self._on_ai_error('AIå®¡æ ¸', error))
        self.ai_worker.start()
    
    def _on_ai_review_finished(self, result):
        """AIå®¡æ ¸å®Œæˆå›è°ƒ"""
        # æ¢å¤æŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_review_btn'):
            self.ai_review_btn.setEnabled(True)
        
        # æ˜¾ç¤ºå®¡æ ¸ç»“æœå¯¹è¯æ¡†
        dialog = QDialog(self)
        dialog.setWindowTitle('AIå®¡æ ¸ç»“æœ')
        dialog.setModal(True)
        dialog.resize(600, 400)
        
        layout = QVBoxLayout(dialog)
        
        label = QLabel('AIå®¡æ ¸æ„è§ï¼š')
        label.setStyleSheet('font-weight: bold; font-size: 12pt;')
        layout.addWidget(label)
        
        text_edit = QTextEdit()
        text_edit.setReadOnly(True)
        text_edit.setPlainText(result)
        layout.addWidget(text_edit)
        
        btn_layout = QHBoxLayout()
        btn_layout.addStretch(1)
        close_btn = QPushButton('å…³é—­')
        close_btn.clicked.connect(dialog.accept)
        btn_layout.addWidget(close_btn)
        layout.addLayout(btn_layout)
        
        dialog.exec_()
        self.status_bar.showMessage('AIå®¡æ ¸å®Œæˆ')
    
    def ai_analyze_all_invoices(self):
        """ä½¿ç”¨AIåˆ†ææ‰€æœ‰å‘ç¥¨æ•°æ®ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼‰"""
        if not self.invoices:
            QMessageBox.warning(self, 'æç¤º', 'æ²¡æœ‰å‘ç¥¨æ•°æ®å¯ä¾›åˆ†æ')
            return
        
        # å¦‚æœå·²æœ‰çº¿ç¨‹åœ¨è¿è¡Œï¼Œå…ˆåœæ­¢
        if self.ai_worker and self.ai_worker.isRunning():
            self.ai_worker.terminate()
            self.ai_worker.wait()
        
        # ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
        if hasattr(self, 'ai_analyze_all_btn'):
            self.ai_analyze_all_btn.setEnabled(False)
        
        # æ˜¾ç¤ºåŠ è½½æç¤º
        self.status_bar.showMessage('AIæ­£åœ¨åˆ†ææ‰€æœ‰å‘ç¥¨æ•°æ®ï¼Œè¯·ç¨å€™...')
        
        # åˆ›å»ºå·¥ä½œçº¿ç¨‹
        self.ai_worker = AIWorker(self.ai_client, 'analyze_all_invoices', self.invoices)
        self.ai_worker.finished.connect(lambda result: self._on_ai_analyze_all_finished(result))
        self.ai_worker.error.connect(lambda error: self._on_ai_error('AIæ•´ä½“åˆ†æ', error))
        self.ai_worker.start()
    
    def _on_ai_analyze_all_finished(self, result):
        """AIæ•´ä½“åˆ†æå®Œæˆå›è°ƒ"""
        # æ¢å¤æŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_analyze_all_btn'):
            self.ai_analyze_all_btn.setEnabled(True)
        
        # æ˜¾ç¤ºåˆ†æç»“æœå¯¹è¯æ¡†
        dialog = QDialog(self)
        dialog.setWindowTitle('AIæ•´ä½“åˆ†ææŠ¥å‘Š')
        dialog.setModal(True)
        dialog.resize(700, 500)
        
        layout = QVBoxLayout(dialog)
        
        label = QLabel('AIæ•´ä½“åˆ†ææŠ¥å‘Šï¼š')
        label.setStyleSheet('font-weight: bold; font-size: 12pt;')
        layout.addWidget(label)
        
        text_edit = QTextEdit()
        text_edit.setReadOnly(True)
        text_edit.setPlainText(result)
        layout.addWidget(text_edit)
        
        btn_layout = QHBoxLayout()
        btn_layout.addStretch(1)
        close_btn = QPushButton('å…³é—­')
        close_btn.clicked.connect(dialog.accept)
        btn_layout.addWidget(close_btn)
        layout.addLayout(btn_layout)
        
        dialog.exec_()
        self.status_bar.showMessage('AIæ•´ä½“åˆ†æå®Œæˆ')
    
    def _on_ai_error(self, operation_name, error_msg):
        """AIæ“ä½œé”™è¯¯å›è°ƒ"""
        # æ¢å¤æ‰€æœ‰AIæŒ‰é’®çŠ¶æ€
        if hasattr(self, 'ai_analyze_btn'):
            self.ai_analyze_btn.setEnabled(True)
        if hasattr(self, 'ai_suggest_btn'):
            self.ai_suggest_btn.setEnabled(True)
        if hasattr(self, 'ai_review_btn'):
            self.ai_review_btn.setEnabled(True)
        if hasattr(self, 'ai_analyze_all_btn'):
            self.ai_analyze_all_btn.setEnabled(True)
        
        QMessageBox.critical(self, f'{operation_name}å¤±è´¥', f'{operation_name}è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š\n{error_msg}')
        self.status_bar.showMessage(f'{operation_name}å¤±è´¥')

    # ================== è´­ä¹°è®°å½• OCR åŒ¹é…ä¸é‡å‘½å ==================
    def match_purchase_records(self):
        """
        æ‰¹é‡ä»è´­ä¹°è®°å½•å›¾ç‰‡ä¸­ OCR è¯†åˆ«â€œå®ä»˜é‡‘é¢â€ï¼Œ
        ä¸å½“å‰å‘ç¥¨çš„æ€»é‡‘é¢è¿›è¡ŒåŒ¹é…ï¼Œå¹¶æŒ‰
        ã€Œå‘ç¥¨å·_é‡‘é¢_åŸæ–‡ä»¶åã€æ ¼å¼é‡å‘½åå›¾ç‰‡ã€‚
        """
        # ä»…åœ¨ç”¨æˆ·ç‚¹å‡»ã€ŒåŒ¹é…è´­ä¹°è®°å½•å¹¶é‡å‘½åã€æ—¶ï¼Œæ‰åˆå§‹åŒ–/æ£€æµ‹ Tesseract
        if not init_tesseract_or_warn(self):
            return
        if not self.invoices:
            QMessageBox.warning(self, 'æç¤º', 'è¯·å…ˆå¯¼å…¥å¹¶è§£æå‘ç¥¨ï¼Œå†è¿›è¡Œè´­ä¹°è®°å½•åŒ¹é…ã€‚')
            return

        folder = QFileDialog.getExistingDirectory(self, 'é€‰æ‹©è´­ä¹°è®°å½•å›¾ç‰‡æ‰€åœ¨æ–‡ä»¶å¤¹', '')
        if not folder:
            return

        image_exts = {'.jpg', '.jpeg', '.png', '.bmp', '.tif', '.tiff'}
        files = []
        for name in os.listdir(folder):
            ext = os.path.splitext(name)[1].lower()
            if ext in image_exts:
                files.append(os.path.join(folder, name))

        if not files:
            QMessageBox.information(self, 'æç¤º', 'æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„å›¾ç‰‡æ–‡ä»¶ï¼ˆjpg/pngç­‰ï¼‰ã€‚')
            return

        # ä½¿ç”¨åå°çº¿ç¨‹æ‰§è¡Œ OCR åŒ¹é…ï¼Œé¿å…é˜»å¡ç•Œé¢
        self.status_bar.showMessage('æ­£åœ¨åŒ¹é…è´­ä¹°è®°å½•ï¼Œè¯·ç¨å€™...')
        QApplication.setOverrideCursor(Qt.WaitCursor)
        self.progress_bar.setVisible(True)
        self.progress_bar.setValue(0)
        self.match_records_btn.setEnabled(False)

        self.match_worker = PurchaseRecordMatcher(folder, files, self.invoices)
        self.match_worker.progress.connect(self.update_progress)
        self.match_worker.finished.connect(self.on_match_finished)
        self.match_worker.error.connect(self.on_match_error)
        self.match_worker.start()

    def on_match_finished(self, result):
        """è´­ä¹°è®°å½•åŒ¹é…çº¿ç¨‹å®Œæˆ"""
        QApplication.restoreOverrideCursor()
        self.progress_bar.setVisible(False)
        self.match_records_btn.setEnabled(True)

        total = result.get("total", 0)
        matched_count = result.get("matched", 0)
        unmatched_files = result.get("unmatched_files", []) or []
        error_files = result.get("error_files", []) or []

        msg_lines = [
            f"å…±æ‰«æè´­ä¹°è®°å½•å›¾ç‰‡ï¼š{total} ä¸ª",
            f"æˆåŠŸåŒ¹é…å¹¶é‡å‘½åï¼š{matched_count} ä¸ª",
        ]
        if unmatched_files:
            msg_lines.append(f"æœªæ‰¾åˆ°åŒ¹é…å‘ç¥¨ï¼š{len(unmatched_files)} ä¸ª")
        if error_files:
            msg_lines.append(f"OCRæˆ–é‡å‘½åå‡ºé”™ï¼š{len(error_files)} ä¸ª")

        detail_text = ""
        if unmatched_files:
            detail_text += "æœªåŒ¹é…æ–‡ä»¶ç¤ºä¾‹ï¼š\n" + "\n".join(unmatched_files[:10])
            if len(unmatched_files) > 10:
                detail_text += f"\nâ€¦â€¦ ç­‰ {len(unmatched_files)} ä¸ª\n"
        if error_files:
            if detail_text:
                detail_text += "\n"
            detail_text += "å‡ºé”™æ–‡ä»¶ç¤ºä¾‹ï¼š\n" + "\n".join(error_files[:10])
            if len(error_files) > 10:
                detail_text += f"\nâ€¦â€¦ ç­‰ {len(error_files)} ä¸ª\n"

        self.status_bar.showMessage('è´­ä¹°è®°å½•åŒ¹é…å®Œæˆã€‚')

        QMessageBox.information(
            self,
            'åŒ¹é…å®Œæˆ',
            "\n".join(msg_lines) + ("\n\n" + detail_text if detail_text else "")
        )

    def on_match_error(self, error_msg):
        """è´­ä¹°è®°å½•åŒ¹é…è¿‡ç¨‹ä¸­å‡ºé”™"""
        QApplication.restoreOverrideCursor()
        self.progress_bar.setVisible(False)
        self.match_records_btn.setEnabled(True)
        self.status_bar.showMessage('è´­ä¹°è®°å½•åŒ¹é…å‡ºé”™ã€‚')
        QMessageBox.warning(self, 'åŒ¹é…é”™è¯¯', error_msg)


    def _extract_paid_amount_from_image(self, img_path):
        """
        ä½¿ç”¨ OCR ä»è´­ä¹°è®°å½•å›¾ç‰‡ä¸­æå–â€œå®ä»˜é‡‘é¢â€ã€‚
        ä¼˜å…ˆåŒ¹é…åŒ…å«â€œå®ä»˜/å®æ”¶/å®ä»˜é‡‘é¢/æ”¯ä»˜é‡‘é¢â€ç­‰å…³é”®è¯çš„è¡Œä¸Šçš„é‡‘é¢ï¼›
        è‹¥æœªæ‰¾åˆ°ï¼Œå†ä»æ•´æ®µæ–‡æœ¬ä¸­å–æœ€å¤§é‡‘é¢ä½œä¸ºå€™é€‰ã€‚
        """
        try:
            image = Image.open(img_path)
        except Exception as e:
            print(f"OCR æ‰“å¼€å›¾ç‰‡å¤±è´¥ {img_path}: {e}")
            return None

        try:
            text = ocr_image_to_string(image)
        except Exception as e:
            print(f"OCR è¯†åˆ«å¤±è´¥ {img_path}: {e}")
            return None

        if not text:
            return None

        lines = text.splitlines()
        amount_pattern = re.compile(r'([0-9]+(?:\.[0-9]{1,2})?)')

        # 1. ä¼˜å…ˆåœ¨å«â€œå®ä»˜/å®æ”¶/å®ä»˜é‡‘é¢/æ”¯ä»˜é‡‘é¢â€ç­‰å…³é”®è¯çš„è¡Œé‡Œæ‰¾é‡‘é¢
        keywords = ['å®ä»˜', 'å®æ”¶', 'å®ä»˜é‡‘é¢', 'æ”¯ä»˜é‡‘é¢', 'åº”ä»˜é‡‘é¢', 'åˆè®¡', 'æ€»è®¡']
        candidate_amounts = []

        for line in lines:
            if any(k in line for k in keywords):
                for m in amount_pattern.finditer(line.replace(',', '')):
                    try:
                        val = float(m.group(1))
                        candidate_amounts.append(val)
                    except ValueError:
                        continue

        if candidate_amounts:
            # å–è¯¥è¡Œä¸­æœ€å¤§çš„ä¸€ä¸ªé‡‘é¢ä½œä¸ºã€Œå®ä»˜é‡‘é¢ã€å€™é€‰
            return max(candidate_amounts)

        # 2. å¦‚æœå…³é”®è¯è¡Œæ‰¾ä¸åˆ°ï¼Œå†ä»æ•´æ®µæ–‡æœ¬ä¸­å–æœ€å¤§çš„é‡‘é¢
        all_amounts = []
        for line in lines:
            for m in amount_pattern.finditer(line.replace(',', '')):
                try:
                    val = float(m.group(1))
                    all_amounts.append(val)
                except ValueError:
                    continue

        if all_amounts:
            return max(all_amounts)

        return None

    def _find_invoice_by_amount(self, amount, tol=0.01):
        """
        æ ¹æ®å®ä»˜é‡‘é¢åœ¨å½“å‰å‘ç¥¨åˆ—è¡¨ä¸­æŸ¥æ‰¾åŒ¹é…å‘ç¥¨ã€‚
        è‹¥å­˜åœ¨å¤šå¼ é‡‘é¢ç›¸åŒçš„å‘ç¥¨ï¼Œè¿™é‡Œç®€å•è¿”å›ç¬¬ä¸€å¼ ï¼Œé¿å…è‡ªåŠ¨åšå‡ºå«ç³ŠåŒ¹é…ã€‚
        """
        if amount is None:
            return None

        # ä»é…ç½®ä¸­è¯»å–åŒ¹é…é‡‘é¢å®¹å·®è®¾ç½®
        cfg = load_config()
        tol = float(cfg.get('match_tolerance', tol) or tol)

        for inv in self.invoices:
            try:
                total = float(inv.get('total_amount', 0) or 0)
            except Exception:
                continue

            if abs(total - amount) <= tol:
                return inv

        return None


def main():
    # ä¿®å¤Qtå¹³å°æ’ä»¶è·¯å¾„é—®é¢˜ï¼ˆå¿…é¡»åœ¨åˆ›å»ºQApplicationä¹‹å‰è®¾ç½®ï¼‰
    if getattr(sys, 'frozen', False):
        # å¦‚æœæ˜¯æ‰“åŒ…åçš„exe
        base_path = sys._MEIPASS
    else:
        # å¦‚æœæ˜¯å¼€å‘ç¯å¢ƒ
        base_path = os.path.dirname(os.path.abspath(__file__))
    
    # è®¾ç½®Qtæ’ä»¶è·¯å¾„ï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡å’ŒQCoreApplicationä¸¤ç§æ–¹æ³•ç¡®ä¿å…¼å®¹æ€§ï¼‰
    plugin_path = os.path.join(base_path, 'PyQt5', 'Qt5', 'plugins')
    if os.path.exists(plugin_path):
        os.environ['QT_PLUGIN_PATH'] = plugin_path
        # ä½¿ç”¨QCoreApplicationçš„æ–¹æ³•ï¼ˆéœ€è¦åœ¨åˆ›å»ºQApplicationä¹‹å‰ï¼‰
        QCoreApplication.setLibraryPaths([plugin_path])
    
    # pdfiumè·¯å¾„å·²åœ¨æ–‡ä»¶å¼€å¤´è®¾ç½®ï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤è®¾ç½®
    
    app = QApplication(sys.argv)
    app.setStyle('Fusion')

    # å…¨å±€ç°ä»£åŒ–æ ·å¼ï¼ˆæµ…è‰²ä¸»é¢˜ï¼Œå‚è€ƒä¸»æµå‰ç«¯è®¾è®¡è¯­è¨€ï¼šAnt Design / Materialï¼‰
    app.setStyleSheet("""
        /* å…¨å±€åŸºç¡€å­—ä½“ä¸èƒŒæ™¯ */
        QWidget {
            font-family: 'Microsoft YaHei', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 10pt;
            color: #1f2933;
        }

        QMainWindow {
            background-color: #f3f4f6;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ ï¼ˆä»¿ Web é¡¶éƒ¨èœå•æ ï¼‰ */
        QWidget#topNav {
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        QPushButton#topNavButton {
            background-color: transparent;
            border: none;
            padding: 6px 14px;
            color: #6b7280;
            font-weight: 500;
        }

        QPushButton#topNavButton:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        QPushButton#topNavButton:checked {
            color: #2563eb;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 4px; /* è¾¹æ¡†å ç”¨ 2pxï¼Œæ•´ä½“é«˜åº¦ä¿æŒä¸€è‡´ */
        }

        /* é¡¶éƒ¨å³ä¾§å¼€å‘è€…ä¿¡æ¯ */
        QLabel#devInfo {
            color: #9ca3af;
            font-size: 9pt;
        }

        /* é¡¶éƒ¨æ ‡é¢˜ä¸æ±‡æ€»åŒºåŸŸ */
        QLabel#appTitle {
            font-size: 15pt;
            font-weight: 700;
            color: #111827;
        }

        QLabel#summaryLabel {
            color: #6b7280;
        }

        /* åˆ†ç»„æ¡†ï¼ˆå¡ç‰‡å¼å®¹å™¨ï¼‰ */
        QGroupBox {
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-top: 10px;
            background-color: #ffffff;
        }

        QGroupBox::title {
            subcontrol-origin: margin;
            left: 10px;
            padding: 0 6px;
            color: #4b5563;
            font-weight: 600;
        }

        /* æŒ‰é’®ï¼šä¸»æµå‰ç«¯æ‰å¹³åŒ–+æ‚¬æµ®æ•ˆæœ */
        QPushButton {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 14px;
            color: #374151;
        }

        QPushButton:hover {
            background-color: #eff6ff;
            border-color: #3b82f6;
            color: #1d4ed8;
        }

        QPushButton:pressed {
            background-color: #dbeafe;
            border-color: #2563eb;
        }

        QPushButton:disabled {
            background-color: #f3f4f6;
            color: #9ca3af;
            border-color: #e5e7eb;
        }

        /* ä¸»æŒ‰é’®ï¼ˆprimaryï¼‰ */
        QPushButton[btnType="primary"] {
            background-color: #ffffff;
            border-color: #2563eb;
            color: #000000;
            font-weight: 600;
        }

        QPushButton[btnType="primary"]:hover {
            background-color: #eff6ff;
            border-color: #1d4ed8;
            color: #000000;
        }

        QPushButton[btnType="primary"]:pressed {
            background-color: #dbeafe;
            border-color: #1e40af;
            color: #000000;
        }

        QPushButton[btnType="primary"]:disabled {
            background-color: #f3f4f6;
            border-color: #93c5fd;
            color: #9ca3af;
        }

        /* å±é™©æŒ‰é’®ï¼ˆdangerï¼‰ */
        QPushButton[btnType="danger"] {
            background-color: #fee2e2;
            border-color: #fca5a5;
            color: #b91c1c;
        }

        QPushButton[btnType="danger"]:hover {
            background-color: #fecaca;
            border-color: #f87171;
            color: #991b1b;
        }

        QPushButton[btnType="danger"]:pressed {
            background-color: #fca5a5;
            border-color: #ef4444;
        }

        /* å¹½çµæŒ‰é’®ï¼ˆghostï¼‰ï¼šæ— èƒŒæ™¯ï¼Œä»…è¾¹æ¡† + æ–‡æœ¬è‰²å˜åŒ–ï¼Œé€‚åˆæ¬¡è¦æ“ä½œ */
        QPushButton[btnType="ghost"] {
            background-color: transparent;
            border-color: #d1d5db;
            color: #4b5563;
        }

        QPushButton[btnType="ghost"]:hover {
            background-color: #f3f4f6;
            border-color: #9ca3af;
            color: #111827;
        }

        /* å·¦ä¾§å‘ç¥¨åˆ—è¡¨ï¼šç±»ä¼¼é‚®ä»¶åˆ—è¡¨çš„é€‰ä¸­/æ‚¬åœé«˜äº® */
        QListWidget {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            outline: none;
        }

        QListWidget::item {
            padding: 4px 4px;
        }

        QListWidget::item:hover {
            background-color: #f3f4ff;
        }

        QListWidget::item:selected {
            background-color: #2563eb;
            color: #ffffff;
        }

        /* æ–‡æœ¬ç¼–è¾‘åŒºåŸŸï¼ˆè¯¦æƒ…ï¼‰ */
        QTextEdit {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
        }

        /* è¾“å…¥æ¡†ä¸ä¸‹æ‹‰æ¡†ï¼šç»Ÿä¸€çš„è¾¹æ¡†ä¸èšç„¦é«˜äº®æ•ˆæœ */
        QLineEdit, QComboBox {
            background-color: #ffffff;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 6px;
        }

        QLineEdit:focus, QComboBox:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
        }

        QComboBox::drop-down {
            border: none;
            width: 20px;
        }

        QComboBox::down-arrow {
            image: none;
            border-left: 1px solid #e5e7eb;
            width: 10px;
        }

        /* è¡¨æ ¼ï¼šæµ…è‰²æ¡çº¹ + ç»†è¾¹æ¡† + å›ºå®šè¡¨å¤´ */
        QTableWidget {
            background-color: #ffffff;
            alternate-background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            gridline-color: #e5e7eb;
        }

        QHeaderView::section {
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            padding: 6px 4px;
            font-weight: 600;
            color: #4b5563;
        }

        QTableWidget::item:selected {
            background-color: #2563eb;
            color: #ffffff;
        }

        QTableWidget::item:hover {
            background-color: #e5effe;
        }

        /* QScrollArea ä¸­çš„ç™½è‰²èƒŒæ™¯ï¼Œé¿å…ç°å— */
        QScrollArea {
            border: none;
            background-color: transparent;
        }

        QScrollArea > QWidget > QWidget {
            background-color: transparent;
        }

        /* æ»šåŠ¨æ¡ï¼šç»†çª„ã€åœ†è§’ï¼Œç±»ä¼¼ç½‘é¡µ UI */
        QScrollBar:vertical {
            background: transparent;
            width: 8px;
            margin: 0px;
        }

        QScrollBar::handle:vertical {
            background: #d1d5db;
            min-height: 24px;
            border-radius: 4px;
        }

        QScrollBar::handle:vertical:hover {
            background: #9ca3af;
        }

        QScrollBar::add-line:vertical,
        QScrollBar::sub-line:vertical {
            height: 0px;
        }

        QScrollBar:horizontal {
            background: transparent;
            height: 8px;
            margin: 0px;
        }

        QScrollBar::handle:horizontal {
            background: #d1d5db;
            min-width: 24px;
            border-radius: 4px;
        }

        QScrollBar::handle:horizontal:hover {
            background: #9ca3af;
        }

        QScrollBar::add-line:horizontal,
        QScrollBar::sub-line:horizontal {
            width: 0px;
        }

        /* çŠ¶æ€æ  */
        QStatusBar {
            background-color: #f3f4f6;
            border-top: 1px solid #e5e7eb;
        }

        /* è¿›åº¦æ¡æ ·å¼ï¼šè½»é‡çš„è“è‰²è¿›åº¦æ¡ */
        QProgressBar {
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            background-color: #f9fafb;
            text-align: center;
            height: 10px;
        }

        QProgressBar::chunk {
            background-color: #2563eb;
            border-radius: 4px;
        }

        /* Tooltipï¼šæµ…è‰²å°æ°”æ³¡ */
        QToolTip {
            background-color: #111827;
            color: #f9fafb;
            border: 0px;
            padding: 4px 8px;
            border-radius: 4px;
        }
    """)

    # è®¾ç½®åº”ç”¨ç¨‹åºä¿¡æ¯
    app.setApplicationName('å‘ç¥¨è‡ªåŠ¨ç®¡ç†åˆ†ç±»ç³»ç»Ÿ')
    app.setApplicationVersion('1.0')
    app.setOrganizationName('InvoiceManager')

    window = InvoiceManager()
    window.show()

    sys.exit(app.exec_())


if __name__ == '__main__':
    main()
